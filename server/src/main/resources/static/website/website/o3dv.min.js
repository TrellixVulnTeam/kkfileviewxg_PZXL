OV={IsDefined:function(a){return void 0!==a&&null!==a},ValueOrDefault:function(a,b){return void 0===a||null===a?b:a},CopyObjectAttributes:function(a,b){if(OV.IsDefined(a))for(let c of Object.keys(a))OV.IsDefined(a[c])&&(b[c]=a[c])}};OV.TaskRunner=class{constructor(){this.callbacks=this.current=this.count=null}Run(a,b){this.count=a;this.current=0;this.callbacks=b;0===a?this.TaskReady():this.RunOnce()}RunBatch(a,b,c){let d=0;0<a&&(d=parseInt((a-1)/b,10)+1);this.Run(d,{runTask:(e,f)=>{c.runTask(e*b,Math.min((e+1)*b,a)-1,f)},onReady:c.onReady})}RunOnce(){setTimeout(()=>{this.callbacks.runTask(this.current,this.TaskReady.bind(this))},0)}TaskReady(){this.current+=1;if(this.current<this.count)this.RunOnce();else if(this.callbacks.onReady)this.callbacks.onReady()}};
OV.RunTaskAsync=function(a){setTimeout(()=>{a()},0)};OV.RunTasks=function(a,b){(new OV.TaskRunner).Run(a,b)};OV.RunTasksBatch=function(a,b,c){(new OV.TaskRunner).RunBatch(a,b,c)};OV.WaitWhile=function(a){function b(c){c()&&setTimeout(()=>{b(c)},1)}b(a)};OV.Eps=1E-8;OV.BigEps=1E-4;OV.RadDeg=57.29577951308232;OV.DegRad=.017453292519943;OV.IsZero=function(a){return Math.abs(a)<OV.Eps};OV.IsLower=function(a,b){return b-a>OV.Eps};OV.IsGreater=function(a,b){return a-b>OV.Eps};OV.IsLowerOrEqual=function(a,b){return b-a>-OV.Eps};OV.IsGreaterOrEqual=function(a,b){return a-b>-OV.Eps};OV.IsEqual=function(a,b){return Math.abs(b-a)<OV.Eps};OV.IsEqualEps=function(a,b,c){return Math.abs(b-a)<c};OV.IsPositive=function(a){return a>OV.Eps};
OV.IsNegative=function(a){return a<-OV.Eps};OV.Direction={X:1,Y:2,Z:3};OV.Coord2D=class{constructor(a,b){this.x=a;this.y=b}Clone(){return new OV.Coord2D(this.x,this.y)}};OV.CoordIsEqual2D=function(a,b){return OV.IsEqual(a.x,b.x)&&OV.IsEqual(a.y,b.y)};OV.AddCoord2D=function(a,b){return new OV.Coord2D(a.x+b.x,a.y+b.y)};OV.SubCoord2D=function(a,b){return new OV.Coord2D(a.x-b.x,a.y-b.y)};OV.CoordDistance2D=function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))};OV.Coord3D=class{constructor(a,b,c){this.x=a;this.y=b;this.z=c}Length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}MultiplyScalar(a){this.x*=a;this.y*=a;this.z*=a;return this}Normalize(){let a=this.Length();0<a&&this.MultiplyScalar(1/a);return this}Offset(a,b){a=a.Clone().Normalize();this.x+=a.x*b;this.y+=a.y*b;this.z+=a.z*b;return this}Rotate(a,b,c){var d=a.Clone().Normalize();a=d.x;let e=d.y;d=d.z;let f=this.x-c.x,g=this.y-c.y,h=this.z-c.z,k=Math.sin(b);b=Math.cos(b);this.x=-a*
(-a*f-e*g-d*h)*(1-b)+f*b+(-d*g+e*h)*k;this.y=-e*(-a*f-e*g-d*h)*(1-b)+g*b+(d*f-a*h)*k;this.z=-d*(-a*f-e*g-d*h)*(1-b)+h*b+(-e*f+a*g)*k;this.x+=c.x;this.y+=c.y;this.z+=c.z;return this}Clone(){return new OV.Coord3D(this.x,this.y,this.z)}};OV.CoordIsEqual3D=function(a,b){return OV.IsEqual(a.x,b.x)&&OV.IsEqual(a.y,b.y)&&OV.IsEqual(a.z,b.z)};OV.AddCoord3D=function(a,b){return new OV.Coord3D(a.x+b.x,a.y+b.y,a.z+b.z)};OV.SubCoord3D=function(a,b){return new OV.Coord3D(a.x-b.x,a.y-b.y,a.z-b.z)};
OV.CoordDistance3D=function(a,b){return Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y)+(a.z-b.z)*(a.z-b.z))};OV.VectorAngle3D=function(a,b){a=a.Clone().Normalize();b=b.Clone().Normalize();if(OV.CoordIsEqual3D(a,b))return 0;b=OV.DotVector3D(a,b);return Math.acos(b)};OV.DotVector3D=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};OV.CrossVector3D=function(a,b){let c=new OV.Coord3D(0,0,0);c.x=a.y*b.z-a.z*b.y;c.y=a.z*b.x-a.x*b.z;c.z=a.x*b.y-a.y*b.x;return c};
OV.VectorLength3D=function(a,b,c){return Math.sqrt(a*a+b*b+c*c)};OV.ArrayToCoord3D=function(a){return new OV.Coord3D(a[0],a[1],a[2])};OV.Coord4D=class{constructor(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d}Clone(){return new OV.Coord4D(this.x,this.y,this.z,this.w)}};OV.Quaternion=class{constructor(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d}};OV.ArrayToQuaternion=function(a){return new OV.Quaternion(a[0],a[1],a[2],a[3])};OV.QuaternionFromAxisAngle=function(a,b){b/=2;const c=Math.sin(b);return new OV.Quaternion(a.x*c,a.y*c,a.z*c,Math.cos(b))};OV.Box3D=class{constructor(a,b){this.min=a;this.max=b}GetMin(){return this.min}GetMax(){return this.max}GetCenter(){return new OV.Coord3D((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,(this.min.z+this.max.z)/2)}};
OV.BoundingBoxCalculator3D=class{constructor(){this.box=new OV.Box3D(new OV.Coord3D(Infinity,Infinity,Infinity),new OV.Coord3D(-Infinity,-Infinity,-Infinity));this.isValid=!1}GetBox(){return this.isValid?this.box:null}AddPoint(a){this.box.min.x=Math.min(this.box.min.x,a.x);this.box.min.y=Math.min(this.box.min.y,a.y);this.box.min.z=Math.min(this.box.min.z,a.z);this.box.max.x=Math.max(this.box.max.x,a.x);this.box.max.y=Math.max(this.box.max.y,a.y);this.box.max.z=Math.max(this.box.max.z,a.z);this.isValid=
!0}};OV.OctreeNode=class{constructor(a,b){this.boundingBox=a;this.level=b;this.pointItems=[];this.childNodes=[]}AddPoint(a,b,c){let d=this.FindNodeForPoint(a);if(null===d||null!==d.FindPointDirectly(a))return!1;if(d.pointItems.length<c.maxPointsPerNode||d.level>=c.maxTreeDepth)return d.AddPointDirectly(a,b),!0;d.CreateChildNodes();let e=d.pointItems;d.pointItems=[];for(let f=0;f<e.length;f++){let g=e[f];if(!d.AddPoint(g.point,g.data,c))return!1}return d.AddPoint(a,b,c)}FindPoint(a){let b=this.FindNodeForPoint(a);
return null===b?null:b.FindPointDirectly(a)}AddPointDirectly(a,b){this.pointItems.push({point:a,data:b})}FindPointDirectly(a){for(let b=0;b<this.pointItems.length;b++){let c=this.pointItems[b];if(OV.CoordIsEqual3D(a,c.point))return c.data}return null}FindNodeForPoint(a){if(!this.IsPointInBounds(a))return null;if(0===this.childNodes.length)return this;for(let b=0;b<this.childNodes.length;b++){let c=this.childNodes[b].FindNodeForPoint(a);if(null!==c)return c}return null}CreateChildNodes(){function a(g,
h,k,l,m,n,r){h=new OV.Box3D(new OV.Coord3D(h,k,l),new OV.Coord3D(h+m,k+n,l+r));g.childNodes.push(new OV.OctreeNode(h,g.level+1,g.options))}let b=this.boundingBox.min,c=this.boundingBox.GetCenter(),d=(this.boundingBox.max.x-this.boundingBox.min.x)/2,e=(this.boundingBox.max.y-this.boundingBox.min.y)/2,f=(this.boundingBox.max.z-this.boundingBox.min.z)/2;a(this,b.x,b.y,b.z,d,e,f);a(this,c.x,b.y,b.z,d,e,f);a(this,b.x,c.y,b.z,d,e,f);a(this,c.x,c.y,b.z,d,e,f);a(this,b.x,b.y,c.z,d,e,f);a(this,c.x,b.y,c.z,
d,e,f);a(this,b.x,c.y,c.z,d,e,f);a(this,c.x,c.y,c.z,d,e,f)}IsPointInBounds(a){return OV.IsGreaterOrEqual(a.x,this.boundingBox.min.x)&&OV.IsGreaterOrEqual(a.y,this.boundingBox.min.y)&&OV.IsGreaterOrEqual(a.z,this.boundingBox.min.z)&&OV.IsLowerOrEqual(a.x,this.boundingBox.max.x)&&OV.IsLowerOrEqual(a.y,this.boundingBox.max.y)&&OV.IsLowerOrEqual(a.z,this.boundingBox.max.z)}};
OV.Octree=class{constructor(a,b){this.options={maxPointsPerNode:10,maxTreeDepth:10};void 0!==b&&(void 0!==b.maxPointsPerNode&&(this.options.maxPointsPerNode=b.maxPointsPerNode),void 0!==b.maxTreeDepth&&(this.options.maxTreeDepth=b.maxTreeDepth));this.rootNode=new OV.OctreeNode(a,0,this.options)}AddPoint(a,b){return this.rootNode.AddPoint(a,b,this.options)}FindPoint(a){return this.rootNode.FindPoint(a)}};OV.Matrix=class{constructor(a){this.matrix=null;void 0!==a&&null!==a&&(this.matrix=a)}IsValid(){return null!==this.matrix}Set(a){this.matrix=a;return this}Get(){return this.matrix}Clone(){return new OV.Matrix([this.matrix[0],this.matrix[1],this.matrix[2],this.matrix[3],this.matrix[4],this.matrix[5],this.matrix[6],this.matrix[7],this.matrix[8],this.matrix[9],this.matrix[10],this.matrix[11],this.matrix[12],this.matrix[13],this.matrix[14],this.matrix[15]])}CreateIdentity(){this.matrix=[1,0,0,0,0,1,0,
0,0,0,1,0,0,0,0,1];return this}IsIdentity(){let a=(new OV.Matrix).CreateIdentity().Get();for(let b=0;16>b;b++)if(!OV.IsEqual(this.matrix[b],a[b]))return!1;return!0}CreateTranslation(a,b,c){this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1];return this}CreateRotation(a,b,c,d){var e=a+a,f=b+b;let g=c+c,h=a*e,k=a*f;a*=g;let l=b*f;b*=g;c*=g;e*=d;f*=d;d*=g;this.matrix=[1-(l+c),k+d,a-f,0,k-d,1-(h+c),b+e,0,a+f,b-e,1-(h+l),0,0,0,0,1];return this}CreateRotationAxisAngle(a,b){a=OV.QuaternionFromAxisAngle(a,b);return this.CreateRotation(a.x,
a.y,a.z,a.w)}CreateScale(a,b,c){this.matrix=[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1];return this}ComposeTRS(a,b,c){var d=b.x,e=b.y,f=b.z,g=b.w;b=c.x;let h=c.y;c=c.z;var k=d+d,l=e+e;let m=f+f,n=d*k,r=d*l;d*=m;let q=e*l;e*=m;f*=m;k*=g;l*=g;g*=m;this.matrix=[(1-(q+f))*b,(r+g)*b,(d-l)*b,0,(r-g)*h,(1-(n+f))*h,(e+k)*h,0,(d+l)*c,(e-k)*c,(1-(n+q))*c,0,a.x,a.y,a.z,1];return this}DecomposeTRS(){let a=new OV.Coord3D(this.matrix[12],this.matrix[13],this.matrix[14]);var b=OV.VectorLength3D(this.matrix[0],this.matrix[1],
this.matrix[2]),c=OV.VectorLength3D(this.matrix[4],this.matrix[5],this.matrix[6]),d=OV.VectorLength3D(this.matrix[8],this.matrix[9],this.matrix[10]),e=this.Determinant();OV.IsNegative(e)&&(b*=-1);e=new OV.Coord3D(b,c,d);var f=this.matrix[0]/b,g=this.matrix[4]/c;let h=this.matrix[8]/d,k=this.matrix[1]/b,l=this.matrix[5]/c,m=this.matrix[9]/d;b=this.matrix[2]/b;c=this.matrix[6]/c;d=this.matrix[10]/d;let n=f+l+d;0<n?(f=2*Math.sqrt(n+1),g=new OV.Quaternion((c-m)/f,(h-b)/f,(k-g)/f,.25*f)):f>l&&f>d?(f=2*
Math.sqrt(1+f-l-d),g=new OV.Quaternion(.25*f,(g+k)/f,(h+b)/f,(c-m)/f)):l>d?(f=2*Math.sqrt(1+l-f-d),g=new OV.Quaternion((g+k)/f,.25*f,(m+c)/f,(h-b)/f)):(f=2*Math.sqrt(1+d-f-l),g=new OV.Quaternion((h+b)/f,(m+c)/f,.25*f,(k-g)/f));return{translation:a,rotation:g,scale:e}}Determinant(){let a=this.matrix[0],b=this.matrix[1],c=this.matrix[2],d=this.matrix[3],e=this.matrix[4],f=this.matrix[5],g=this.matrix[6],h=this.matrix[7],k=this.matrix[8],l=this.matrix[9],m=this.matrix[10],n=this.matrix[11],r=this.matrix[12],
q=this.matrix[13],t=this.matrix[14],p=this.matrix[15];return(a*f-b*e)*(m*p-n*t)-(a*g-c*e)*(l*p-n*q)+(a*h-d*e)*(l*t-m*q)+(b*g-c*f)*(k*p-n*r)-(b*h-d*f)*(k*t-m*r)+(c*h-d*g)*(k*q-l*r)}Invert(){let a=this.matrix[0],b=this.matrix[1],c=this.matrix[2],d=this.matrix[3],e=this.matrix[4],f=this.matrix[5],g=this.matrix[6],h=this.matrix[7],k=this.matrix[8],l=this.matrix[9],m=this.matrix[10],n=this.matrix[11],r=this.matrix[12],q=this.matrix[13],t=this.matrix[14],p=this.matrix[15],u=a*f-b*e,v=a*g-c*e,w=a*h-d*e,
x=b*g-c*f,y=b*h-d*f,z=c*h-d*g,A=k*q-l*r,G=k*t-m*r,C=k*p-n*r,D=l*t-m*q,E=l*p-n*q,F=m*p-n*t,B=u*F-v*E+w*D+x*C-y*G+z*A;return OV.IsEqual(B,0)?null:new OV.Matrix([(f*F-g*E+h*D)/B,(c*E-b*F-d*D)/B,(q*z-t*y+p*x)/B,(m*y-l*z-n*x)/B,(g*C-e*F-h*G)/B,(a*F-c*C+d*G)/B,(t*w-r*z-p*v)/B,(k*z-m*w+n*v)/B,(e*E-f*C+h*A)/B,(b*C-a*E-d*A)/B,(r*y-q*w+p*u)/B,(l*w-k*y-n*u)/B,(f*G-e*D-g*A)/B,(a*D-b*G+c*A)/B,(q*v-r*x-t*u)/B,(k*x-l*v+m*u)/B])}MultiplyVector(a){let b=a[0],c=a[1],d=a[2];a=a[3];return[b*this.matrix[0]+c*this.matrix[4]+
d*this.matrix[8]+a*this.matrix[12],b*this.matrix[1]+c*this.matrix[5]+d*this.matrix[9]+a*this.matrix[13],b*this.matrix[2]+c*this.matrix[6]+d*this.matrix[10]+a*this.matrix[14],b*this.matrix[3]+c*this.matrix[7]+d*this.matrix[11]+a*this.matrix[15]]}MultiplyMatrix(a){let b=this.matrix[0],c=this.matrix[1],d=this.matrix[2],e=this.matrix[3],f=this.matrix[4],g=this.matrix[5],h=this.matrix[6],k=this.matrix[7],l=this.matrix[8],m=this.matrix[9],n=this.matrix[10],r=this.matrix[11],q=this.matrix[12],t=this.matrix[13],
p=this.matrix[14],u=this.matrix[15],v=a.matrix[0],w=a.matrix[1],x=a.matrix[2],y=a.matrix[3],z=a.matrix[4],A=a.matrix[5],G=a.matrix[6],C=a.matrix[7],D=a.matrix[8],E=a.matrix[9],F=a.matrix[10],B=a.matrix[11],H=a.matrix[12],I=a.matrix[13],J=a.matrix[14];a=a.matrix[15];return new OV.Matrix([b*v+c*z+d*D+e*H,b*w+c*A+d*E+e*I,b*x+c*G+d*F+e*J,b*y+c*C+d*B+e*a,f*v+g*z+h*D+k*H,f*w+g*A+h*E+k*I,f*x+g*G+h*F+k*J,f*y+g*C+h*B+k*a,l*v+m*z+n*D+r*H,l*w+m*A+n*E+r*I,l*x+m*G+n*F+r*J,l*y+m*C+n*B+r*a,q*v+t*z+p*D+u*H,q*w+t*
A+p*E+u*I,q*x+t*G+p*F+u*J,q*y+t*C+p*B+u*a])}};OV.MatrixIsEqual=function(a,b){a=a.Get();b=b.Get();for(let c=0;16>c;c++)if(!OV.IsEqual(a[c],b[c]))return!1;return!0};OV.Transformation=class{constructor(a){void 0!==a&&null!==a?this.matrix=a:(this.matrix=new OV.Matrix,this.matrix.CreateIdentity())}SetMatrix(a){this.matrix=a;return this}GetMatrix(){return this.matrix}IsIdentity(){return this.matrix.IsIdentity()}AppendMatrix(a){this.matrix=this.matrix.MultiplyMatrix(a);return this}Append(a){this.AppendMatrix(a.GetMatrix());return this}TransformCoord3D(a){a=this.matrix.MultiplyVector([a.x,a.y,a.z,1]);return new OV.Coord3D(a[0],a[1],a[2])}Clone(){const a=this.matrix.Clone();
return new OV.Transformation(a)}};OV.TransformationIsEqual=function(a,b){return OV.MatrixIsEqual(a.GetMatrix(),b.GetMatrix())};OV.BezierTweenFunction=function(a,b,c){b/=c;return a*b*b*(3-2*b)};OV.LinearTweenFunction=function(a,b,c){return b*a/c};OV.ParabolicTweenFunction=function(a,b,c){b/=c;c=b*b;return c/(2*(c-b)+1)*a};OV.TweenCoord3D=function(a,b,c,d){let e=OV.SubCoord3D(b,a).Normalize();b=OV.CoordDistance3D(a,b);let f=[];for(let g=0;g<c;g++){let h=d(b,g,c-1);f.push(a.Clone().Offset(e,h))}return f};OV.BinaryReader=class{constructor(a,b){this.arrayBuffer=a;this.dataView=new DataView(a);this.isLittleEndian=b;this.position=0}GetPosition(){return this.position}SetPosition(a){this.position=a}GetByteLength(){return this.arrayBuffer.byteLength}Skip(a){this.position+=a}End(){return this.position>=this.arrayBuffer.byteLength}ReadArrayBuffer(a){var b=new Uint8Array(this.arrayBuffer);let c=new ArrayBuffer(a),d=new Uint8Array(c);b=b.subarray(this.position,this.position+a);d.set(b,0);this.position+=a;return c}ReadBoolean8(){let a=
this.dataView.getInt8(this.position);this.position+=1;return a?!0:!1}ReadCharacter8(){let a=this.dataView.getInt8(this.position);this.position+=1;return a}ReadUnsignedCharacter8(){let a=this.dataView.getUint8(this.position);this.position+=1;return a}ReadInteger16(){let a=this.dataView.getInt16(this.position,this.isLittleEndian);this.position+=2;return a}ReadUnsignedInteger16(){let a=this.dataView.getUint16(this.position,this.isLittleEndian);this.position+=2;return a}ReadInteger32(){let a=this.dataView.getInt32(this.position,
this.isLittleEndian);this.position+=4;return a}ReadUnsignedInteger32(){let a=this.dataView.getUint32(this.position,this.isLittleEndian);this.position+=4;return a}ReadFloat32(){let a=this.dataView.getFloat32(this.position,this.isLittleEndian);this.position+=4;return a}ReadDouble64(){let a=this.dataView.getFloat64(this.position,this.isLittleEndian);this.position+=8;return a}};OV.BinaryWriter=class{constructor(a,b){this.arrayBuffer=new ArrayBuffer(a);this.dataView=new DataView(this.arrayBuffer);this.isLittleEndian=b;this.position=0}GetPosition(){return this.position}SetPosition(a){this.position=a}End(){return this.position>=this.arrayBuffer.byteLength}GetBuffer(){return this.arrayBuffer}WriteArrayBuffer(a){let b=new Uint8Array(a);(new Uint8Array(this.arrayBuffer)).set(b,this.position);this.position+=a.byteLength}WriteBoolean8(a){this.dataView.setInt8(this.position,a?1:
0);this.position+=1}WriteCharacter8(a){this.dataView.setInt8(this.position,a);this.position+=1}WriteUnsignedCharacter8(a){this.dataView.setUint8(this.position,a);this.position+=1}WriteInteger16(a){this.dataView.setInt16(this.position,a,this.isLittleEndian);this.position+=2}WriteUnsignedInteger16(a){this.dataView.setUint16(this.position,a,this.isLittleEndian);this.position+=2}WriteInteger32(a){this.dataView.setInt32(this.position,a,this.isLittleEndian);this.position+=4}WriteUnsignedInteger32(a){this.dataView.setUint32(this.position,
a,this.isLittleEndian);this.position+=4}WriteFloat32(a){this.dataView.setFloat32(this.position,a,this.isLittleEndian);this.position+=4}WriteDouble64(a){this.dataView.setFloat64(this.position,a,this.isLittleEndian);this.position+=8}};OV.TextWriter=class{constructor(){this.text="";this.indentation=0}GetText(){return this.text}Indent(a){this.indentation+=a}WriteArrayLine(a){this.WriteLine(a.join(" "))}WriteLine(a){this.WriteIndentation();this.Write(a+"\n")}WriteIndentation(){for(let a=0;a<this.indentation;a++)this.Write("  ")}Write(a){this.text+=a}};OV.ArrayBufferToUtf8String=function(a){return(new TextDecoder("utf-8")).decode(a)};OV.ArrayBufferToAsciiString=function(a){let b="";a=new Uint8Array(a);for(let c=0;c<a.byteLength;c++)b+=String.fromCharCode(a[c]);return b};OV.AsciiStringToArrayBuffer=function(a){let b=new ArrayBuffer(a.length),c=new Uint8Array(b);for(let d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return b};OV.Utf8StringToArrayBuffer=function(a){return(new TextEncoder).encode(a).buffer};
OV.Base64DataURIToArrayBuffer=function(a){if(!a.startsWith("data:"))return null;var b=a.indexOf(";");if(-1===b)return null;var c=a.indexOf(",");if(-1===c)return null;b=a.substr(5,b-5);a=atob(a.substr(c+1));c=new ArrayBuffer(a.length);let d=new Uint8Array(c);for(let e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return{mimeType:b,buffer:c}};OV.GetFileExtensionFromMimeType=function(a){if(void 0===a||null===a)return"";a=a.split("/");return 0===a.length?"":a[a.length-1]};
OV.CreateObjectUrl=function(a){a=new Blob([a]);return URL.createObjectURL(a)};OV.CreateObjectUrlWithMimeType=function(a,b){a=new Blob([a],{type:b});return URL.createObjectURL(a)};OV.RevokeObjectUrl=function(a){URL.revokeObjectURL(a)};OV.FileSource={Url:1,File:2,Decompressed:3};OV.FileFormat={Text:1,Binary:2};OV.GetFileName=function(a){let b=a.lastIndexOf("/");-1===b&&(b=a.lastIndexOf("\\"));let c=a;-1!==b&&(c=a.substr(b+1));a=c.indexOf("?");-1!==a&&(c=c.substr(0,a));return decodeURI(c)};OV.GetFileExtension=function(a){a=OV.GetFileName(a);let b=a.lastIndexOf(".");return-1===b?"":a.substr(b+1).toLowerCase()};
OV.RequestUrl=function(a,b){return new Promise((c,d)=>{let e=new XMLHttpRequest;e.open("GET",a,!0);if(b===OV.FileFormat.Text)e.responseType="text";else if(b===OV.FileFormat.Binary)e.responseType="arraybuffer";else{d();return}e.onload=function(){200===e.status?c(e.response):d()};e.onerror=function(){d()};e.send(null)})};
OV.ReadFile=function(a,b){return new Promise((c,d)=>{let e=new FileReader;e.onloadend=function(f){f.target.readyState===FileReader.DONE&&c(f.target.result)};e.onerror=function(){d()};b===OV.FileFormat.Text?e.readAsText(a):b===OV.FileFormat.Binary?e.readAsArrayBuffer(a):d()})};
OV.TransformFileHostUrls=function(a){for(let c=0;c<a.length;c++){let d=a[c];if(-1!==d.search(/www\.dropbox\.com/u)){d=d.replace("www.dropbox.com","dl.dropbox.com");var b=d.indexOf("?");-1!==b&&(d=d.substr(0,b));a[c]=d}else-1!==d.search(/github\.com/u)&&(d=d.replace("github.com","raw.githubusercontent.com"),d=d.replace("/blob",""),b=d.indexOf("?"),-1!==b&&(d=d.substr(0,b)),a[c]=d)}};OV.ExternalLibLocation=null;OV.LoadedExternalLibs=new Set;OV.LoadExternalLibrary=function(a){return new Promise((b,c)=>{if(null===OV.ExternalLibLocation)c();else if(OV.LoadedExternalLibs.has(a))b();else{var d=document.createElement("script");d.type="text/javascript";d.src=OV.ExternalLibLocation+"/"+a;d.onload=()=>{OV.LoadedExternalLibs.add(a);b()};d.onerror=()=>{c()};document.head.appendChild(d)}})};OV.Color=class{constructor(a,b,c){this.r=a;this.g=b;this.b=c}Set(a,b,c){this.r=a;this.g=b;this.b=c}Clone(){return new OV.Color(this.r,this.g,this.b)}};OV.ColorComponentFromFloat=function(a){return parseInt(Math.round(255*a),10)};OV.ColorFromFloatComponents=function(a,b,c){return new OV.Color(OV.ColorComponentFromFloat(a),OV.ColorComponentFromFloat(b),OV.ColorComponentFromFloat(c))};OV.SRGBToLinear=function(a){return.04045>a?.0773993808*a:Math.pow(.9478672986*a+.0521327014,2.4)};
OV.LinearToSRGB=function(a){return.0031308>a?12.92*a:1.055*Math.pow(a,.41666)-.055};OV.IntegerToHexString=function(a){for(a=parseInt(a,10).toString(16);2>a.length;)a="0"+a;return a};OV.ColorToHexString=function(a){let b=OV.IntegerToHexString(a.r),c=OV.IntegerToHexString(a.g);a=OV.IntegerToHexString(a.b);return b+c+a};OV.HexStringToColor=function(a){if(6!==a.length)return null;let b=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16);a=parseInt(a.substr(4,2),16);return new OV.Color(b,c,a)};
OV.ArrayToColor=function(a){return new OV.Color(a[0],a[1],a[2])};OV.ColorIsEqual=function(a,b){return a.r===b.r&&a.g===b.g&&a.b===b.b};OV.TextureMap=class{constructor(){this.buffer=this.url=this.name=null;this.offset=new OV.Coord2D(0,0);this.scale=new OV.Coord2D(1,1);this.rotation=0}IsValid(){return null!==this.name&&null!==this.url&&null!==this.buffer}HasTransformation(){return OV.CoordIsEqual2D(this.offset,new OV.Coord2D(0,0))&&OV.CoordIsEqual2D(this.scale,new OV.Coord2D(1,1))&&OV.IsEqual(this.rotation,0)?!1:!0}IsEqual(a){return this.name===a.name&&this.name===a.name&&this.url===a.url&&OV.CoordIsEqual2D(this.offset,a.offset)&&
OV.CoordIsEqual2D(this.scale,a.scale)&&OV.IsEqual(this.rotation,a.rotation)?!0:!1}};OV.TextureMapIsEqual=function(a,b){return null===a&&null===b?!0:null===a||null===b?!1:a.IsEqual(b)};OV.MaterialType={Phong:1,Physical:2};
OV.MaterialBase=class{constructor(a){this.type=a;this.isDefault=!1;this.name="";this.color=new OV.Color(0,0,0);this.vertexColors=!1}IsEqual(a){return this.type===a.type&&this.isDefault===a.isDefault&&this.name===a.name&&OV.ColorIsEqual(this.color,a.color)&&this.vertexColors===a.vertexColors?!0:!1}};
OV.FaceMaterial=class extends OV.MaterialBase{constructor(a){super(a);this.emissive=new OV.Color(0,0,0);this.opacity=1;this.transparent=!1;this.emissiveMap=this.normalMap=this.bumpMap=this.diffuseMap=null;this.alphaTest=0;this.multiplyDiffuseMap=!1}IsEqual(a){return super.IsEqual(a)&&OV.ColorIsEqual(this.emissive,a.emissive)&&OV.IsEqual(this.opacity,a.opacity)&&this.transparent===a.transparent&&OV.TextureMapIsEqual(this.diffuseMap,a.diffuseMap)&&OV.TextureMapIsEqual(this.bumpMap,a.bumpMap)&&OV.TextureMapIsEqual(this.normalMap,
a.normalMap)&&OV.TextureMapIsEqual(this.emissiveMap,a.emissiveMap)&&OV.IsEqual(this.alphaTest,a.alphaTest)&&this.multiplyDiffuseMap===a.multiplyDiffuseMap?!0:!1}EnumerateTextureMaps(a){null!==this.diffuseMap&&a(this.diffuseMap);null!==this.bumpMap&&a(this.bumpMap);null!==this.normalMap&&a(this.normalMap);null!==this.emissiveMap&&a(this.emissiveMap)}};
OV.PhongMaterial=class extends OV.FaceMaterial{constructor(){super(OV.MaterialType.Phong);this.ambient=new OV.Color(0,0,0);this.specular=new OV.Color(0,0,0);this.shininess=0;this.specularMap=null}IsEqual(a){return super.IsEqual(a)&&OV.ColorIsEqual(this.ambient,a.ambient)&&OV.ColorIsEqual(this.specular,a.specular)&&OV.IsEqual(this.shininess,a.shininess)&&OV.TextureMapIsEqual(this.specularMap,a.specularMap)?!0:!1}EnumerateTextureMaps(a){super.EnumerateTextureMaps(a);null!==this.specularMap&&a(this.specularMap)}};
OV.PhysicalMaterial=class extends OV.FaceMaterial{constructor(){super(OV.MaterialType.Physical);this.metalness=0;this.roughness=1;this.metalnessMap=null}IsEqual(a){return super.IsEqual(a)&&OV.IsEqual(this.metalness,a.metalness)&&OV.IsEqual(this.roughness,a.roughness)&&OV.TextureMapIsEqual(this.metalnessMap,a.metalnessMap)?!0:!1}EnumerateTextureMaps(a){super.EnumerateTextureMaps(a);null!==this.metalnessMap&&a(this.metalnessMap)}};
OV.TextureIsEqual=function(a,b){return a.name===b.name&&a.name===b.name&&a.url===b.url&&OV.CoordIsEqual2D(a.offset,b.offset)&&OV.CoordIsEqual2D(a.scale,b.scale)&&OV.IsEqual(a.rotation,b.rotation)?!0:!1};OV.Triangle=class{constructor(a,b,c){this.v0=a;this.v1=b;this.v2=c;this.curve=this.mat=this.u2=this.u1=this.u0=this.n2=this.n1=this.n0=this.c2=this.c1=this.c0=null}HasVertices(){return null!==this.v0&&null!==this.v1&&null!==this.v2}HasVertexColors(){return null!==this.c0&&null!==this.c1&&null!==this.c2}HasNormals(){return null!==this.n0&&null!==this.n1&&null!==this.n2}HasTextureUVs(){return null!==this.u0&&null!==this.u1&&null!==this.u2}SetVertices(a,b,c){this.v0=a;this.v1=b;this.v2=c;return this}SetVertexColors(a,
b,c){this.c0=a;this.c1=b;this.c2=c;return this}SetNormals(a,b,c){this.n0=a;this.n1=b;this.n2=c;return this}SetTextureUVs(a,b,c){this.u0=a;this.u1=b;this.u2=c;return this}SetMaterial(a){this.mat=a;return this}SetCurve(a){this.curve=a;return this}Clone(){let a=new OV.Triangle(this.v0,this.v1,this.v2);a.SetVertexColors(this.c0,this.c1,this.c2);a.SetNormals(this.n0,this.n1,this.n2);a.SetTextureUVs(this.u0,this.u1,this.u2);a.SetMaterial(this.mat);a.SetCurve(this.curve);return a}};OV.PropertyType={Text:1,Integer:2,Number:3,Boolean:4,Percent:5,Color:6};OV.Property=class{constructor(a,b,c){this.type=a;this.name=b;this.value=c}};OV.PropertyGroup=class{constructor(a){this.name=a;this.properties=[]}PropertyCount(){return this.properties.length}AddProperty(a){this.properties.push(a)}GetProperty(a){return this.properties[a]}};OV.Object3D=class{constructor(){}VertexCount(){return 0}VertexColorCount(){return 0}NormalCount(){return 0}TextureUVCount(){return 0}TriangleCount(){return 0}EnumerateVertices(a){}EnumerateTriangleVertexIndices(a){}EnumerateTriangleVertices(a){}};
OV.ModelObject3D=class extends OV.Object3D{constructor(){super();this.name="";this.propertyGroups=[]}GetName(){return this.name}SetName(a){this.name=a}PropertyGroupCount(){return this.propertyGroups.length}AddPropertyGroup(a){this.propertyGroups.push(a);return this.propertyGroups.length-1}GetPropertyGroup(a){return this.propertyGroups[a]}};OV.Mesh=class extends OV.ModelObject3D{constructor(){super();this.vertices=[];this.vertexColors=[];this.normals=[];this.uvs=[];this.triangles=[]}VertexCount(){return this.vertices.length}VertexColorCount(){return this.vertexColors.length}NormalCount(){return this.normals.length}TextureUVCount(){return this.uvs.length}TriangleCount(){return this.triangles.length}AddVertex(a){this.vertices.push(a);return this.vertices.length-1}SetVertex(a,b){this.vertices[a]=b}GetVertex(a){return this.vertices[a]}AddVertexColor(a){this.vertexColors.push(a);
return this.vertexColors.length-1}SetVertexColor(a,b){this.vertexColors[a]=b}GetVertexColor(a){return this.vertexColors[a]}AddNormal(a){this.normals.push(a);return this.normals.length-1}SetNormal(a,b){this.normals[a]=b}GetNormal(a){return this.normals[a]}AddTextureUV(a){this.uvs.push(a);return this.uvs.length-1}SetTextureUV(a,b){this.uvs[a]=b}GetTextureUV(a){return this.uvs[a]}AddTriangle(a){this.triangles.push(a);return this.triangles.length-1}GetTriangle(a){return this.triangles[a]}EnumerateVertices(a){for(const b of this.vertices)a(b)}EnumerateTriangleVertexIndices(a){for(const b of this.triangles)a(b.v0,
b.v1,b.v2)}EnumerateTriangleVertices(a){for(const b of this.triangles)a(this.vertices[b.v0],this.vertices[b.v1],this.vertices[b.v2])}Clone(){let a=new OV.Mesh;a.SetName(this.GetName());for(var b=0;b<this.VertexCount();b++){var c=this.GetVertex(b);a.AddVertex(c.Clone())}for(b=0;b<this.VertexColorCount();b++)c=this.GetVertexColor(b),a.AddVertexColor(c.Clone());for(b=0;b<this.NormalCount();b++)c=this.GetNormal(b),a.AddNormal(c.Clone());for(b=0;b<this.TextureUVCount();b++)c=this.GetTextureUV(b),a.AddTextureUV(c.Clone());
for(b=0;b<this.TriangleCount();b++)c=this.GetTriangle(b),a.AddTriangle(c.Clone());return a}};OV.MeshPrimitiveBuffer=class{constructor(){this.indices=[];this.vertices=[];this.colors=[];this.normals=[];this.uvs=[];this.material=null}GetBounds(){let a=[Infinity,Infinity,Infinity],b=[-Infinity,-Infinity,-Infinity];for(let c=0;c<this.vertices.length/3;c++)for(let d=0;3>d;d++)a[d]=Math.min(a[d],this.vertices[3*c+d]),b[d]=Math.max(b[d],this.vertices[3*c+d]);return{min:a,max:b}}GetByteLength(a,b){return this.indices.length*a+(this.vertices.length+this.colors.length+this.normals.length+this.uvs.length)*
b}};OV.MeshBuffer=class{constructor(){this.primitives=[]}PrimitiveCount(){return this.primitives.length}GetPrimitive(a){return this.primitives[a]}GetByteLength(a,b){let c=0;for(let d=0;d<this.primitives.length;d++)c+=this.primitives[d].GetByteLength(a,b);return c}};
OV.ConvertMeshToMeshBuffer=function(a){function b(g,h,k,l){function m(r,q,t){var p=0<r.VertexColorCount();let u=0<r.TextureUVCount();var v=r.GetVertex(q.vertex);let w=r.GetNormal(q.normal),x=t.vertices.length/3;t.indices.push(x);t.vertices.push(v.x,v.y,v.z);v=q.color;p=null!==v?r.GetVertexColor(v):p?new OV.Color(0,0,0):null;null!==p&&t.colors.push(p.r/255,p.g/255,p.b/255);t.normals.push(w.x,w.y,w.z);q=q.uv;r=null!==q?r.GetTextureUV(q):u?new OV.Coord2D(0,0):null;null!==r&&t.uvs.push(r.x,r.y);return{index:x,
color:p,normal:w,uv:r}}function n(r,q,t){function p(w,x,y){if(null===y&&null===x)return!0;w=null!==x?w.GetVertexColor(x):new OV.Color(0,0,0);return OV.ColorIsEqual(y,w)}function u(w,x,y){w=w.GetNormal(x);return OV.CoordIsEqual3D(y,w)}function v(w,x,y){if(null===y&&null===x)return!0;w=null!==x?w.GetTextureUV(x):new OV.Coord2D(0,0);return OV.CoordIsEqual2D(y,w)}for(let w=0;w<q.length;w++){let x=q[w],y=p(r,t.color,x.color),z=u(r,t.normal,x.normal),A=v(r,t.uv,x.uv);if(y&&z&&A)return x}return null}if(l.has(h.vertex)){l=
l.get(h.vertex);let r=n(g,l,h);null!==r?k.indices.push(r.index):(h=m(g,h,k),l.push(h))}else g=m(g,h,k),l.set(h.vertex,[g])}let c=new OV.MeshBuffer;var d=a.TriangleCount();if(0===d)return null;let e=[];for(var f=0;f<d;f++)e.push(f);e.sort((g,h)=>{g=a.GetTriangle(g);h=a.GetTriangle(h);return g.mat-h.mat});f=d=null;for(let g=0;g<e.length;g++){let h=a.GetTriangle(e[g]);if(null===d||d.material!==h.mat)d=new OV.MeshPrimitiveBuffer,d.material=h.mat,f=new Map,c.primitives.push(d);let k={vertex:h.v1,color:h.c1,
normal:h.n1,uv:h.u1},l={vertex:h.v2,color:h.c2,normal:h.n2,uv:h.u2};b(a,{vertex:h.v0,color:h.c0,normal:h.n0,uv:h.u0},d,f);b(a,k,d,f);b(a,l,d,f)}return c};OV.NodeType={GroupNode:0,MeshNode:1};OV.NodeIdGenerator=class{constructor(){this.nextId=0}GenerateId(){const a=this.nextId;this.nextId+=1;return a}};
OV.Node=class{constructor(){this.type=OV.NodeType.GroupNode;this.name="";this.parent=null;this.transformation=new OV.Transformation;this.childNodes=[];this.meshIndices=[];this.idGenerator=new OV.NodeIdGenerator;this.id=this.idGenerator.GenerateId()}IsEmpty(){return 0===this.childNodes.length&&0===this.meshIndices.length}GetType(){return this.type}SetType(a){this.type=a}GetId(){return this.id}GetName(){return this.name}SetName(a){this.name=a}HasParent(){return null!==this.parent}GetParent(){return this.parent}GetTransformation(){return this.transformation}GetWorldTransformation(){let a=
this.transformation.Clone(),b=this.parent;for(;null!==b;)a.Append(b.transformation),b=b.parent;return a}SetTransformation(a){this.transformation=a}AddChildNode(a){a.parent=this;a.idGenerator=this.idGenerator;a.id=a.idGenerator.GenerateId();this.childNodes.push(a);return this.childNodes.length-1}RemoveChildNode(a){a.parent=null;a=this.childNodes.indexOf(a);this.childNodes.splice(a,1)}GetChildNodes(){return this.childNodes}ChildNodeCount(){return this.childNodes.length}GetChildNode(a){return this.childNodes[a]}AddMeshIndex(a){this.meshIndices.push(a);
return this.meshIndices.length-1}MeshIndexCount(){return this.meshIndices.length}GetMeshIndex(a){return this.meshIndices[a]}GetMeshIndices(){return this.meshIndices}Enumerate(a){a(this);for(const b of this.childNodes)b.Enumerate(a)}EnumerateChildren(a){for(const b of this.childNodes)a(b),b.EnumerateChildren(a)}EnumerateMeshIndices(a){for(const b of this.meshIndices)a(b);for(const b of this.childNodes)b.EnumerateMeshIndices(a)}};OV.MeshInstanceId=class{constructor(a,b){this.nodeId=a;this.meshIndex=b}IsEqual(a){return this.nodeId===a.nodeId&&this.meshIndex===a.meshIndex}GetKey(){return this.nodeId.toString()+":"+this.meshIndex.toString()}};
OV.MeshInstance=class extends OV.ModelObject3D{constructor(a,b,c){super();this.id=a;this.node=b;this.mesh=c}GetId(){return this.id}GetTransformation(){return this.node.GetWorldTransformation()}GetMesh(){return this.mesh}VertexCount(){return this.mesh.VertexCount()}VertexColorCount(){return this.mesh.VertexColorCount()}NormalCount(){return this.mesh.NormalCount()}TextureUVCount(){return this.mesh.TextureUVCount()}TriangleCount(){return this.mesh.TriangleCount()}EnumerateVertices(a){let b=this.node.GetWorldTransformation();
b.IsIdentity()?this.mesh.EnumerateVertices(a):this.mesh.EnumerateVertices(c=>{c=b.TransformCoord3D(c);a(c)})}EnumerateTriangleVertexIndices(a){this.mesh.EnumerateTriangleVertexIndices(a)}EnumerateTriangleVertices(a){let b=this.node.GetWorldTransformation();b.IsIdentity()?this.mesh.EnumerateTriangleVertices(a):this.mesh.EnumerateTriangleVertices((c,d,e)=>{c=b.TransformCoord3D(c);d=b.TransformCoord3D(d);e=b.TransformCoord3D(e);a(c,d,e)})}PropertyGroupCount(){return this.mesh.PropertyGroupCount()}AddPropertyGroup(a){return this.mesh.AddPropertyGroup(a)}GetPropertyGroup(a){return this.mesh.GetPropertyGroup(a)}GetTransformedMesh(){let a=
this.node.GetWorldTransformation(),b=this.mesh.Clone();OV.TransformMesh(b,a);return b}};OV.Model=class extends OV.ModelObject3D{constructor(){super();this.root=new OV.Node;this.materials=[];this.meshes=[]}GetRootNode(){return this.root}MaterialCount(){return this.materials.length}MeshCount(){return this.meshes.length}MeshInstanceCount(){let a=0;this.root.Enumerate(b=>{a+=b.MeshIndexCount()});return a}VertexCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=b.VertexCount()});return a}VertexColorCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=b.VertexColorCount()});return a}NormalCount(){let a=
0;this.EnumerateMeshInstances(b=>{a+=b.NormalCount()});return a}TextureUVCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=b.TextureUVCount()});return a}TriangleCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=b.TriangleCount()});return a}AddMaterial(a){this.materials.push(a);return this.materials.length-1}GetMaterial(a){return this.materials[a]}AddMesh(a){this.meshes.push(a);return this.meshes.length-1}AddMeshToRootNode(a){a=this.AddMesh(a);this.root.AddMeshIndex(a);return a}RemoveMesh(a){this.meshes.splice(a,
1);this.root.Enumerate(b=>{for(let c=0;c<b.meshIndices.length;c++)b.meshIndices[c]===a?(b.meshIndices.splice(c,1),--c):b.meshIndices[c]>a&&--b.meshIndices[c]})}GetMesh(a){return this.meshes[a]}GetMeshInstance(a){let b=null;this.root.Enumerate(e=>{e.GetId()===a.nodeId&&(b=e)});if(null===b||-1===b.GetMeshIndices().indexOf(a.meshIndex))return null;let c=this.GetMesh(a.meshIndex),d=new OV.MeshInstanceId(b.GetId(),a.meshIndex);return new OV.MeshInstance(d,b,c)}EnumerateMeshes(a){for(const b of this.meshes)a(b)}EnumerateMeshInstances(a){this.root.Enumerate(b=>
{for(let d of b.GetMeshIndices()){var c=new OV.MeshInstanceId(b.GetId(),d);let e=this.GetMesh(d);c=new OV.MeshInstance(c,b,e);a(c)}})}EnumerateTransformedMeshes(a){this.EnumerateMeshInstances(b=>{b=b.GetTransformedMesh();a(b)})}EnumerateVertices(a){this.EnumerateMeshInstances(b=>{b.EnumerateVertices(a)})}EnumerateTriangleVertexIndices(a){this.EnumerateMeshInstances(b=>{b.EnumerateTriangleVertexIndices(a)})}EnumerateTriangleVertices(a){this.EnumerateMeshInstances(b=>{b.EnumerateTriangleVertices(a)})}};OV.TopologyVertex=class{constructor(){this.edges=[];this.triangles=[]}};OV.TopologyEdge=class{constructor(a,b){this.vertex1=a;this.vertex2=b;this.triangles=[]}};OV.TopologyTriangleEdge=class{constructor(a,b){this.edge=a;this.reversed=b}};OV.TopologyTriangle=class{constructor(){this.triEdge3=this.triEdge2=this.triEdge1=null}};
OV.Topology=class{constructor(){this.vertices=[];this.edges=[];this.triangleEdges=[];this.triangles=[];this.edgeStartToEndVertexMap=new Map}AddVertex(){this.vertices.push(new OV.TopologyVertex);return this.vertices.length-1}AddTriangle(a,b,c){let d=this.triangles.length,e=new OV.TopologyTriangle;e.triEdge1=this.AddTriangleEdge(a,b);e.triEdge2=this.AddTriangleEdge(b,c);e.triEdge3=this.AddTriangleEdge(c,a);this.vertices[a].triangles.push(d);this.vertices[b].triangles.push(d);this.vertices[c].triangles.push(d);
this.vertices[a].edges.push(this.triangleEdges[e.triEdge1].edge);this.vertices[b].edges.push(this.triangleEdges[e.triEdge2].edge);this.vertices[c].edges.push(this.triangleEdges[e.triEdge3].edge);this.edges[this.triangleEdges[e.triEdge1].edge].triangles.push(d);this.edges[this.triangleEdges[e.triEdge2].edge].triangles.push(d);this.edges[this.triangleEdges[e.triEdge3].edge].triangles.push(d);this.triangles.push(e)}AddTriangleEdge(a,b){let c=a,d=b,e=!1;b<a&&(c=b,d=a,e=!0);a=this.AddEdge(c,d);this.triangleEdges.push(new OV.TopologyTriangleEdge(a,
e));return this.triangleEdges.length-1}AddEdge(a,b){this.edgeStartToEndVertexMap.has(a)||this.edgeStartToEndVertexMap.set(a,[]);let c=this.edgeStartToEndVertexMap.get(a);for(var d=0;d<c.length;d++){let e=c[d];if(e.endVertex===b)return e.edgeIndex}d=this.edges.length;c.push({endVertex:b,edgeIndex:d});this.edges.push(new OV.TopologyEdge(a,b));return d}};OV.MeshType={Empty:0,TriangleMesh:1};OV.GetMeshType=function(a){return 0<a.TriangleCount()?OV.MeshType.TriangleMesh:OV.MeshType.Empty};OV.CalculateTriangleNormal=function(a,b,c){b=OV.SubCoord3D(b,a);a=OV.SubCoord3D(c,a);a=OV.CrossVector3D(b,a);a.Normalize();return a};
OV.TransformMesh=function(a,b){if(!b.IsIdentity()){for(var c=0;c<a.VertexCount();c++){var d=a.GetVertex(c),e=b.TransformCoord3D(d);d.x=e.x;d.y=e.y;d.z=e.z}if(0<a.NormalCount())for(b=b.GetMatrix().DecomposeTRS(),b=(new OV.Matrix).ComposeTRS(new OV.Coord3D(0,0,0),b.rotation,new OV.Coord3D(1,1,1)),b=new OV.Transformation(b),c=0;c<a.NormalCount();c++)d=a.GetNormal(c),e=b.TransformCoord3D(d),d.x=e.x,d.y=e.y,d.z=e.z}};
OV.FlipMeshTrianglesOrientation=function(a){for(let b=0;b<a.TriangleCount();b++){let c=a.GetTriangle(b),d=c.v1;c.v1=c.v2;c.v2=d}};OV.IsModelEmpty=function(a){let b=!0;a.EnumerateMeshInstances(c=>{OV.GetMeshType(c)!==OV.MeshType.Empty&&(b=!1)});return b};OV.GetBoundingBox=function(a){let b=new OV.BoundingBoxCalculator3D;a.EnumerateVertices(c=>{b.AddPoint(c)});return b.GetBox()};
OV.GetTopology=function(a){function b(f,g,h){let k=g.FindPoint(f);null===k&&(k=h.AddVertex(),g.AddPoint(f,k));return k}let c=OV.GetBoundingBox(a),d=new OV.Octree(c),e=new OV.Topology;a.EnumerateTriangleVertices((f,g,h)=>{f=b(f,d,e);g=b(g,d,e);h=b(h,d,e);e.AddTriangle(f,g,h)});return e};
OV.IsSolid=function(a){a=OV.GetTopology(a);for(let e=0;e<a.edges.length;e++){const f=a.edges[e];var b=f.triangles.length;if(0===b||0!==b%2)return!1;b=0;for(let g=0;g<f.triangles.length;g++){{var c=a.triangles[f.triangles[g]];var d=a.triangleEdges[c.triEdge1];const h=a.triangleEdges[c.triEdge2];c=a.triangleEdges[c.triEdge3];d=d.edge===e?d.reversed:h.edge===e?h.reversed:c.edge===e?c.reversed:null}b=d?b+1:b-1}if(0!==b)return!1}return!0};
OV.HasDefaultMaterial=function(a){for(let b=0;b<a.MaterialCount();b++){let c=a.GetMaterial(b);if(c.isDefault&&!c.vertexColors)return!0}return!1};OV.ReplaceDefaultMaterialColor=function(a,b){for(let c=0;c<a.MaterialCount();c++){let d=a.GetMaterial(c);d.isDefault&&(d.color=b)}};OV.ModelFinalizer=class{constructor(a){this.params={getDefaultMaterialColor:()=>new OV.Color(0,0,0)};OV.CopyObjectAttributes(a,this.params);this.defaultMaterialIndex=null}Finalize(a){this.Reset();this.FinalizeMeshes(a);this.FinalizeMaterials(a);this.FinalizeNodes(a)}FinalizeMaterials(a){if(0<a.VertexColorCount()){var b=new Map;for(let c=0;c<a.MeshCount();c++){let d=a.GetMesh(c);for(let e=0;e<d.TriangleCount();e++){let f=d.GetTriangle(e),g=f.HasVertexColors();b.has(f.mat)?g||b.set(f.mat,!1):b.set(f.mat,
g)}}for(let [c,d]of b)a.GetMaterial(c).vertexColors=d}}FinalizeMeshes(a){for(let b=0;b<a.MeshCount();b++){let c=a.GetMesh(b);OV.GetMeshType(c)===OV.MeshType.Empty?(a.RemoveMesh(b),--b):this.FinalizeMesh(a,c)}}FinalizeMesh(a,b){function c(e){function f(q,t,p,u,v){let w=[];p=v.get(p);for(v=0;v<p.length;v++){var x=p[v],y=q.GetTriangle(x);if(t.curve===y.curve){x=u[x];a:{y=w;var z=x;for(let A=0;A<y.length;A++)if(OV.CoordIsEqual3D(y[A],z)){y=!0;break a}y=!1}y||w.push(x)}}t=new OV.Coord3D(0,0,0);for(u=0;u<
w.length;u++)t=OV.AddCoord3D(t,w[u]);t.MultiplyScalar(1/w.length);t.Normalize();return q.AddNormal(t)}let g=[],h=new Map;for(var k=0;k<e.VertexCount();k++)h.set(k,[]);for(k=0;k<e.TriangleCount();k++){var l=e.GetTriangle(k),m=e.GetVertex(l.v0),n=e.GetVertex(l.v1),r=e.GetVertex(l.v2);m=OV.CalculateTriangleNormal(m,n,r);g.push(m);h.get(l.v0).push(k);h.get(l.v1).push(k);h.get(l.v2).push(k)}for(k=0;k<e.TriangleCount();k++)l=e.GetTriangle(k),l.HasNormals()||(m=f(e,l,l.v0,g,h),n=f(e,l,l.v1,g,h),r=f(e,l,
l.v2,g,h),l.SetNormals(m,n,r))}let d={calculateCurveNormals:!1};for(let e=0;e<b.TriangleCount();e++){let f=b.GetTriangle(e);this.FinalizeTriangle(b,f,d);null===f.mat&&(f.mat=this.GetDefaultMaterialIndex(a))}d.calculateCurveNormals&&c(b)}FinalizeTriangle(a,b,c){if(!b.HasNormals())if(null===b.curve||0===b.curve){c=a.GetVertex(b.v0);let d=a.GetVertex(b.v1),e=a.GetVertex(b.v2);c=OV.CalculateTriangleNormal(c,d,e);a=a.AddNormal(c);b.SetNormals(a,a,a)}else c.calculateCurveNormals=!0;null===b.curve&&(b.curve=
0)}FinalizeNodes(a){let b=[];a.GetRootNode().EnumerateChildren(c=>{c.IsEmpty()&&b.push(c)});for(a=0;a<b.length;a++){let c=b[a],d=c.GetParent();null!==d&&(d.RemoveChildNode(c),d.IsEmpty()&&b.push(d))}}GetDefaultMaterialIndex(a){if(null===this.defaultMaterialIndex){let b=this.params.getDefaultMaterialColor(),c=new OV.PhongMaterial;c.color=b;c.isDefault=!0;this.defaultMaterialIndex=a.AddMaterial(c)}return this.defaultMaterialIndex}Reset(){this.defaultMaterialIndex=null}};
OV.FinalizeModel=function(a,b){(new OV.ModelFinalizer(b)).Finalize(a)};
OV.CheckModel=function(a){function b(e){return void 0===e||null===e||isNaN(e)?!1:!0}function c(e,f){return!b(e)||0>e||e>=f?!1:!0}function d(e,f){for(var g=0;g<f.VertexCount();g++){var h=f.GetVertex(g);if(!b(h.x)||!b(h.y)||!b(h.z))return!1}for(g=0;g<f.VertexColorCount();g++)if(h=f.GetVertexColor(g),!b(h.r)||!b(h.g)||!b(h.b))return!1;for(g=0;g<f.NormalCount();g++)if(h=f.GetNormal(g),!b(h.x)||!b(h.y)||!b(h.z))return!1;for(g=0;g<f.TextureUVCount();g++)if(h=f.GetTextureUV(g),!b(h.x)||!b(h.y))return!1;
for(let l=0;l<f.TriangleCount();l++){var k=f.GetTriangle(l);g=e;h=f;if(!(c(k.v0,h.VertexCount())&&c(k.v1,h.VertexCount())&&c(k.v2,h.VertexCount())&&(!k.HasVertexColors()||c(k.c0,h.VertexColorCount())&&c(k.c1,h.VertexColorCount())&&c(k.c2,h.VertexColorCount()))&&c(k.n0,h.NormalCount())&&c(k.n1,h.NormalCount())&&c(k.n2,h.NormalCount())&&(!k.HasTextureUVs()||c(k.u0,h.TextureUVCount())&&c(k.u1,h.TextureUVCount())&&c(k.u2,h.TextureUVCount()))&&c(k.mat,g.MaterialCount())&&b(k.curve)))return!1}return!0}
for(let e=0;e<a.MeshCount();e++){let f=a.GetMesh(e);if(!d(a,f))return!1}return!0};OV.GetTriangleArea=function(a,b,c){var d=OV.CoordDistance3D(a,b);b=OV.CoordDistance3D(b,c);a=OV.CoordDistance3D(a,c);c=(d+b+a)/2;d=c*(c-d)*(c-b)*(c-a);return 0>d?0:Math.sqrt(d)};OV.GetTetrahedronSignedVolume=function(a,b,c){return OV.DotVector3D(a,OV.CrossVector3D(b,c))/6};OV.CalculateVolume=function(a){let b=0;a.EnumerateTriangleVertices((c,d,e)=>{b+=OV.GetTetrahedronSignedVolume(c,d,e)});return b};
OV.CalculateSurfaceArea=function(a){let b=0;a.EnumerateTriangleVertices((c,d,e)=>{b+=OV.GetTriangleArea(c,d,e)});return b};OV.GeneratorParams=class{constructor(){this.material=this.name=null}SetName(a){this.name=a;return this}SetMaterial(a){this.material=a;return this}};
OV.Generator=class{constructor(a){this.params=a||new OV.GeneratorParams;this.mesh=new OV.Mesh;null!==this.params.name&&this.mesh.SetName(this.params.name);this.curve=null}GetMesh(){return this.mesh}AddVertex(a,b,c){a=new OV.Coord3D(a,b,c);return this.mesh.AddVertex(a)}AddVertices(a){let b=[];for(let c=0;c<a.length;c++){let d=a[c];b.push(this.AddVertex(d.x,d.y,d.z))}return b}SetCurve(a){this.curve=a}ResetCurve(){this.curve=null}AddTriangle(a,b,c){a=new OV.Triangle(a,b,c);null!==this.params.material&&
(a.mat=this.params.material);null!==this.curve&&a.SetCurve(this.curve);return this.mesh.AddTriangle(a)}AddTriangleInverted(a,b,c){this.AddTriangle(a,c,b)}AddConvexPolygon(a){for(let b=0;b<a.length-2;b++)this.AddTriangle(a[0],a[b+1],a[b+2])}AddConvexPolygonInverted(a){for(let b=0;b<a.length-2;b++)this.AddTriangleInverted(a[0],a[b+1],a[b+2])}};
OV.GeneratorHelper=class{constructor(a){this.generator=a}GenerateExtrude(a,b,c){let d=[],e=[];for(let f=0;f<a.length;f++){const g=a[f];e.push(this.generator.AddVertex(g.x,g.y,0));d.push(this.generator.AddVertex(g.x,g.y,b))}this.generator.SetCurve(c);this.GenerateSurfaceBetweenPolygons(e,d);this.generator.ResetCurve();this.generator.AddConvexPolygonInverted(e);this.generator.AddConvexPolygon(d)}GenerateSurfaceBetweenPolygons(a,b){if(a.length===b.length){var c=a.length;for(let d=0;d<c;d++){const e=
d,f=d<c-1?e+1:0;this.generator.AddConvexPolygon([a[e],a[f],b[f],b[e]])}}}GenerateTriangleFan(a,b){const c=a.length;for(let d=0;d<c;d++){const e=d;this.generator.AddTriangle(b,a[e],a[d<c-1?e+1:0])}}};OV.GenerateCuboid=function(a,b,c,d){a=new OV.Generator(a);b=[new OV.Coord2D(0,0),new OV.Coord2D(b,0),new OV.Coord2D(b,c),new OV.Coord2D(0,c)];(new OV.GeneratorHelper(a)).GenerateExtrude(b,d,null);return a.GetMesh()};
OV.GenerateCylinder=function(a,b,c,d,e){if(3>d)return null;a=new OV.Generator(a);let f=[];const g=2*Math.PI/d;for(let k=0;k<d;k++){var h=k*g;h=new OV.Coord2D(b*Math.cos(h),b*Math.sin(h));f.push(h)}(new OV.GeneratorHelper(a)).GenerateExtrude(f,c,e?1:null);return a.GetMesh()};
OV.GenerateSphere=function(a,b,c,d){if(3>c)return null;a=new OV.Generator(a);let e=new OV.GeneratorHelper(a);a.SetCurve(d?1:null);d=[];let f=c+1;const g=Math.PI/c,h=2*Math.PI/c;for(let l=1;l<f-1;l++){let m=[],n=l*g;for(let r=0;r<c;r++){var k=-(r*h);k=new OV.Coord3D(b*Math.sin(n)*Math.cos(k),b*Math.sin(n)*Math.sin(k),b*Math.cos(n));m.push(a.AddVertex(k.x,k.y,k.z))}1<l&&e.GenerateSurfaceBetweenPolygons(d[d.length-1],m);d.push(m)}c=a.AddVertex(0,0,b);b=a.AddVertex(0,0,-b);e.GenerateTriangleFan(d[0].slice().reverse(),
c);e.GenerateTriangleFan(d[d.length-1],b);a.ResetCurve();return a.GetMesh()};
OV.GeneratePlatonicSolid=function(a,b,c){function d(e,f,g,h,k){g=new OV.Coord3D(g,h,k);g.MultiplyScalar(f/g.Length());e.AddVertex(g.x,g.y,g.z)}if(OV.IsZero(c))return null;a=new OV.Generator(a);if("tetrahedron"===b)d(a,c,1,1,1),d(a,c,-1,-1,1),d(a,c,-1,1,-1),d(a,c,1,-1,-1),a.AddTriangle(0,1,3),a.AddTriangle(0,2,1),a.AddTriangle(0,3,2),a.AddTriangle(1,2,3);else if("hexahedron"===b)d(a,c,1,1,1),d(a,c,1,1,-1),d(a,c,1,-1,1),d(a,c,1,-1,-1),d(a,c,-1,1,1),d(a,c,-1,1,-1),d(a,c,-1,-1,1),d(a,c,-1,-1,-1),a.AddConvexPolygon([0,
1,5,4]),a.AddConvexPolygon([0,2,3,1]),a.AddConvexPolygon([0,4,6,2]),a.AddConvexPolygon([1,3,7,5]),a.AddConvexPolygon([2,6,7,3]),a.AddConvexPolygon([4,5,7,6]);else if("octahedron"===b)d(a,c,1,0,0),d(a,c,-1,0,0),d(a,c,0,1,0),d(a,c,0,-1,0),d(a,c,0,0,1),d(a,c,0,0,-1),a.AddTriangle(0,2,4),a.AddTriangle(0,3,5),a.AddTriangle(0,4,3),a.AddTriangle(0,5,2),a.AddTriangle(1,2,5),a.AddTriangle(1,3,4),a.AddTriangle(1,4,2),a.AddTriangle(1,5,3);else if("dodecahedron"===b){b=(1+Math.sqrt(5))/2;let e=1/b;d(a,c,1,1,
1);d(a,c,1,1,-1);d(a,c,1,-1,1);d(a,c,-1,1,1);d(a,c,1,-1,-1);d(a,c,-1,1,-1);d(a,c,-1,-1,1);d(a,c,-1,-1,-1);d(a,c,0,+e,+b);d(a,c,0,+e,-b);d(a,c,0,-e,+b);d(a,c,0,-e,-b);d(a,c,+e,+b,0);d(a,c,+e,-b,0);d(a,c,-e,+b,0);d(a,c,-e,-b,0);d(a,c,+b,0,+e);d(a,c,-b,0,+e);d(a,c,+b,0,-e);d(a,c,-b,0,-e);a.AddConvexPolygon([0,8,10,2,16]);a.AddConvexPolygon([0,16,18,1,12]);a.AddConvexPolygon([0,12,14,3,8]);a.AddConvexPolygon([1,9,5,14,12]);a.AddConvexPolygon([1,18,4,11,9]);a.AddConvexPolygon([2,10,6,15,13]);a.AddConvexPolygon([2,
13,4,18,16]);a.AddConvexPolygon([3,14,5,19,17]);a.AddConvexPolygon([3,17,6,10,8]);a.AddConvexPolygon([4,13,15,7,11]);a.AddConvexPolygon([5,9,11,7,19]);a.AddConvexPolygon([6,17,19,7,15])}else"icosahedron"===b&&(b=(1+Math.sqrt(5))/2,d(a,c,0,1,+b),d(a,c,0,1,-b),d(a,c,0,-1,+b),d(a,c,0,-1,-b),d(a,c,1,+b,0),d(a,c,1,-b,0),d(a,c,-1,+b,0),d(a,c,-1,-b,0),d(a,c,+b,0,1),d(a,c,+b,0,-1),d(a,c,-b,0,1),d(a,c,-b,0,-1),a.AddTriangle(0,2,8),a.AddTriangle(0,4,6),a.AddTriangle(0,6,10),a.AddTriangle(0,8,4),a.AddTriangle(0,
10,2),a.AddTriangle(1,3,11),a.AddTriangle(1,4,9),a.AddTriangle(1,6,4),a.AddTriangle(1,9,3),a.AddTriangle(1,11,6),a.AddTriangle(2,5,8),a.AddTriangle(2,7,5),a.AddTriangle(2,10,7),a.AddTriangle(3,5,7),a.AddTriangle(3,7,11),a.AddTriangle(3,9,5),a.AddTriangle(4,8,9),a.AddTriangle(5,9,8),a.AddTriangle(6,11,10),a.AddTriangle(7,10,11));return a.GetMesh()};OV.NameFromLine=function(a,b,c){a=a.substr(b);c=a.indexOf(c);-1!==c&&(a=a.substr(0,c));return a.trim()};OV.ParametersFromLine=function(a,b){null!==b&&(b=a.indexOf(b),-1!==b&&(a=a.substr(0,b).trim()));return a.split(/\s+/u)};OV.ReadLines=function(a,b){var c=0;let d=a.indexOf("\n",c);for(;-1!==d;){var e=a.substr(c,d-c);c=b;e=e.trim();0<e.length&&c(e);c=d+1;d=a.indexOf("\n",c)}a=a.substr(c).trim();0<a.length&&b(a)};OV.IsPowerOfTwo=function(a){return 0===(a&a-1)};
OV.NextPowerOfTwo=function(a){return OV.IsPowerOfTwo(a)?a:parseInt(Math.pow(2,Math.ceil(Math.log(a)/Math.log(2))),10)};OV.UpdateMaterialTransparency=function(a){a.transparent=!1;OV.IsLower(a.opacity,1)&&(a.transparent=!0)};OV.ImporterBase=class{constructor(){this.message=this.error=this.model=this.callbacks=this.extension=this.name=null}Import(a,b,c,d){this.Clear();this.name=a;this.extension=b;this.callbacks=d;this.model=new OV.Model;this.error=!1;this.message=null;this.ResetContent();this.ImportContent(c,()=>{this.CreateResult(d)})}Clear(){this.message=this.error=this.model=this.callbacks=this.extension=this.name=null;this.ClearContent()}CreateResult(a){if(this.error)a.onError();else OV.IsModelEmpty(this.model)?(this.error=
!0,a.onError()):(OV.FinalizeModel(this.model,{getDefaultMaterialColor:this.callbacks.getDefaultMaterialColor}),a.onSuccess());a.onComplete()}CanImportExtension(a){return!1}GetUpDirection(){return OV.Direction.Z}ClearContent(){}ResetContent(){}ImportContent(a,b){}GetModel(){return this.model}SetError(a){this.error=!0;void 0!==a&&null!==a&&(this.message=a)}WasError(){return this.error}GetErrorMessage(){return this.message}};OV.ObjMeshConverter=class{constructor(a){this.mesh=a;this.globalToMeshVertices=new Map;this.globalToMeshNormals=new Map;this.globalToMeshUvs=new Map}AddVertex(a,b){return this.GetLocalIndex(a,b,this.globalToMeshVertices,c=>this.mesh.AddVertex(new OV.Coord3D(c.x,c.y,c.z)))}AddNormal(a,b){return this.GetLocalIndex(a,b,this.globalToMeshNormals,c=>this.mesh.AddNormal(new OV.Coord3D(c.x,c.y,c.z)))}AddUV(a,b){return this.GetLocalIndex(a,b,this.globalToMeshUvs,c=>this.mesh.AddTextureUV(new OV.Coord2D(c.x,
c.y)))}AddTriangle(a){this.mesh.AddTriangle(a)}GetLocalIndex(a,b,c,d){if(isNaN(a)||0>a||a>=b.length)return null;if(c.has(a))return c.get(a);b=d(b[a]);c.set(a,b);return b}};
OV.ImporterObj=class extends OV.ImporterBase{constructor(){super()}CanImportExtension(a){return"obj"===a}GetUpDirection(){return OV.Direction.Y}ClearContent(){this.materialNameToIndex=this.meshNameToConverter=this.currentMaterialIndex=this.currentMaterial=this.currentMeshConverter=this.globalUvs=this.globalNormals=this.globalVertices=null}ResetContent(){this.globalVertices=[];this.globalNormals=[];this.globalUvs=[];this.currentMaterialIndex=this.currentMaterial=this.currentMeshConverter=null;this.meshNameToConverter=
new Map;this.materialNameToIndex=new Map}ImportContent(a,b){a=OV.ArrayBufferToUtf8String(a);OV.ReadLines(a,c=>{this.WasError()||this.ProcessLine(c)});b()}ProcessLine(a){if("#"!==a[0]){var b=OV.ParametersFromLine(a,"#");if(0!==b.length){var c=b[0].toLowerCase();b.shift();this.ProcessMeshParameter(c,b,a)||this.ProcessMaterialParameter(c,b,a)}}}AddNewMesh(a){if(this.meshNameToConverter.has(a))this.currentMeshConverter=this.meshNameToConverter.get(a);else{let b=new OV.Mesh;b.SetName(a);this.model.AddMeshToRootNode(b);
this.currentMeshConverter=new OV.ObjMeshConverter(b);this.meshNameToConverter.set(a,this.currentMeshConverter)}}ProcessMeshParameter(a,b,c){if("g"===a||"o"===a){if(0===b.length)return!0;a=OV.NameFromLine(c,a.length,"#");this.AddNewMesh(a);return!0}if("v"===a){if(3>b.length)return!0;this.globalVertices.push(new OV.Coord3D(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2])));return!0}if("vn"===a){if(3>b.length)return!0;this.globalNormals.push(new OV.Coord3D(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2])));
return!0}if("vt"===a){if(2>b.length)return!0;this.globalUvs.push(new OV.Coord2D(parseFloat(b[0]),parseFloat(b[1])));return!0}if("f"===a){if(3>b.length)return!0;this.ProcessFace(b);return!0}return!1}ProcessMaterialParameter(a,b,c){function d(e,f,g){let h=new OV.TextureMap;e=OV.NameFromLine(f,e.length,"#");g=g.getTextureBuffer(e);h.name=e;null!==g&&(h.url=g.url,h.buffer=g.buffer);return h}if("newmtl"===a){if(0===b.length)return!0;b=new OV.PhongMaterial;a=OV.NameFromLine(c,a.length,"#");c=this.model.AddMaterial(b);
b.name=a;this.currentMaterial=b;this.materialNameToIndex.set(a,c);return!0}if("usemtl"===a){if(0===b.length)return!0;b=OV.NameFromLine(c,a.length,"#");this.materialNameToIndex.has(b)&&(this.currentMaterialIndex=this.materialNameToIndex.get(b));return!0}if("mtllib"===a){if(0===b.length)return!0;b=OV.NameFromLine(c,a.length,"#");b=this.callbacks.getFileBuffer(b);null!==b&&(b=OV.ArrayBufferToUtf8String(b),OV.ReadLines(b,e=>{this.WasError()||this.ProcessLine(e)}));return!0}if("map_kd"===a){if(null===
this.currentMaterial||0===b.length)return!0;this.currentMaterial.diffuseMap=d(a,c,this.callbacks);OV.UpdateMaterialTransparency(this.currentMaterial);return!0}if("map_ks"===a){if(null===this.currentMaterial||0===b.length)return!0;this.currentMaterial.specularMap=d(a,c,this.callbacks);return!0}if("map_bump"===a||"bump"===a){if(null===this.currentMaterial||0===b.length)return!0;this.currentMaterial.bumpMap=d(a,c,this.callbacks);return!0}if("ka"===a){if(null===this.currentMaterial||3>b.length)return!0;
this.currentMaterial.ambient=OV.ColorFromFloatComponents(b[0],b[1],b[2]);return!0}if("kd"===a){if(null===this.currentMaterial||3>b.length)return!0;this.currentMaterial.color=OV.ColorFromFloatComponents(b[0],b[1],b[2]);return!0}if("ks"===a){if(null===this.currentMaterial||3>b.length)return!0;this.currentMaterial.specular=OV.ColorFromFloatComponents(b[0],b[1],b[2]);return!0}if("ns"===a){if(null===this.currentMaterial||1>b.length)return!0;this.currentMaterial.shininess=parseFloat(b[0])/1E3;return!0}if("tr"===
a){if(null===this.currentMaterial||1>b.length)return!0;this.currentMaterial.opacity=1-parseFloat(b[0]);OV.UpdateMaterialTransparency(this.currentMaterial);return!0}if("d"===a){if(null===this.currentMaterial||1>b.length)return!0;this.currentMaterial.opacity=parseFloat(b[0]);OV.UpdateMaterialTransparency(this.currentMaterial);return!0}return!1}ProcessFace(a){function b(l,m){return 0<l?l-1:m+l}let c=[],d=[],e=[];for(var f=0;f<a.length;f++){var g=a[f].split("/");c.push(b(parseInt(g[0],10),this.globalVertices.length));
1<g.length&&0<g[1].length&&e.push(b(parseInt(g[1],10),this.globalUvs.length));2<g.length&&0<g[2].length&&d.push(b(parseInt(g[2],10),this.globalNormals.length))}null===this.currentMeshConverter&&this.AddNewMesh("");for(a=0;a<c.length-2;a++){f=this.currentMeshConverter.AddVertex(c[0],this.globalVertices);g=this.currentMeshConverter.AddVertex(c[a+1],this.globalVertices);var h=this.currentMeshConverter.AddVertex(c[a+2],this.globalVertices);if(null===f||null===g||null===h){this.SetError("Invalid vertex index.");
break}f=new OV.Triangle(f,g,h);if(d.length===c.length){g=this.currentMeshConverter.AddNormal(d[0],this.globalNormals);h=this.currentMeshConverter.AddNormal(d[a+1],this.globalNormals);var k=this.currentMeshConverter.AddNormal(d[a+2],this.globalNormals);if(null===g||null===h||null===k){this.SetError("Invalid normal index.");break}f.SetNormals(g,h,k)}if(e.length===c.length){g=this.currentMeshConverter.AddUV(e[0],this.globalUvs);h=this.currentMeshConverter.AddUV(e[a+1],this.globalUvs);k=this.currentMeshConverter.AddUV(e[a+
2],this.globalUvs);if(null===g||null===h||null===k){this.SetError("Invalid uv index.");break}f.SetTextureUVs(g,h,k)}null!==this.currentMaterialIndex&&(f.mat=this.currentMaterialIndex);this.currentMeshConverter.AddTriangle(f)}}};OV.ImporterStl=class extends OV.ImporterBase{constructor(){super()}CanImportExtension(a){return"stl"===a}GetUpDirection(){return OV.Direction.Z}ClearContent(){this.triangle=this.mesh=null}ResetContent(){this.mesh=new OV.Mesh;this.model.AddMeshToRootNode(this.mesh);this.triangle=null}ImportContent(a,b){this.IsBinaryStlFile(a)?this.ProcessBinary(a):(a=OV.ArrayBufferToUtf8String(a),OV.ReadLines(a,c=>{this.WasError()||this.ProcessLine(c)}));b()}IsBinaryStlFile(a){let b=a.byteLength;if(84>b)return!1;a=
new OV.BinaryReader(a,!0);a.Skip(80);a=a.ReadUnsignedInteger32();return b!==50*a+84?!1:!0}ProcessLine(a){if("#"!==a[0]){var b=OV.ParametersFromLine(a,"#");if(0!==b.length){var c=b[0];"solid"===c?1<b.length&&(a=OV.NameFromLine(a,c.length,"#"),this.mesh.SetName(a)):"facet"===c?(this.triangle=new OV.Triangle(-1,-1,-1),5<=b.length&&"normal"===b[1]&&(a=new OV.Coord3D(parseFloat(b[2]),parseFloat(b[3]),parseFloat(b[4])),OV.IsPositive(a.Length())&&(a=this.mesh.AddNormal(a),this.triangle.SetNormals(a,a,a)))):
"vertex"===c&&null!==this.triangle?4<=b.length&&(a=this.mesh.AddVertex(new OV.Coord3D(parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3]))),-1===this.triangle.v0?this.triangle.v0=a:-1===this.triangle.v1?this.triangle.v1=a:-1===this.triangle.v2&&(this.triangle.v2=a)):"endfacet"===c&&null!==this.triangle&&(-1!==this.triangle.v0&&-1!==this.triangle.v1&&null!==this.triangle.v2&&this.mesh.AddTriangle(this.triangle),this.triangle=null)}}}ProcessBinary(a){function b(g){let h=new OV.Coord3D;h.x=g.ReadFloat32();
h.y=g.ReadFloat32();h.z=g.ReadFloat32();return h}function c(g,h){h=b(h);return g.AddVertex(h)}a=new OV.BinaryReader(a,!0);a.Skip(80);let d=a.ReadUnsignedInteger32();for(let g=0;g<d;g++){var e=b(a),f=c(this.mesh,a);let h=c(this.mesh,a),k=c(this.mesh,a);a.Skip(2);f=new OV.Triangle(f,h,k);OV.IsPositive(e.Length())&&(e=this.mesh.AddNormal(e),f.SetNormals(e,e,e));this.mesh.AddTriangle(f)}}};OV.ImporterOff=class extends OV.ImporterBase{constructor(){super()}CanImportExtension(a){return"off"===a}GetUpDirection(){return OV.Direction.Y}ClearContent(){this.status=this.mesh=null}ResetContent(){this.mesh=new OV.Mesh;this.model.AddMeshToRootNode(this.mesh);this.status={vertexCount:0,faceCount:0,foundVertex:0,foundFace:0}}ImportContent(a,b){a=OV.ArrayBufferToUtf8String(a);OV.ReadLines(a,c=>{this.WasError()||this.ProcessLine(c)});b()}ProcessLine(a){if("#"!==a[0]&&(a=OV.ParametersFromLine(a,"#"),
0!==a.length&&"OFF"!==a[0]))if(0===this.status.vertexCount&&0===this.status.faceCount)1<a.length&&(this.status.vertexCount=parseInt(a[0],10),this.status.faceCount=parseInt(a[1],10));else if(this.status.foundVertex<this.status.vertexCount)3<=a.length&&(this.mesh.AddVertex(new OV.Coord3D(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]))),this.status.foundVertex+=1);else if(this.status.foundFace<this.status.faceCount&&4<=a.length){let c=parseInt(a[0],10);if(!(a.length<c+1)){for(let d=0;d<c-2;d++){var b=
parseInt(a[1]);let e=parseInt(a[d+2]),f=parseInt(a[d+3]);b=new OV.Triangle(b,e,f);this.mesh.AddTriangle(b)}this.status.foundFace+=1}}}};OV.PlyHeaderCheckResult={Ok:1,NoVertices:2,NoFaces:3,UnknownError:4};
OV.PlyHeader=class{constructor(){this.format=null;this.elements=[]}SetFormat(a){this.format=a}AddElement(a,b){this.elements.push({name:a,count:b,format:[]})}GetElements(){return this.elements}AddSingleFormat(a,b){this.elements[this.elements.length-1].format.push({name:b,isSingle:!0,elemType:a})}AddListFormat(a,b,c){this.elements[this.elements.length-1].format.push({name:c,isSingle:!1,countType:a,elemType:b})}GetElement(a){for(let b=0;b<this.elements.length;b++){let c=this.elements[b];if(c.name===
a)return c}return null}Check(){var a=this.GetElement("vertex");if(null===a||0===a.length||3>a.format.length)return OV.PlyHeaderCheckResult.NoVertices;a=this.GetElement("face");if("ascii"===this.format){if(null===a||0===a.count||0>a.format.length)return OV.PlyHeaderCheckResult.NoFaces}else if("binary_little_endian"===this.format||"binary_big_endian"===this.format){var b=this.GetElement("tristrips");b=null!==b&&0<b.count&&0<b.format.length;if(!(null!==a&&0<a.count&&0<a.format.length||b))return OV.PlyHeaderCheckResult.NoFaces}else return OV.PlyHeaderCheckResult.UnknownError;
return OV.PlyHeaderCheckResult.Ok}};
OV.PlyMaterialHandler=class{constructor(a){this.model=a;this.colorToMaterial=new Map}GetMaterialIndexByColor(a){let b="Color "+OV.IntegerToHexString(a[0])+OV.IntegerToHexString(a[1])+OV.IntegerToHexString(a[2])+OV.IntegerToHexString(a[3]);if(this.colorToMaterial.has(b))return this.colorToMaterial.get(b);let c=new OV.PhongMaterial;c.name=b;c.color=new OV.Color(a[0],a[1],a[2]);c.opacity=a[3]/255;OV.UpdateMaterialTransparency(c);a=this.model.AddMaterial(c);this.colorToMaterial.set(b,a);return a}};
OV.ImporterPly=class extends OV.ImporterBase{constructor(){super()}CanImportExtension(a){return"ply"===a}GetUpDirection(){return OV.Direction.Y}ClearContent(){this.mesh=null}ResetContent(){this.mesh=new OV.Mesh;this.model.AddMeshToRootNode(this.mesh)}ImportContent(a,b){let c=this.GetHeaderContent(a),d=this.ReadHeader(c),e=d.Check();e===OV.PlyHeaderCheckResult.Ok?"ascii"===d.format?(a=OV.ArrayBufferToUtf8String(a),a=a.substr(c.length),this.ReadAsciiContent(d,a)):"binary_little_endian"!==d.format&&
"binary_big_endian"!==d.format||this.ReadBinaryContent(d,a,c.length):e===OV.PlyHeaderCheckResult.NoVertices?this.SetError("The model contains no vertices."):e===OV.PlyHeaderCheckResult.NoFaces?this.SetError("The model contains no faces."):this.SetError("Invalid header information.");b()}GetHeaderContent(a){let b="",c=new Uint8Array(a),d;for(d=0;d<a.byteLength&&(b+=String.fromCharCode(c[d]),!b.endsWith("end_header"));d++);for(d+=1;d<a.byteLength;){let e=String.fromCharCode(c[d]);b+=e;d+=1;if("\n"===
e)break}return b}ReadHeader(a){let b=new OV.PlyHeader;OV.ReadLines(a,c=>{c=OV.ParametersFromLine(c,null);0!==c.length&&"comment"!==c[0]&&"ply"!==c[0]&&("format"===c[0]&&2<=c.length?b.SetFormat(c[1]):"element"===c[0]&&3<=c.length?b.AddElement(c[1],parseInt(c[2],10)):"property"===c[0]&&3<=c.length&&("list"===c[1]&&5<=c.length?b.AddListFormat(c[2],c[3],c[4]):b.AddSingleFormat(c[1],c[2])))});return b}ReadAsciiContent(a,b){let c=a.GetElement("vertex"),d=a.GetElement("face"),e=0,f=0;OV.ReadLines(b,g=>{if(!this.WasError()&&
(g=OV.ParametersFromLine(g,null),0!==g.length&&"comment"!==g[0]))if(e<c.count)3<=g.length&&(this.mesh.AddVertex(new OV.Coord3D(parseFloat(g[0]),parseFloat(g[1]),parseFloat(g[2]))),e+=1);else if(null!==d&&f<d.count&&4<=g.length){let k=parseInt(g[0],10);if(!(g.length<k+1)){for(let l=0;l<k-2;l++){var h=parseInt(g[1]);let m=parseInt(g[l+2]),n=parseInt(g[l+3]);h=new OV.Triangle(h,m,n);this.mesh.AddTriangle(h)}f+=1}}})}ReadBinaryContent(a,b,c){function d(p,u){function v(y,z){return"char"===z||"int8"===
z?y.ReadCharacter8():"uchar"===z||"uint8"===z?y.ReadUnsignedCharacter8():"short"===z||"int16"===z?y.ReadInteger16():"ushort"===z||"uint16"===z?y.ReadUnsignedInteger16():"int"===z||"int32"===z?y.ReadInteger32():"uint"===z||"uint32"===z?y.ReadUnsignedInteger32():"float"===z||"float32"===z?y.ReadFloat32():"double"===z||"double64"===z?y.ReadDouble64():null}if(u.isSingle)return v(p,u.elemType);let w=[],x=v(p,u.countType);for(let y=0;y<x;y++)w.push(v(p,u.elemType));return w}function e(p,u,v){for(;v<u.length;v++)d(p,
u[v])}function f(p,u,v){let w=null,x=null,y=null,z=255;for(;v<u.length;v++){let A=u[v],G=d(p,A);"red"===A.name?w=G:"green"===A.name?x=G:"blue"===A.name?y=G:"alpha"===A.name&&(z=G)}return null!==w&&null!==x&&null!==y?[w,x,y,z]:null}let g=null;if("binary_little_endian"===a.format)g=new OV.BinaryReader(b,!0);else if("binary_big_endian"===a.format)g=new OV.BinaryReader(b,!1);else return;g.Skip(c);b=new OV.PlyMaterialHandler(this.model);a=a.GetElements();for(c=0;c<a.length;c++){let p=a[c];if("vertex"===
p.name)for(var h=0;h<p.count;h++){var k=d(g,p.format[0]),l=d(g,p.format[1]),m=d(g,p.format[2]),n=f(g,p.format,3);null!==n&&this.mesh.AddVertexColor(new OV.Color(n[0],n[1],n[2]));this.mesh.AddVertex(new OV.Coord3D(k,l,m))}else if("face"===p.name)for(h=0;h<p.count;h++)for(k=d(g,p.format[0]),l=f(g,p.format,1),m=0;m<k.length-2;m++){n=k[0];var r=k[m+1],q=k[m+2],t=new OV.Triangle(n,r,q);null!==l?t.mat=b.GetMaterialIndexByColor(l):0<this.mesh.VertexColorCount()&&t.SetVertexColors(n,r,q);this.mesh.AddTriangle(t)}else if("tristrips"===
p.name)for(h=0;h<p.count;h++)for(k=d(g,p.format[0]),e(g,p.format,1),l=!0,m=0;m<k.length-2;m++)n=k[m],r=k[m+1],q=k[m+2],-1===q?(m+=2,l=!0):(l||(t=r,r=q,q=t),l=!l,n=new OV.Triangle(n,r,q),this.mesh.AddTriangle(n));else e(g,p.format,0)}}};OV.CHUNK3DS={MAIN3DS:19789,EDIT3DS:15677,EDIT_MATERIAL:45055,MAT_NAME:40960,MAT_AMBIENT:40976,MAT_DIFFUSE:40992,MAT_SPECULAR:41008,MAT_SHININESS:41024,MAT_SHININESS_STRENGTH:41025,MAT_TRANSPARENCY:41040,MAT_COLOR_F:16,MAT_COLOR:17,MAT_LIN_COLOR:18,MAT_LIN_COLOR_F:19,MAT_TEXMAP:41472,MAT_TEXMAP_NAME:41728,MAT_TEXMAP_UOFFSET:41816,MAT_TEXMAP_VOFFSET:41818,MAT_TEXMAP_USCALE:41812,MAT_TEXMAP_VSCALE:41814,MAT_TEXMAP_ROTATION:41820,PERCENTAGE:48,PERCENTAGE_F:49,EDIT_OBJECT:16384,OBJ_TRIMESH:16640,OBJ_LIGHT:17920,
OBJ_CAMERA:18176,TRI_VERTEX:16656,TRI_TEXVERTEX:16704,TRI_FACE:16672,TRI_TRANSFORMATION:16736,TRI_MATERIAL:16688,TRI_SMOOTH:16720,KF3DS:45056,OBJECT_NODE:45058,OBJECT_HIERARCHY:45072,OBJECT_INSTANCE_NAME:45073,OBJECT_PIVOT:45075,OBJECT_POSITION:45088,OBJECT_ROTATION:45089,OBJECT_SCALE:45090,OBJECT_ID:45104};OV.Importer3dsNode=class{constructor(){this.id=-1;this.name="";this.parentId=this.flags=-1;this.instanceName="";this.pivot=[0,0,0];this.positions=[];this.rotations=[];this.scales=[]}};
OV.Importer3dsNodeList=class{constructor(){this.nodes=[];this.nodeIdToNode=new Map}IsEmpty(){return 0===this.nodes.length}AddNode(a){this.nodes.push(a);this.nodeIdToNode.set(a.nodeId,a)}GetNodes(){return this.nodes}};
OV.Importer3ds=class extends OV.ImporterBase{constructor(){super()}CanImportExtension(a){return"3ds"===a}GetUpDirection(){return OV.Direction.Z}ClearContent(){this.nodeList=this.meshNameToIndex=this.materialNameToIndex=null}ResetContent(){this.materialNameToIndex=new Map;this.meshNameToIndex=new Map;this.nodeList=new OV.Importer3dsNodeList}ImportContent(a,b){this.ProcessBinary(a);b()}ProcessBinary(a){let b=new OV.BinaryReader(a,!0);a=b.GetByteLength();this.ReadChunks(b,a,(c,d)=>{c===OV.CHUNK3DS.MAIN3DS?
this.ReadMainChunk(b,d):this.SkipChunk(b,d)})}ReadMainChunk(a,b){b=this.GetChunkEnd(a,b);this.ReadChunks(a,b,(c,d)=>{c===OV.CHUNK3DS.EDIT3DS?this.ReadEditorChunk(a,d):c===OV.CHUNK3DS.KF3DS?this.ReadKeyFrameChunk(a,d):this.SkipChunk(a,d)});this.BuildNodeHierarchy()}ReadEditorChunk(a,b){b=this.GetChunkEnd(a,b);this.ReadChunks(a,b,(c,d)=>{c===OV.CHUNK3DS.EDIT_MATERIAL?this.ReadMaterialChunk(a,d):c===OV.CHUNK3DS.EDIT_OBJECT?this.ReadObjectChunk(a,d):this.SkipChunk(a,d)})}ReadMaterialChunk(a,b){let c=
new OV.PhongMaterial;b=this.GetChunkEnd(a,b);let d=null,e=null;this.ReadChunks(a,b,(f,g)=>{f===OV.CHUNK3DS.MAT_NAME?c.name=this.ReadName(a):f===OV.CHUNK3DS.MAT_AMBIENT?c.ambient=this.ReadColorChunk(a,g):f===OV.CHUNK3DS.MAT_DIFFUSE?c.color=this.ReadColorChunk(a,g):f===OV.CHUNK3DS.MAT_SPECULAR?c.specular=this.ReadColorChunk(a,g):f===OV.CHUNK3DS.MAT_SHININESS?d=this.ReadPercentageChunk(a,g):f===OV.CHUNK3DS.MAT_SHININESS_STRENGTH?e=this.ReadPercentageChunk(a,g):f===OV.CHUNK3DS.MAT_TRANSPARENCY?(c.opacity=
1-this.ReadPercentageChunk(a,g),OV.UpdateMaterialTransparency(c)):f===OV.CHUNK3DS.MAT_TEXMAP?(c.diffuseMap=this.ReadTextureMapChunk(a,g),OV.UpdateMaterialTransparency(c)):this.SkipChunk(a,g)});null!==d&&null!==e&&(c.shininess=d*e/10);b=this.model.AddMaterial(c);this.materialNameToIndex.set(c.name,b)}ReadTextureMapChunk(a,b){let c=new OV.TextureMap;b=this.GetChunkEnd(a,b);this.ReadChunks(a,b,(d,e)=>{d===OV.CHUNK3DS.MAT_TEXMAP_NAME?(d=this.ReadName(a),e=this.callbacks.getTextureBuffer(d),c.name=d,null!==
e&&(c.url=e.url,c.buffer=e.buffer)):d===OV.CHUNK3DS.MAT_TEXMAP_UOFFSET?c.offset.x=a.ReadFloat32():d===OV.CHUNK3DS.MAT_TEXMAP_VOFFSET?c.offset.y=a.ReadFloat32():d===OV.CHUNK3DS.MAT_TEXMAP_USCALE?c.scale.x=a.ReadFloat32():d===OV.CHUNK3DS.MAT_TEXMAP_VSCALE?c.scale.y=a.ReadFloat32():d===OV.CHUNK3DS.MAT_TEXMAP_ROTATION?c.rotation=a.ReadFloat32()*OV.DegRad:this.SkipChunk(a,e)});return c}ReadColorChunk(a,b){let c=new OV.Color(0,0,0);b=this.GetChunkEnd(a,b);let d=!1;this.ReadChunks(a,b,(e,f)=>{e===OV.CHUNK3DS.MAT_COLOR?
d||(c.r=a.ReadUnsignedCharacter8(),c.g=a.ReadUnsignedCharacter8(),c.b=a.ReadUnsignedCharacter8()):e===OV.CHUNK3DS.MAT_LIN_COLOR?(c.r=a.ReadUnsignedCharacter8(),c.g=a.ReadUnsignedCharacter8(),c.b=a.ReadUnsignedCharacter8(),d=!0):e===OV.CHUNK3DS.MAT_COLOR_F?d||(c.r=OV.ColorComponentFromFloat(a.ReadFloat32()),c.g=OV.ColorComponentFromFloat(a.ReadFloat32()),c.b=OV.ColorComponentFromFloat(a.ReadFloat32())):e===OV.CHUNK3DS.MAT_LIN_COLOR_F?(c.r=OV.ColorComponentFromFloat(a.ReadFloat32()),c.g=OV.ColorComponentFromFloat(a.ReadFloat32()),
c.b=OV.ColorComponentFromFloat(a.ReadFloat32()),d=!0):this.SkipChunk(a,f)});return c}ReadPercentageChunk(a,b){let c=0;b=this.GetChunkEnd(a,b);this.ReadChunks(a,b,(d,e)=>{d===OV.CHUNK3DS.PERCENTAGE?c=a.ReadUnsignedInteger16()/100:d===OV.CHUNK3DS.PERCENTAGE_F?c=a.ReadFloat32():this.SkipChunk(a,e)});return c}ReadObjectChunk(a,b){b=this.GetChunkEnd(a,b);let c=this.ReadName(a);this.ReadChunks(a,b,(d,e)=>{d===OV.CHUNK3DS.OBJ_TRIMESH?this.ReadMeshChunk(a,e,c):this.SkipChunk(a,e)})}ReadMeshChunk(a,b,c){let d=
new OV.Mesh;d.SetName(c);b=this.GetChunkEnd(a,b);let e=null;this.ReadChunks(a,b,(f,g)=>{f===OV.CHUNK3DS.TRI_VERTEX?this.ReadVerticesChunk(d,a):f===OV.CHUNK3DS.TRI_TEXVERTEX?this.ReadTextureVerticesChunk(d,a):f===OV.CHUNK3DS.TRI_FACE?this.ReadFacesChunk(d,a,g):f===OV.CHUNK3DS.TRI_TRANSFORMATION?e=this.ReadTransformationChunk(a):this.SkipChunk(a,g)});if(d.VertexCount()===d.TextureUVCount())for(b=0;b<d.TriangleCount();b++)c=d.GetTriangle(b),c.SetTextureUVs(c.v0,c.v1,c.v2);b=new OV.Matrix(e);(function(f,
g){if(g.IsValid()){var h=g.Determinant();(h=OV.IsNegative(h))&&(g=(new OV.Matrix).CreateScale(-1,1,1).MultiplyMatrix(g));g=g.Invert();null!==g&&(g=new OV.Transformation(g),OV.TransformMesh(f,g),h&&OV.FlipMeshTrianglesOrientation(f))}})(d,b);b=this.model.AddMesh(d);this.meshNameToIndex.set(d.GetName(),b)}ReadVerticesChunk(a,b){let c=b.ReadUnsignedInteger16();for(let d=0;d<c;d++){let e=b.ReadFloat32(),f=b.ReadFloat32(),g=b.ReadFloat32();a.AddVertex(new OV.Coord3D(e,f,g))}}ReadTextureVerticesChunk(a,
b){let c=b.ReadUnsignedInteger16();for(let d=0;d<c;d++){let e=b.ReadFloat32(),f=b.ReadFloat32();a.AddTextureUV(new OV.Coord2D(e,f))}}ReadFacesChunk(a,b,c){c=this.GetChunkEnd(b,c);let d=b.ReadUnsignedInteger16();for(let e=0;e<d;e++){let f=b.ReadUnsignedInteger16(),g=b.ReadUnsignedInteger16(),h=b.ReadUnsignedInteger16();b.ReadUnsignedInteger16();a.AddTriangle(new OV.Triangle(f,g,h))}this.ReadChunks(b,c,(e,f)=>{e===OV.CHUNK3DS.TRI_MATERIAL?this.ReadFaceMaterialsChunk(a,b):e===OV.CHUNK3DS.TRI_SMOOTH?
this.ReadFaceSmoothingGroupsChunk(a,d,b):this.SkipChunk(b,f)})}ReadFaceMaterialsChunk(a,b){var c=this.ReadName(b);c=this.materialNameToIndex.get(c);let d=b.ReadUnsignedInteger16();for(let f=0;f<d;f++){var e=b.ReadUnsignedInteger16();e=a.GetTriangle(e);void 0!==c&&(e.mat=c)}}ReadFaceSmoothingGroupsChunk(a,b,c){for(let d=0;d<b;d++){let e=c.ReadUnsignedInteger32();a.GetTriangle(d).curve=e}}ReadTransformationChunk(a){let b=[];for(let c=0;4>c;c++){for(let d=0;3>d;d++)b.push(a.ReadFloat32());3>c?b.push(0):
b.push(1)}return b}ReadKeyFrameChunk(a,b){b=this.GetChunkEnd(a,b);this.ReadChunks(a,b,(c,d)=>{c===OV.CHUNK3DS.OBJECT_NODE?this.ReadObjectNodeChunk(a,d):this.SkipChunk(a,d)})}BuildNodeHierarchy(){let a=this.model.GetRootNode();if(this.nodeList.IsEmpty())for(var b=0;b<this.model.MeshCount();b++)a.AddMeshIndex(b);else{let t=new Map;for(let p of this.nodeList.GetNodes()){let u=new OV.Node;0<p.name.length&&"$$$DUMMY"!==p.name&&(u.SetName(p.name),0<p.instanceName.length&&u.SetName(u.GetName()+" "+p.instanceName));
65535!==p.parentId&&t.has(p.parentId)?t.get(p.parentId).AddChildNode(u):a.AddChildNode(u);t.set(p.id,u);let v=this.meshNameToIndex.has(p.name);b=u;var c=b.SetTransformation,d,e=p,f=v,g=d=new OV.Matrix,h=g.ComposeTRS;var k=OV;var l=k.ArrayToCoord3D;var m=0===e.positions.length?[0,0,0]:e.positions[0];m=l.call(k,m);k=OV;l=k.ArrayToQuaternion;if(0===e.rotations.length)var n=[0,0,0,1];else{n=e.rotations[0];var r=[0,0,0,1],q=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);0<q&&(r=-.5*n[3],q=Math.sin(r)/q,r=[q*
n[0],q*n[1],q*n[2],Math.cos(r)]);n=r}l=l.call(k,n);n=OV;q=n.ArrayToCoord3D;k=0===e.scales.length?[1,1,1]:e.scales[0];h.call(g,m,l,q.call(n,k));f&&(e=e.pivot,d=(new OV.Matrix).CreateTranslation(-e[0],-e[1],-e[2]).MultiplyMatrix(d));d=new OV.Transformation(d);c.call(b,d);v&&(u.SetType(OV.NodeType.MeshNode),u.AddMeshIndex(this.meshNameToIndex.get(p.name)))}}}ReadObjectNodeChunk(a,b){function c(e,f,g){let h=[];f.Skip(10);let k=f.ReadInteger32();for(let l=0;l<k;l++){f.ReadInteger32();0!==f.ReadUnsignedInteger16()&&
f.ReadFloat32();let m;if(g===OV.CHUNK3DS.OBJECT_ROTATION){let n=f.ReadFloat32();m=e.ReadVector(f);m[3]=n}else m=e.ReadVector(f);h.push(m)}return h}let d=new OV.Importer3dsNode;b=this.GetChunkEnd(a,b);this.ReadChunks(a,b,(e,f)=>{e===OV.CHUNK3DS.OBJECT_HIERARCHY?(d.name=this.ReadName(a),d.flags=a.ReadUnsignedInteger32(),d.parentId=a.ReadUnsignedInteger16()):e===OV.CHUNK3DS.OBJECT_INSTANCE_NAME?d.instanceName=this.ReadName(a):e===OV.CHUNK3DS.OBJECT_PIVOT?d.pivot=this.ReadVector(a):e===OV.CHUNK3DS.OBJECT_POSITION?
d.positions=c(this,a,OV.CHUNK3DS.OBJECT_POSITION):e===OV.CHUNK3DS.OBJECT_ROTATION?d.rotations=c(this,a,OV.CHUNK3DS.OBJECT_ROTATION):e===OV.CHUNK3DS.OBJECT_SCALE?d.scales=c(this,a,OV.CHUNK3DS.OBJECT_SCALE):e===OV.CHUNK3DS.OBJECT_ID?d.id=a.ReadUnsignedInteger16():this.SkipChunk(a,f)});this.nodeList.AddNode(d)}ReadName(a){let b="",c,d=0;for(;64>d;){c=a.ReadCharacter8();if(0===c)break;b+=String.fromCharCode(c);d+=1}return b}ReadVector(a){return[a.ReadFloat32(),a.ReadFloat32(),a.ReadFloat32()]}ReadChunks(a,
b,c){for(;a.GetPosition()<=b-6;){let d=a.ReadUnsignedInteger16(),e=a.ReadUnsignedInteger32();c(d,e)}}GetChunkEnd(a,b){return a.GetPosition()+b-6}SkipChunk(a,b){a.Skip(b-6)}};OV.GltfComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};OV.GltfDataType={SCALAR:0,VEC2:1,VEC3:2,VEC4:3,MAT2:4,MAT3:5,MAT4:6};OV.GltfRenderMode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};OV.GltfConstants={GLTF_STRING:1179937895,JSON_CHUNK_TYPE:1313821514,BINARY_CHUNK_TYPE:5130562};OV.GetGltfColor=function(a){return OV.ColorFromFloatComponents(OV.LinearToSRGB(a[0]),OV.LinearToSRGB(a[1]),OV.LinearToSRGB(a[2]))};
OV.GetGltfVertexColor=function(a,b){function c(d,e){e!==OV.GltfComponentType.FLOAT&&(d/=255);return OV.ColorComponentFromFloat(OV.LinearToSRGB(d))}return new OV.Color(c(a[0],b),c(a[1],b),c(a[2],b))};
OV.GltfBufferReader=class{constructor(a){this.reader=new OV.BinaryReader(a,!0);this.sparseReader=this.dataCount=this.byteStride=this.dataType=this.componentType=null}SetComponentType(a){this.componentType=a}SetDataType(a){"SCALAR"===a?this.dataType=OV.GltfDataType.SCALAR:"VEC2"===a?this.dataType=OV.GltfDataType.VEC2:"VEC3"===a?this.dataType=OV.GltfDataType.VEC3:"VEC4"===a?this.dataType=OV.GltfDataType.VEC4:"MAT2"===a?this.dataType=OV.GltfDataType.MAT2:"MAT3"===a?this.dataType=OV.GltfDataType.MAT3:
"MAT4"===a&&(this.dataType=OV.GltfDataType.MAT4)}SetByteStride(a){this.byteStride=a}SetDataCount(a){this.dataCount=a}SetSparseReader(a,b){this.sparseReader={indexReader:a,valueReader:b}}ReadArrayBuffer(a){return this.reader.ReadArrayBuffer(a)}GetDataCount(){return this.dataCount}ReadData(){if(null===this.dataType)return null;if(this.dataType===OV.GltfDataType.SCALAR){var a=this.ReadComponent();this.SkipBytesByStride(1);return a}if(this.dataType===OV.GltfDataType.VEC2){a=this.ReadComponent();var b=
this.ReadComponent();this.SkipBytesByStride(2);return new OV.Coord2D(a,b)}if(this.dataType===OV.GltfDataType.VEC3){a=this.ReadComponent();b=this.ReadComponent();var c=this.ReadComponent();this.SkipBytesByStride(3);return new OV.Coord3D(a,b,c)}if(this.dataType===OV.GltfDataType.VEC4){a=this.ReadComponent();b=this.ReadComponent();c=this.ReadComponent();let d=this.ReadComponent();this.SkipBytesByStride(4);return new OV.Coord4D(a,b,c,d)}return null}EnumerateData(a){if(null===this.sparseReader)for(var b=
0;b<this.dataCount;b++)a(this.ReadData());else{b=[];for(var c=0;c<this.sparseReader.indexReader.GetDataCount();c++){var d=this.sparseReader.indexReader.ReadData(),e=this.sparseReader.valueReader.ReadData();b.push({index:d,value:e})}c=0;for(d=0;d<this.dataCount;d++)e=this.ReadData(),c<b.length&&b[c].index===d?(a(b[c].value),c+=1):a(e)}}SkipBytes(a){this.reader.Skip(a)}ReadComponent(){return null===this.componentType?null:this.componentType===OV.GltfComponentType.BYTE?this.reader.ReadCharacter8():this.componentType===
OV.GltfComponentType.UNSIGNED_BYTE?this.reader.ReadUnsignedCharacter8():this.componentType===OV.GltfComponentType.SHORT?this.reader.ReadInteger16():this.componentType===OV.GltfComponentType.UNSIGNED_SHORT?this.reader.ReadUnsignedInteger16():this.componentType===OV.GltfComponentType.UNSIGNED_INT?this.reader.ReadInteger32():this.componentType===OV.GltfComponentType.FLOAT?this.reader.ReadFloat32():null}SkipBytesByStride(a){null!==this.byteStride&&(a*=this.GetComponentSize(),this.reader.Skip(this.byteStride-
a))}GetComponentSize(){return this.componentType===OV.GltfComponentType.BYTE||this.componentType===OV.GltfComponentType.UNSIGNED_BYTE?1:this.componentType===OV.GltfComponentType.SHORT||this.componentType===OV.GltfComponentType.UNSIGNED_SHORT?2:this.componentType===OV.GltfComponentType.UNSIGNED_INT||this.componentType===OV.GltfComponentType.FLOAT?4:0}};
OV.GltfExtensions=class{constructor(){this.supportedExtensions=["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_texture_transform"];this.draco=null}LoadLibraries(a,b){if(void 0===a)b.onSuccess();else if(null===this.draco&&-1!==a.indexOf("KHR_draco_mesh_compression"))OV.LoadExternalLibrary("loaders/draco_decoder.js").then(()=>{DracoDecoderModule().then(c=>{this.draco=c;b.onSuccess()})}).catch(()=>{b.onError()});else b.onSuccess()}GetUnsupportedExtensions(a){let b=[];if(void 0===
a)return b;for(let c=0;c<a.length;c++){let d=a[c];-1===this.supportedExtensions.indexOf(d)&&b.push(d)}return b}ProcessMaterial(a,b,c){if(void 0===a.extensions)return null;b=a.extensions.KHR_materials_pbrSpecularGlossiness;if(void 0===b)return null;a=new OV.PhongMaterial;var d=b.diffuseFactor;void 0!==d&&(a.color=OV.GetGltfColor(d),a.opacity=d[3]);d=b.diffuseTexture;void 0!==d&&(a.diffuseMap=c(d));d=b.specularFactor;void 0!==d&&(a.specular=OV.GetGltfColor(d));d=b.specularGlossinessTexture;void 0!==
d&&(a.specularMap=c(d));c=b.glossinessFactor;void 0!==c&&(a.shininess=c);return a}ProcessTexture(a,b){void 0!==a.extensions&&(a=a.extensions.KHR_texture_transform,void 0!==a&&(void 0!==a.offset&&(b.offset.x=a.offset[0],b.offset.y=-a.offset[1]),void 0!==a.scale&&(b.scale.x=a.scale[0],b.scale.y=a.scale[1]),void 0!==a.rotation&&(b.rotation=-a.rotation)))}ProcessPrimitive(a,b,c,d){function e(p,u,v,w,x){let y=u.GetAttributeByUniqueId(v,w),z=y.num_components(),A=v.num_points()*z,G=4*A;w=p._malloc(G);u.GetAttributeDataArrayForAllPoints(v,
y,p.DT_FLOAT32,G,w);u=(new Float32Array(p.HEAPF32.buffer,w,A)).slice();if(2===z)for(v=0;v<u.length;v+=2)x(new OV.Coord2D(u[v+0],u[v+1]));else if(3===z)for(v=0;v<u.length;v+=3)x(new OV.Coord3D(u[v+0],u[v+1],u[v+2]));else if(4===z)for(v=0;v<u.length;v+=4)x(new OV.Coord4D(u[v+0],u[v+1],u[v+2],u[v+3]));p._free(w)}if(null===this.draco||void 0===c.extensions||void 0===c.extensions.KHR_draco_mesh_compression)return!1;var f=new this.draco.Decoder,g=new this.draco.DecoderBuffer,h=c.extensions.KHR_draco_mesh_compression;
b=b.bufferViews[h.bufferView];b=a.GetReaderFromBufferView(b).ReadArrayBuffer(b.byteLength);g.Init(new Int8Array(b),b.byteLength);if(f.GetEncodedGeometryType(g)!==this.draco.TRIANGULAR_MESH)return!0;var k=new this.draco.Mesh;if(!f.DecodeBufferToMesh(g,k).ok())return!0;g=void 0!==h.attributes.NORMAL;b=void 0!==h.attributes.TEXCOORD_0;if(void 0===h.attributes.POSITION)return!0;let l=d.VertexCount(),m=d.VertexColorCount(),n=d.NormalCount(),r=d.TextureUVCount();e(this.draco,f,k,h.attributes.POSITION,p=>
{d.AddVertex(p)});g&&e(this.draco,f,k,h.attributes.NORMAL,p=>{d.AddNormal(p)});b&&e(this.draco,f,k,h.attributes.TEXCOORD_0,p=>{p.y=-p.y;d.AddTextureUV(p)});let q=3*k.num_faces(),t=4*q;h=this.draco._malloc(t);f.GetTrianglesUInt32Array(k,t,h);f=(new Uint32Array(this.draco.HEAPU32.buffer,h,q)).slice();for(k=0;k<f.length;k+=3)a.AddTriangle(c,d,f[k],f[k+1],f[k+2],!1,g,b,l,m,n,r);this.draco._free(h);return!0}};
OV.ImporterGltf=class extends OV.ImporterBase{constructor(){super();this.gltfExtensions=new OV.GltfExtensions}CanImportExtension(a){return"gltf"===a||"glb"===a}GetUpDirection(){return OV.Direction.Y}ClearContent(){this.imageIndexToTextureParams=this.bufferContents=null}ResetContent(){this.bufferContents=[];this.imageIndexToTextureParams=new Map}ImportContent(a,b){"gltf"===this.extension?this.ProcessGltf(a,b):"glb"===this.extension&&this.ProcessBinaryGltf(a,b)}ProcessGltf(a,b){a=OV.ArrayBufferToUtf8String(a);
a=JSON.parse(a);if("2.0"!==a.asset.version)this.SetError("Invalid glTF version."),b();else{for(let d=0;d<a.buffers.length;d++){let e=null;var c=a.buffers[d];let f=OV.Base64DataURIToArrayBuffer(c.uri);null!==f?e=f.buffer:(c=this.callbacks.getFileBuffer(c.uri),null!==c&&(e=c));if(null===e){this.SetError("One  of the requested buffers is missing.");b();return}this.bufferContents.push(e)}this.ProcessMainFile(a,b)}}ProcessBinaryGltf(a,b){a=new OV.BinaryReader(a,!0);if(a.ReadUnsignedInteger32()!==OV.GltfConstants.GLTF_STRING)this.SetError("Invalid glTF file."),
b();else if(2!==a.ReadUnsignedInteger32())this.SetError("Invalid glTF version."),b();else if(a.ReadUnsignedInteger32()!==a.GetByteLength())this.SetError("Invalid glTF file."),b();else{for(var c=null;!a.End();){var d=a;let f=d.ReadUnsignedInteger32();var e=d.ReadUnsignedInteger32();d=d.ReadArrayBuffer(f);e===OV.GltfConstants.JSON_CHUNK_TYPE?c=OV.ArrayBufferToUtf8String(d):e===OV.GltfConstants.BINARY_CHUNK_TYPE&&this.bufferContents.push(d)}null!==c&&(a=JSON.parse(c),this.ProcessMainFile(a,b))}}ProcessMainFile(a,
b){let c=this.gltfExtensions.GetUnsupportedExtensions(a.extensionsRequired);0<c.length?(this.SetError("Unsupported extension: "+c.join(", ")+"."),b()):this.gltfExtensions.LoadLibraries(a.extensionsRequired,{onSuccess:()=>{this.ImportModel(a);b()},onError:()=>{this.SetError("Failed to load draco decoder.");b()}})}ImportModel(a){var b=a.materials;if(void 0!==b)for(let c of b)this.ImportMaterial(a,c);b=a.meshes;if(void 0!==b)for(let c of b)this.ImportMesh(a,c);this.ImportNodes(a);this.ImportModelProperties(a)}ImportModelProperties(a){function b(c,
d,e){d=new OV.PropertyGroup(d);for(let f in e)if(Object.prototype.hasOwnProperty.call(e,f)&&"string"===typeof e[f]){const g=new OV.Property(OV.PropertyType.Text,f,e[f]);d.AddProperty(g)}0<d.PropertyCount()&&c.AddPropertyGroup(d);return d}b(this.model,"Asset properties",a.asset);a.asset.extras&&b(this.model,"Extras",a.asset.extras)}GetDefaultScene(a){let b=a.scene||0;return b>=a.scenes.length?null:a.scenes[b]}ImportMaterial(a,b){let c=new OV.PhysicalMaterial;void 0!==b.name&&(c.name=b.name);c.color=
OV.GetGltfColor([1,1,1]);if(void 0!==b.pbrMetallicRoughness){var d=b.pbrMetallicRoughness.baseColorFactor;void 0!==d&&(c.color=OV.GetGltfColor(d),c.opacity=d[3]);d=b.pbrMetallicRoughness.metallicFactor;void 0!==d&&(c.metalness=d);d=b.pbrMetallicRoughness.roughnessFactor;void 0!==d&&(c.roughness=d);d=b.emissiveFactor;void 0!==d&&(c.emissive=OV.GetGltfColor(d));c.diffuseMap=this.ImportTexture(a,b.pbrMetallicRoughness.baseColorTexture);c.metalnessMap=this.ImportTexture(a,b.pbrMetallicRoughness.metallicRoughnessTexture);
c.normalMap=this.ImportTexture(a,b.normalTexture);c.emissiveMap=this.ImportTexture(a,b.emissiveTexture);null!==c.diffuseMap&&(c.multiplyDiffuseMap=!0);d=b.alphaMode;void 0!==d&&("BLEND"===d?c.transparent=!0:"MASK"===d&&(c.transparent=!0,c.alphaTest=b.alphaCutoff||.5))}b=this.gltfExtensions.ProcessMaterial(b,c,e=>this.ImportTexture(a,e));null!==b&&(c=b);this.model.AddMaterial(c)}ImportTexture(a,b){if(void 0===b||null===b)return null;let c=new OV.TextureMap,d=a.textures[b.index].source,e=a.images[d],
f;if(this.imageIndexToTextureParams.has(d))f=this.imageIndexToTextureParams.get(d);else{f={name:null,url:null,buffer:null};var g=d.toString();if(void 0!==e.uri)a=OV.Base64DataURIToArrayBuffer(e.uri),null!==a?(f.name="Embedded_"+g+"."+OV.GetFileExtensionFromMimeType(a.mimeType),f.url=OV.CreateObjectUrlWithMimeType(a.buffer,a.mimeType),f.buffer=a.buffer):(g=this.callbacks.getTextureBuffer(e.uri),f.name=e.uri,null!==g&&(f.url=g.url,f.buffer=g.buffer));else if(void 0!==e.bufferView){a=a.bufferViews[e.bufferView];
let h=this.GetReaderFromBufferView(a);null!==h&&(a=h.ReadArrayBuffer(a.byteLength),f.name="Binary_"+g+"."+OV.GetFileExtensionFromMimeType(e.mimeType),f.url=OV.CreateObjectUrlWithMimeType(a,e.mimeType),f.buffer=a)}this.imageIndexToTextureParams.set(d,f)}c.name=f.name;c.url=f.url;c.buffer=f.buffer;this.gltfExtensions.ProcessTexture(b,c);return c}ImportMesh(a,b){let c=new OV.Mesh;this.model.AddMesh(c);void 0!==b.name&&c.SetName(b.name);for(let d=0;d<b.primitives.length;d++)this.ImportPrimitive(a,b.primitives[d],
c)}ImportPrimitive(a,b,c){if(!this.gltfExtensions.ProcessPrimitive(this,a,b,c)&&void 0!==b.attributes){var d=void 0!==b.attributes.POSITION,e=void 0!==b.attributes.COLOR_0,f=void 0!==b.attributes.NORMAL,g=void 0!==b.attributes.TEXCOORD_0,h=void 0!==b.indices,k=OV.GltfRenderMode.TRIANGLES;void 0!==b.mode&&(k=b.mode);if(k===OV.GltfRenderMode.TRIANGLES||k===OV.GltfRenderMode.TRIANGLE_STRIP||k===OV.GltfRenderMode.TRIANGLE_FAN){var l=c.VertexCount(),m=c.VertexColorCount(),n=c.NormalCount(),r=c.TextureUVCount();
if(d&&(d=this.GetReaderFromAccessor(a,a.accessors[b.attributes.POSITION]),null!==d)){d.EnumerateData(t=>{c.AddVertex(t)});if(e){let t=this.GetReaderFromAccessor(a,a.accessors[b.attributes.COLOR_0]);if(null===t)return;t.EnumerateData(p=>{p=OV.GetGltfVertexColor([p.x,p.y,p.z],t.componentType);c.AddVertexColor(p)})}if(f){d=this.GetReaderFromAccessor(a,a.accessors[b.attributes.NORMAL]);if(null===d)return;d.EnumerateData(t=>{c.AddNormal(t)})}if(g){d=this.GetReaderFromAccessor(a,a.accessors[b.attributes.TEXCOORD_0]);
if(null===d)return;d.EnumerateData(t=>{t.y=-t.y;c.AddTextureUV(t)})}var q=[];if(h){a=this.GetReaderFromAccessor(a,a.accessors[b.indices]);if(null===a)return;a.EnumerateData(t=>{q.push(t)})}else for(a=0;a<c.VertexCount();a++)q.push(a);if(k===OV.GltfRenderMode.TRIANGLES)for(k=0;k<q.length;k+=3)this.AddTriangle(b,c,q[k],q[k+1],q[k+2],e,f,g,l,m,n,r);else if(k===OV.GltfRenderMode.TRIANGLE_STRIP)for(k=0;k<q.length-2;k++){a=q[k];h=q[k+1];d=q[k+2];if(1===k%2){let t=h;h=d;d=t}this.AddTriangle(b,c,a,h,d,e,
f,g,l,m,n,r)}else if(k===OV.GltfRenderMode.TRIANGLE_FAN)for(k=1;k<q.length-1;k++)this.AddTriangle(b,c,q[0],q[k],q[k+1],e,f,g,l,m,n,r)}}}}AddTriangle(a,b,c,d,e,f,g,h,k,l,m,n){k=new OV.Triangle(k+c,k+d,k+e);f&&k.SetVertexColors(l+c,l+d,l+e);g&&k.SetNormals(m+c,m+d,m+e);h&&k.SetTextureUVs(n+c,n+d,n+e);void 0!==a.material&&(k.mat=a.material);b.AddTriangle(k)}ImportNodes(a){let b=this.GetDefaultScene(a);if(null!==b){var c=this.model.GetRootNode();for(let d of b.nodes)this.ImportNode(a,a.nodes[d],c)}}ImportNode(a,
b,c){if(void 0!==b.children||void 0!==b.mesh){var d=new OV.Node;void 0!==b.name&&d.SetName(b.name);var e=d.SetTransformation;var f=(new OV.Matrix).CreateIdentity();if(void 0!==b.matrix)f.Set(b.matrix);else{let g=[0,0,0],h=[0,0,0,1],k=[1,1,1];void 0!==b.translation&&(g=b.translation);void 0!==b.rotation&&(h=b.rotation);void 0!==b.scale&&(k=b.scale);f.ComposeTRS(OV.ArrayToCoord3D(g),OV.ArrayToQuaternion(h),OV.ArrayToCoord3D(k))}f=new OV.Transformation(f);e.call(d,f);c.AddChildNode(d);if(void 0!==b.children)for(let g of b.children)this.ImportNode(a,
a.nodes[g],d);void 0!==b.mesh&&(void 0!==b.children&&0!==b.children.length||d.SetType(OV.NodeType.MeshNode),d.AddMeshIndex(b.mesh))}}GetReaderFromBufferView(a){var b=this.bufferContents[a.buffer||0];if(void 0===b||null===b)return null;b=new OV.GltfBufferReader(b);b.SkipBytes(a.byteOffset||0);a=a.byteStride;void 0!==a&&0!==a&&b.SetByteStride(a);return b}GetReaderFromAccessor(a,b){let c=this.GetReaderFromBufferView(a.bufferViews[b.bufferView||0]);if(null===c)return null;c.SetComponentType(b.componentType);
c.SetDataType(b.type);c.SetDataCount(b.count);c.SkipBytes(b.byteOffset||0);if(void 0!==b.sparse){let d=this.GetReaderFromSparseAccessor(a,b.sparse.indices,b.sparse.indices.componentType,"SCALAR",b.sparse.count);a=this.GetReaderFromSparseAccessor(a,b.sparse.values,b.componentType,b.type,b.sparse.count);null!==d&&null!==a&&c.SetSparseReader(d,a)}return c}GetReaderFromSparseAccessor(a,b,c,d,e){if(void 0===b.bufferView)return null;a=this.GetReaderFromBufferView(a.bufferViews[b.bufferView]);if(null===
a)return null;a.SetComponentType(c);a.SetDataType(d);a.SetDataCount(e);a.SkipBytes(b.byteOffset||0);return a}};OV.ImporterO3dv=class extends OV.ImporterBase{constructor(){super()}CanImportExtension(a){return"o3dv"===a}GetUpDirection(){return OV.Direction.Z}ClearContent(){}ResetContent(){}ImportContent(a,b){a=OV.ArrayBufferToUtf8String(a);a=JSON.parse(a);if(void 0!==a.root){if(void 0!==a.materials)for(var c=0;c<a.materials.length;c++)this.ImportMaterial(a.materials[c]);if(void 0!==a.meshes)for(c=0;c<a.meshes.length;c++)this.ImportMesh(a.meshes[c]);this.ImportNode(a,a.nodes[a.root],this.model.GetRootNode());
this.ImportProperties(this.model,a)}b()}ImportMaterial(a){let b=new OV.PhysicalMaterial;b.color.Set(255,255,255);void 0!==a.name&&(b.name=a.name);void 0!==a.color&&(b.color=OV.ArrayToColor(a.color));b.metalness=OV.ValueOrDefault(a.metalness,0);b.roughness=OV.ValueOrDefault(a.roughness,1);this.model.AddMaterial(b)}ImportMesh(a){let b=new OV.GeneratorParams;void 0!==a.name&&b.SetName(a.name);void 0!==a.material&&b.SetMaterial(a.material);let c=a.parameters;if(void 0!==c){var d=null;if("cuboid"===a.type){if(void 0===
c.size_x||void 0===c.size_y||void 0===c.size_z)return;d=OV.GenerateCuboid(b,c.size_x,c.size_y,c.size_z)}else if("cylinder"===a.type){if(void 0===c.radius||void 0===c.height)return;d=OV.ValueOrDefault(c.segments,25);var e=OV.ValueOrDefault(c.smooth,!0);d=OV.GenerateCylinder(b,c.radius,c.height,d,e)}else if("sphere"===a.type){if(void 0===c.radius)return;d=OV.ValueOrDefault(c.segments,20);e=OV.ValueOrDefault(c.smooth,!0);d=OV.GenerateSphere(b,c.radius,d,e)}else if("platonic"===a.type){if(void 0===c.solid_type)return;
d=OV.ValueOrDefault(c.radius,1);d=OV.GeneratePlatonicSolid(b,c.solid_type,d)}null!==d&&(this.ImportProperties(d,a),this.model.AddMesh(d))}}ImportNode(a,b,c){void 0!==b.name&&c.SetName(b.name);if(void 0!==b.transformation){var d=this.GetTransformation(b.transformation);c.SetTransformation(d)}if(void 0!==b.children)for(const e of b.children){d=a.nodes[e];let f=new OV.Node;c.AddChildNode(f);this.ImportNode(a,d,f)}void 0!==b.mesh&&(void 0!==b.children&&0!==b.children.length||c.SetType(OV.NodeType.MeshNode),
c.AddMeshIndex(b.mesh))}ImportProperties(a,b){if(void 0!==b.properties){const c=new OV.PropertyGroup("Properties");a.AddPropertyGroup(c);for(const d of b.properties)a=new OV.Property(OV.PropertyType.Text,d.name,d.value),c.AddProperty(a)}}GetTransformation(a){let b=new OV.Coord3D(0,0,0),c=new OV.Quaternion(0,0,0,1),d=new OV.Coord3D(1,1,1);void 0!==a.translation&&(b=OV.ArrayToCoord3D(a.translation));void 0!==a.rotation&&(c=OV.ArrayToQuaternion(a.rotation));void 0!==a.scale&&(d=OV.ArrayToCoord3D(a.scale));
a=(new OV.Matrix).ComposeTRS(b,c,d);return new OV.Transformation(a)}};OV.ImporterThreeBase=class extends OV.ImporterBase{constructor(){super()}GetExternalLibraries(){return null}CreateLoader(a){return null}GetMainObject(a){return a}IsMeshVisible(a){return!0}ClearContent(){this.objectUrlToFileName=this.materialIdToIndex=this.loader=null}ResetContent(){this.loader=null;this.materialIdToIndex=new Map;this.objectUrlToFileName=new Map}ImportContent(a,b){const c=this.GetExternalLibraries();null===c?b():async function(d,e,f){try{for(let g=0;g<d.length;g++)await OV.LoadExternalLibrary(d[g])}catch(g){f()}e()}(c,
()=>{this.LoadModel(a,b)},()=>{b()})}LoadModel(a,b){let c=!1,d=new THREE.LoadingManager(()=>{c=!0});const e=OV.CreateObjectUrl(a);d.setURLModifier(f=>{if(f===e)return f;const g=OV.GetFileName(f);if(0<OV.GetFileExtension(f).length){const h=this.callbacks.getFileBuffer(f);if(null!==h)return f=OV.CreateObjectUrl(h),this.objectUrlToFileName.set(f,g),f}return f});a=this.CreateLoader(d);null===a?b():a.load(e,f=>{OV.WaitWhile(()=>c?(this.OnThreeObjectsLoaded(f,b),!1):!0)},()=>{},f=>{this.SetError(f);b()})}OnThreeObjectsLoaded(a,
b){function c(f){let g=(new OV.Matrix).CreateIdentity();f.updateMatrix();void 0!==f.matrix&&null!==f.matrix&&g.Set(f.matrix.elements);return new OV.Transformation(g)}function d(f,g,h,k){let l=new OV.Node;void 0!==h.name&&l.SetName(h.name);l.SetTransformation(c(h));k.AddChildNode(l);for(let m of h.children)d(f,g,m,l);h.isMesh&&f.IsMeshVisible(h)&&(0===h.children.length&&l.SetType(OV.NodeType.MeshNode),f=f.ConvertThreeMesh(h),g=g.AddMesh(f),l.AddMeshIndex(g))}a=this.GetMainObject(a);let e=this.model.GetRootNode();
e.SetTransformation(c(a));for(let f of a.children)d(this,this.model,f,e);b()}ConvertThreeMesh(a){if(Array.isArray(a.material)){var b=OV.ConvertThreeGeometryToMesh(a.geometry,null);if(void 0===a.geometry.attributes.color||null===a.geometry.attributes.color){let e=[];for(var c=0;c<a.material.length;c++){var d=this.FindOrCreateMaterial(a.material[c]);e.push(d)}for(c=0;c<a.geometry.groups.length;c++){d=a.geometry.groups[c];let f;f=Infinity===d.count?b.TriangleCount():d.start/3+d.count/3;for(let g=d.start/
3;g<f;g++)b.GetTriangle(g).SetMaterial(e[d.materialIndex])}}}else b=this.FindOrCreateMaterial(a.material),b=OV.ConvertThreeGeometryToMesh(a.geometry,b);void 0!==a.name&&null!==a.name&&b.SetName(a.name);return b}FindOrCreateMaterial(a){if(this.materialIdToIndex.has(a.id))return this.materialIdToIndex.get(a.id);var b=this.ConvertThreeMaterial(a);b=this.model.AddMaterial(b);this.materialIdToIndex.set(a.id,b);return b}ConvertThreeMaterial(a){function b(d,e){if(void 0===d||null===d||void 0===d.image||
null===d.image)return null;try{var f=d.image;if(void 0!==f.data&&null!==f.data){let l=new ImageData(f.width,f.height),m=f.width*f.height*4;for(let n=0;n<m;n++)l.data[n]=f.data[n];var g=THREE.ImageUtils.getDataURL(l)}else g=THREE.ImageUtils.getDataURL(f);const h=OV.Base64DataURIToArrayBuffer(g);let k=new OV.TextureMap;f=null;f=e.has(d.image.src)?e.get(d.image.src):void 0!==d.name&&null!==d.name?d.name+"."+OV.GetFileExtensionFromMimeType(h.mimeType):"Embedded_"+d.id.toString()+"."+OV.GetFileExtensionFromMimeType(h.mimeType);
k.name=f;k.url=g;k.buffer=h.buffer;k.rotation=d.rotation;k.offset.x=d.offset.x;k.offset.y=d.offset.y;k.scale.x=d.repeat.x;k.scale.y=d.repeat.y;return k}catch(h){return null}}let c=new OV.PhongMaterial;c.name=a.name;c.color=OV.ConvertThreeColorToColor(a.color);c.opacity=a.opacity;c.transparent=a.transparent;c.alphaTest=a.alphaTest;"MeshPhongMaterial"===a.type&&(c.specular=OV.ConvertThreeColorToColor(a.specular),c.shininess=a.shininess/100);c.diffuseMap=b(a.map,this.objectUrlToFileName);c.normalMap=
b(a.normalMap,this.objectUrlToFileName);c.bumpMap=b(a.bumpMap,this.objectUrlToFileName);return c}};OV.ImporterThreeFbx=class extends OV.ImporterThreeBase{constructor(){super()}CanImportExtension(a){return"fbx"===a}GetUpDirection(){return OV.Direction.Y}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/TGALoader.js","three_loaders/FBXLoader.js"]}CreateLoader(a){a.addHandler(/\.tga$/i,new THREE.TGALoader(a));return new THREE.FBXLoader(a)}GetMainObject(a){return a}};
OV.ImporterThreeDae=class extends OV.ImporterThreeBase{constructor(){super()}CanImportExtension(a){return"dae"===a}GetUpDirection(){return OV.Direction.Y}GetExternalLibraries(){return["three_loaders/TGALoader.js","three_loaders/ColladaLoader.js"]}CreateLoader(a){a.addHandler(/\.tga$/i,new THREE.TGALoader(a));return new THREE.ColladaLoader(a)}GetMainObject(a){return a.scene}};
OV.ImporterThreeWrl=class extends OV.ImporterThreeBase{constructor(){super()}CanImportExtension(a){return"wrl"===a}GetUpDirection(){return OV.Direction.Y}GetExternalLibraries(){return["three_loaders/chevrotain.min.js","three_loaders/VRMLLoader.js"]}CreateLoader(a){return new THREE.VRMLLoader(a)}GetMainObject(a){return a}IsMeshVisible(a){let b=!0;if(Array.isArray(a.material))for(let c=0;c<a.material.length;c++){if(a.material[c].side===THREE.BackSide){b=!1;break}}else b=a.material.side!==THREE.BackSide;
return b}};OV.ImporterThree3mf=class extends OV.ImporterThreeBase{constructor(){super()}CanImportExtension(a){return"3mf"===a}GetUpDirection(){return OV.Direction.Z}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/3MFLoader.js"]}CreateLoader(a){return new THREE.ThreeMFLoader(a)}GetMainObject(a){return a}};OV.ImporterThreeSvg=class extends OV.ImporterThreeBase{constructor(){super()}CanImportExtension(a){return"svg"===a}GetUpDirection(){return OV.Direction.Z}GetExternalLibraries(){return["three_loaders/SVGLoader.js"]}CreateLoader(a){return new THREE.SVGLoader(a)}GetMainObject(a){function b(g){g=g.userData.style;return void 0===g.fill||"none"===g.fill?!1:!0}function c(g,h,k){let l=null;for(let m of g)if(m.style===h&&m.opacity===k){l=m.material;break}null===l&&(l=new THREE.MeshPhongMaterial({color:(new THREE.Color).setStyle(h),
opacity:k,transparent:1>k}),g.push({style:h,opacity:k,material:l}));return l}let d=[],e=new THREE.Object3D;e.rotation.x=Math.PI;for(let g of a.paths){var f=THREE.SVGLoader.createShapes(g);if(b(g)){a=g.userData.style;a=c(d,a.fill,a.opacity);for(const h of f)f=new THREE.ExtrudeGeometry(h,{depth:10,bevelEnabled:!1}),f=new THREE.Mesh(f,a),f.name=g.userData.node.id,e.add(f)}}return e}};OV.Importer3dm=class extends OV.ImporterBase{constructor(){super();this.rhino=null}CanImportExtension(a){return"3dm"===a}GetUpDirection(){return OV.Direction.Z}ClearContent(){this.instanceIdToDefinition=this.instanceIdToObject=null}ResetContent(){this.instanceIdToObject=new Map;this.instanceIdToDefinition=new Map}ImportContent(a,b){null===this.rhino?OV.LoadExternalLibrary("loaders/rhino3dm.min.js").then(()=>{rhino3dm().then(c=>{this.rhino=c;this.ImportRhinoContent(a);b()})}).catch(()=>{b()}):(this.ImportRhinoContent(a),
b())}ImportRhinoContent(a){a=this.rhino.File3dm.fromByteArray(a);null===a?this.SetError("Failed to read Rhino file."):(this.ImportRhinoDocument(a),OV.IsModelEmpty(this.model)&&this.SetError("The model doesn't contain any 3D meshes. Try to save the model while you are in shaded view in Rhino."))}ImportRhinoDocument(a){this.InitRhinoInstances(a);this.ImportRhinoUserStrings(a);this.ImportRhinoGeometry(a)}InitRhinoInstances(a){var b=a.objects();for(var c=0;c<b.count;c++){let d=b.get(c),e=d.attributes();
e.isInstanceDefinitionObject&&this.instanceIdToObject.set(e.id,d)}a=a.instanceDefinitions();for(b=0;b<a.count();b++)c=a.get(b),this.instanceIdToDefinition.set(c.id,c)}ImportRhinoUserStrings(a){a=a.strings();if(0<a.count()){let b=new OV.PropertyGroup("Document user texts");for(let c=0;c<a.count();c++){let d=a.get(c);b.AddProperty(new OV.Property(OV.PropertyType.Text,d[0],d[1]))}this.model.AddPropertyGroup(b)}}ImportRhinoGeometry(a){let b=a.objects();for(let c=0;c<b.count;c++){let d=b.get(c);this.ImportRhinoGeometryObject(a,
d,[])}}ImportRhinoGeometryObject(a,b,c){var d=b.geometry(),e=b.attributes(),f=d.objectType;if(!e.isInstanceDefinitionObject||0!==c.length){e=null;var g=!1;if(f===this.rhino.ObjectType.Mesh)e=d,g=!1;else if(f===this.rhino.ObjectType.Extrusion)e=d.getMesh(this.rhino.MeshType.Any),g=!0;else if(f===this.rhino.ObjectType.Brep){e=new this.rhino.Mesh;g=d.faces();for(d=0;d<g.count;d++){f=g.get(d);var h=f.getMesh(this.rhino.MeshType.Any);h&&(e.append(h),h.delete());f.delete()}g.delete();e.compact();g=!0}else if(f===
this.rhino.ObjectType.SubD)d.subdivide(3),e=this.rhino.Mesh.createFromSubDControlNet(d),g=!0;else if(f===this.rhino.ObjectType.InstanceReference&&(d=d.parentIdefId,this.instanceIdToDefinition.has(d)))for(d=this.instanceIdToDefinition.get(d).getObjectIds(),f=0;f<d.length;f++)h=d[f],this.instanceIdToObject.has(h)&&(h=this.instanceIdToObject.get(h),c.push(b),this.ImportRhinoGeometryObject(a,h,c),c.pop());null!==e&&(this.ImportRhinoMesh(a,e,b,c),g&&e.delete())}}ImportRhinoMesh(a,b,c,d){var e=c.attributes();
a=this.GetMaterialIndex(a,c,d);b=b.toThreejsJSON();b=OV.ConvertThreeGeometryToMesh(b.data,a);b.SetName(e.name);e=e.getUserStrings();if(0<e.length){a=new OV.PropertyGroup("User texts");for(c=0;c<e.length;c++){let f=e[c];a.AddProperty(new OV.Property(OV.PropertyType.Text,f[0],f[1]))}b.AddPropertyGroup(a)}if(0!==d.length){e=(new OV.Matrix).CreateIdentity();for(a=d.length-1;0<=a;a--)c=d[a].geometry().xform.toFloatArray(!1),c=new OV.Matrix(c),e=e.MultiplyMatrix(c);d=new OV.Transformation(e);OV.TransformMesh(b,
d)}this.model.AddMeshToRootNode(b)}GetMaterialIndex(a,b,c){function d(e,f,g){f=f.attributes();if(f.materialSource===e.ObjectMaterialSource.MaterialFromObject){if(e=f.materialIndex,-1<e)return a.materials().get(e)}else if(f.materialSource===e.ObjectMaterialSource.MaterialFromLayer){if(e=f.layerIndex,-1<e&&(e=a.layers().get(e).renderMaterialIndex,-1<e))return a.materials().get(e)}else if(f.materialSource===e.ObjectMaterialSource.MaterialFromParent&&0!==g.length)return d(e,g[0],[]);return null}b=d(this.rhino,
b,c);return function(e,f){function g(m,n){m.Set(n.r,n.g,n.b)}function h(m){return 0===m.r&&0===m.g&&0===m.b}function k(m){return 255===m.r&&255===m.g&&255===m.b}let l=null;if(null===f)l=new OV.PhongMaterial,l.color.Set(255,255,255);else{let m=f.physicallyBased();m.supported?(l=new OV.PhysicalMaterial,l.metalness=m.metallic?1:0,l.roughness=m.roughness):(l=new OV.PhongMaterial,g(l.ambient,f.ambientColor),g(l.specular,f.specularColor));l.name=f.name;g(l.color,f.diffuseColor);l.opacity=1-f.transparency;
OV.UpdateMaterialTransparency(l);h(l.color)&&!k(f.reflectionColor)&&g(l.color,f.reflectionColor);h(l.color)&&!k(f.transparentColor)&&g(l.color,f.transparentColor)}for(f=0;f<e.MaterialCount();f++)if(e.GetMaterial(f).IsEqual(l))return f;return e.AddMaterial(l)}(this.model,b)}};OV.ImporterIfc=class extends OV.ImporterBase{constructor(){super();this.ifc=null}CanImportExtension(a){return"ifc"===a}GetUpDirection(){return OV.Direction.Y}ClearContent(){this.expressIDToMesh=this.materialNameToIndex=null}ResetContent(){this.materialNameToIndex=new Map;this.expressIDToMesh=new Map}ImportContent(a,b){null===this.ifc?OV.LoadExternalLibrary("loaders/web-ifc-api-browser.js").then(()=>{this.ifc=new WebIFC.IfcAPI;this.ifc.Init().then(()=>{this.ImportIfcContent(a);b()})}).catch(()=>{b()}):
(this.ImportIfcContent(a),b())}ImportIfcContent(a){a=new Uint8Array(a);a=this.ifc.OpenModel(a,{COORDINATE_TO_ORIGIN:!0});const b=this.ifc.LoadAllGeometry(a);for(let c=0;c<b.size();c++){const d=b.get(c);0<d.geometries.size()&&this.ImportIfcMesh(a,d)}this.ImportProperties(a);this.ifc.CloseModel(a)}ImportIfcMesh(a,b){let c=new OV.Mesh;c.SetName("Mesh "+b.expressID.toString());let d=0;const e=b.geometries;for(let l=0;l<e.size();l++){var f=e.get(l),g=this.ifc.GetGeometry(a,f.geometryExpressID);const m=
this.ifc.GetVertexArray(g.GetVertexData(),g.GetVertexDataSize());g=this.ifc.GetIndexArray(g.GetIndexData(),g.GetIndexDataSize());const n=this.GetMaterialIndexByColor(f.color);f=new OV.Matrix(f.flatTransformation);f=new OV.Transformation(f);for(var h=0;h<m.length;h+=6){var k=new OV.Coord3D(m[h],m[h+1],m[h+2]);k=f.TransformCoord3D(k);c.AddVertex(k)}for(f=0;f<g.length;f+=3)h=new OV.Triangle(d+g[f],d+g[f+1],d+g[f+2]),h.SetMaterial(n),c.AddTriangle(h);d+=m.length/6}this.expressIDToMesh.set(b.expressID,
c);this.model.AddMeshToRootNode(c)}ImportProperties(a){const b=this.ifc.GetLineIDsWithType(a,WebIFC.IFCRELDEFINESBYPROPERTIES);for(let c=0;c<b.size();c++){const d=b.get(c),e=this.ifc.GetLine(a,d);Array.isArray(e.RelatingPropertyDefinition)||e.RelatedObjects.forEach(f=>{let g=null;this.expressIDToMesh.has(f.value)?g=this.expressIDToMesh.get(f.value):this.ifc.GetLine(a,f.value,!0).type===WebIFC.IFCBUILDING&&(g=this.model);if(null!==g&&(f=this.ifc.GetLine(a,e.RelatingPropertyDefinition.value,!0))&&f.HasProperties){var h=
new OV.PropertyGroup(f.Name.value);f.HasProperties.forEach(k=>{if(k&&k.Name&&k.NominalValue){var l=null,m=this.GetIFCString(k.Name.value);switch(k.NominalValue.label){case "IFCTEXT":case "IFCLABEL":case "IFCIDENTIFIER":l=new OV.Property(OV.PropertyType.Text,m,this.GetIFCString(k.NominalValue.value));break;case "IFCBOOLEAN":case "IFCLOGICAL":l="Unknown";"T"===k.NominalValue.value?l="True":"F"===k.NominalValue.value&&(l="False");l=new OV.Property(OV.PropertyType.Text,m,l);break;case "IFCINTEGER":case "IFCCOUNTMEASURE":l=
new OV.Property(OV.PropertyType.Integer,m,k.NominalValue.value);break;case "IFCREAL":case "IFCLENGTHMEASURE":case "IFCPOSITIVELENGTHMEASURE":case "IFCAREAMEASURE":case "IFCVOLUMEMEASURE":case "IFCRATIOMEASURE":case "IFCPOSITIVERATIOMEASURE":case "IFCMASSMEASURE":case "IFCMASSPERLENGTHMEASURE":case "IFCPLANEANGLEMEASURE":case "IFCTHERMALTRANSMITTANCEMEASURE":l=new OV.Property(OV.PropertyType.Number,m,k.NominalValue.value);break;default:console.log(k.NominalValue.label),console.log(k.NominalValue.value)}null!==
l&&h.AddProperty(l)}});0<h.PropertyCount()&&g.AddPropertyGroup(h)}})}}GetMaterialIndexByColor(a){const b=OV.ColorFromFloatComponents(a.x,a.y,a.z),c="Color "+OV.IntegerToHexString(b.r)+OV.IntegerToHexString(b.g)+OV.IntegerToHexString(b.b)+OV.IntegerToHexString(parseInt(255*a.w,10));if(this.materialNameToIndex.has(c))return this.materialNameToIndex.get(c);let d=new OV.PhongMaterial;d.name=c;d.color=b;d.opacity=a.w;OV.UpdateMaterialTransparency(d);a=this.model.AddMaterial(d);this.materialNameToIndex.set(c,
a);return a}GetIFCString(a){a=this.DecodeIFCString(a);0===a.length&&(a="-");return a}DecodeIFCString(a){const b=/\\X2\\(.*?)\\X0\\/uig;let c=a,d=b.exec(a);for(;d;){const e=String.fromCharCode(parseInt(d[1],16));c=c.replace(d[0],e);d=b.exec(a)}return c}};OV.File=class{constructor(a,b){this.source=b;b===OV.FileSource.Url?(this.fileUrl=a,this.fileObject=null,this.name=OV.GetFileName(a),this.extension=OV.GetFileExtension(a)):b===OV.FileSource.File?(this.fileUrl=null,this.fileObject=a,this.name=OV.GetFileName(a.name),this.extension=OV.GetFileExtension(a.name)):b===OV.FileSource.Decompressed&&(this.fileObject=this.fileUrl=null,this.name=OV.GetFileName(a),this.extension=OV.GetFileExtension(a));this.content=null}SetContent(a){this.content=a}};
OV.FileList=class{constructor(){this.files=[]}FillFromFileUrls(a){this.Fill(a,OV.FileSource.Url)}FillFromFileObjects(a){this.Fill(a,OV.FileSource.File)}ExtendFromFileList(a){for(let b=0;b<a.length;b++){let c=a[b];this.ContainsFileByPath(c.name)||this.files.push(c)}}GetFiles(){return this.files}GetContent(a){OV.RunTasks(this.files.length,{runTask:(b,c)=>{this.GetFileContent(this.files[b],c)},onReady:a})}ContainsFileByPath(a){return null!==this.FindFileByPath(a)}FindFileByPath(a){a=OV.GetFileName(a).toLowerCase();
for(let b=0;b<this.files.length;b++){let c=this.files[b];if(c.name.toLowerCase()===a)return c}return null}IsOnlyUrlSource(){if(0===this.files.length)return!1;for(let a=0;a<this.files.length;a++){let b=this.files[a];if(b.source!==OV.FileSource.Url&&b.source!==OV.FileSource.Decompressed)return!1}return!0}Fill(a,b){this.files=[];for(let c=0;c<a.length;c++){let d=new OV.File(a[c],b);this.AddFile(d)}}AddFile(a){this.files.push(a)}GetFileContent(a,b){if(null!==a.content)b();else{var c=null;if(a.source===
OV.FileSource.Url)c=OV.RequestUrl(a.fileUrl,OV.FileFormat.Binary);else if(a.source===OV.FileSource.File)c=OV.ReadFile(a.fileObject,OV.FileFormat.Binary);else{b();return}c.then(d=>{a.SetContent(d)}).catch(()=>{}).finally(()=>{b()})}}};OV.ImportSettings=class{constructor(){this.defaultColor=new OV.Color(200,200,200)}};OV.ImportErrorCode={NoImportableFile:1,FailedToLoadFile:2,ImportFailed:3,UnknownError:4};OV.ImportError=class{constructor(a,b){this.code=a;this.message=b}};OV.ImportResult=class{constructor(){this.missingFiles=this.usedFiles=this.upVector=this.mainFile=this.model=null}};
OV.ImporterFileAccessor=class{constructor(a){this.getBufferCallback=a;this.fileBuffers=new Map;this.textureBuffers=new Map}GetFileBuffer(a){a=OV.GetFileName(a);if(this.fileBuffers.has(a))return this.fileBuffers.get(a);let b=this.getBufferCallback(a);this.fileBuffers.set(a,b);return b}GetTextureBuffer(a){a=OV.GetFileName(a);if(this.textureBuffers.has(a))return this.textureBuffers.get(a);let b=null,c=this.getBufferCallback(a);null!==c&&(b={url:OV.CreateObjectUrl(c),buffer:c});this.textureBuffers.set(a,
b);return b}};
OV.Importer=class{constructor(){this.importers=[new OV.ImporterObj,new OV.ImporterStl,new OV.ImporterOff,new OV.ImporterPly,new OV.Importer3ds,new OV.ImporterGltf,new OV.ImporterO3dv,new OV.Importer3dm,new OV.ImporterIfc,new OV.ImporterThreeFbx,new OV.ImporterThreeDae,new OV.ImporterThreeWrl,new OV.ImporterThree3mf];this.fileList=new OV.FileList;this.model=null;this.usedFiles=[];this.missingFiles=[]}AddImporter(a){this.importers.push(a)}ImportFiles(a,b,c,d){this.LoadFiles(a,b,()=>{d.onFilesLoaded();OV.RunTaskAsync(()=>
{this.ImportLoadedFiles(c,d)})})}LoadFiles(a,b,c){let d=new OV.FileList(this.importers);b===OV.FileSource.Url?d.FillFromFileUrls(a):b===OV.FileSource.File&&d.FillFromFileObjects(a);a=!1;if(this.HasImportableFile(d))a=!0;else{a=!1;for(b=0;b<this.missingFiles.length;b++)d.ContainsFileByPath(this.missingFiles[b])&&(a=!0);a?(a=d.GetFiles(),this.fileList.ExtendFromFileList(a),a=!1):a=!0}a&&(this.fileList=d);this.fileList.GetContent(()=>{this.DecompressArchives(this.fileList,()=>{c()})})}ImportLoadedFiles(a,
b){let c=this.GetImportableFiles(this.fileList);if(0===c.length)b.onImportError(new OV.ImportError(OV.ImportErrorCode.NoImportableFile,null));else if(1!==c.length&&b.onSelectMainFile){let d=c.map(e=>e.file.name);b.onSelectMainFile(d,e=>{if(null===e)b.onImportError(new OV.ImportError(OV.ImportErrorCode.NoImportableFile,null));else OV.RunTaskAsync(()=>{this.ImportLoadedMainFile(c[e],a,b)})})}else this.ImportLoadedMainFile(c[0],a,b)}ImportLoadedMainFile(a,b,c){if(null===a||null===a.file||null===a.file.content)c.onImportError(new OV.ImportError(OV.ImportErrorCode.FailedToLoadFile,
null));else{this.RevokeModelUrls();this.model=null;this.usedFiles=[];this.missingFiles=[];this.usedFiles.push(a.file.name);var d=a.importer,e=new OV.ImporterFileAccessor(f=>{let g=this.fileList.FindFileByPath(f);null===g||null===g.content?(this.missingFiles.push(f),f=null):(this.usedFiles.push(f),f=g.content);return f});d.Import(a.file.name,a.file.extension,a.file.content,{getDefaultMaterialColor:()=>b.defaultColor,getFileBuffer:f=>e.GetFileBuffer(f),getTextureBuffer:f=>e.GetTextureBuffer(f),onSuccess:()=>
{this.model=d.GetModel();let f=new OV.ImportResult;f.mainFile=a.file.name;f.model=this.model;f.usedFiles=this.usedFiles;f.missingFiles=this.missingFiles;f.upVector=d.GetUpDirection();c.onImportSuccess(f)},onError:()=>{let f=d.GetErrorMessage();c.onImportError(new OV.ImportError(OV.ImportErrorCode.ImportFailed,f))},onComplete:()=>{d.Clear()}})}}DecompressArchives(a,b){let c=a.GetFiles(),d=[];for(let e of c)"zip"===e.extension&&d.push(e);0===d.length?b():OV.LoadExternalLibrary("loaders/fflate.min.js").then(()=>
{for(let f=0;f<d.length;f++){var e=new Uint8Array(d[f].content);e=fflate.unzipSync(e);for(const g in e)if(Object.prototype.hasOwnProperty.call(e,g)){let h=new OV.File(g,OV.FileSource.Decompressed);h.SetContent(e[g].buffer);a.AddFile(h)}}b()}).catch(()=>{b()})}GetFileList(){return this.fileList}HasImportableFile(a){return 0<this.GetImportableFiles(a).length}GetImportableFiles(a){let b=[];a=a.GetFiles();for(let e=0;e<a.length;e++){let f=a[e];a:{var c=f;var d=this.importers;for(let g=0;g<d.length;g++){let h=
d[g];if(h.CanImportExtension(c.extension)){c=h;break a}}c=null}null!==c&&b.push({file:f,importer:c})}return b}RevokeModelUrls(){if(null!==this.model)for(let a=0;a<this.model.MaterialCount();a++)this.model.GetMaterial(a).EnumerateTextureMaps(b=>{null!==b.url&&OV.RevokeObjectUrl(b.url)})}};OV.ExporterSettings=class{constructor(a){this.transformation=new OV.Transformation;this.isMeshVisible=b=>!0;OV.CopyObjectAttributes(a,this)}};
OV.ExporterModel=class{constructor(a,b){this.model=a;this.settings=b||new OV.ExporterSettings}MaterialCount(){return this.model.MaterialCount()}GetMaterial(a){return this.model.GetMaterial(a)}VertexCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=b.VertexCount()});return a}TriangleCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=b.TriangleCount()});return a}MeshInstanceCount(){let a=0;this.EnumerateMeshInstances(b=>{a+=1});return a}EnumerateMeshInstances(a){this.model.EnumerateMeshInstances(b=>
{this.settings.isMeshVisible(b.GetId())&&a(b)})}EnumerateTransformedMeshes(a){this.EnumerateMeshInstances(b=>{let c=b.GetTransformation();this.settings.transformation.IsIdentity()||c.Append(this.settings.transformation);b=b.GetMesh().Clone();c.IsIdentity()||OV.TransformMesh(b,c);a(b)})}EnumerateVerticesAndTriangles(a){let b=[];this.EnumerateTransformedMeshes(d=>{b.push(d)});for(let d of b)d.EnumerateVertices(e=>{a.onVertex(e.x,e.y,e.z)});let c=0;for(let d of b)d.EnumerateTriangleVertexIndices((e,
f,g)=>{a.onTriangle(e+c,f+c,g+c)}),c+=d.VertexCount()}EnumerateTrianglesWithNormals(a){this.EnumerateTransformedMeshes(b=>{b.EnumerateTriangleVertices((c,d,e)=>{let f=OV.CalculateTriangleNormal(c,d,e);a(c,d,e,f)})})}};OV.ExportedFile=class{constructor(a){this.name=a;this.content=null}GetName(){return this.name}SetName(a){this.name=a}GetTextContent(){return OV.ArrayBufferToUtf8String(this.content)}GetBufferContent(){return this.content}SetTextContent(a){this.content=OV.Utf8StringToArrayBuffer(a)}SetBufferContent(a){this.content=a}};
OV.ExporterBase=class{constructor(){}CanExport(a,b){return!1}Export(a,b,c){let d=[];this.ExportContent(a,b,d,()=>{c(d)})}ExportContent(a,b,c,d){}GetExportedMaterialName(a){return this.GetExportedName(a,"Material")}GetExportedMeshName(a){return this.GetExportedName(a,"Mesh")}GetExportedName(a,b){return 0===a.length?b:a}};OV.ExporterObj=class extends OV.ExporterBase{constructor(){super()}CanExport(a,b){return a===OV.FileFormat.Text&&"obj"===b}ExportContent(a,b,c,d){function e(r,q,t,p){if(null!==t&&t.IsValid()){var u=OV.GetFileName(t.name);r.WriteArrayLine([q,u]);-1===p.findIndex(v=>v.GetName()===u)&&(r=new OV.ExportedFile(u),r.SetBufferContent(t.buffer),p.push(r))}}b=new OV.ExportedFile("model.mtl");let f=new OV.ExportedFile("model.obj");c.push(b);c.push(f);let g=new OV.TextWriter;g.WriteLine(this.GetHeaderText());
for(let r=0;r<a.MaterialCount();r++){let q=a.GetMaterial(r);g.WriteArrayLine(["newmtl",this.GetExportedMaterialName(q.name)]);g.WriteArrayLine(["Kd",q.color.r/255,q.color.g/255,q.color.b/255]);g.WriteArrayLine(["d",q.opacity]);q.type===OV.MaterialType.Phong&&(g.WriteArrayLine(["Ka",q.ambient.r/255,q.ambient.g/255,q.ambient.b/255]),g.WriteArrayLine(["Ks",q.specular.r/255,q.specular.g/255,q.specular.b/255]),g.WriteArrayLine(["Ns",1E3*q.shininess]));e(g,"map_Kd",q.diffuseMap,c);q.type===OV.MaterialType.Phong&&
e(g,"map_Ks",q.specularMap,c);e(g,"bump",q.bumpMap,c)}b.SetTextContent(g.GetText());let h=new OV.TextWriter;h.WriteLine(this.GetHeaderText());h.WriteArrayLine(["mtllib",b.GetName()]);let k=0,l=0,m=0,n=null;a.EnumerateTransformedMeshes(r=>{h.WriteArrayLine(["g",this.GetExportedMeshName(r.GetName())]);for(var q=0;q<r.VertexCount();q++){var t=r.GetVertex(q);h.WriteArrayLine(["v",t.x,t.y,t.z])}for(q=0;q<r.NormalCount();q++)t=r.GetNormal(q),h.WriteArrayLine(["vn",t.x,t.y,t.z]);for(q=0;q<r.TextureUVCount();q++)t=
r.GetTextureUV(q),h.WriteArrayLine(["vt",t.x,t.y]);for(q=0;q<r.TriangleCount();q++){t=r.GetTriangle(q);let u=t.v0+k+1,v=t.v1+k+1,w=t.v2+k+1,x=t.n0+l+1,y=t.n1+l+1,z=t.n2+l+1;if(null!==t.mat){var p=a.GetMaterial(t.mat);p=this.GetExportedMaterialName(p.name);p!==n&&(h.WriteArrayLine(["usemtl",p]),n=p)}let A=p="",G="";t.HasTextureUVs()&&(p=t.u0+m+1,A=t.u1+m+1,G=t.u2+m+1);h.WriteArrayLine(["f",[u,p,x].join("/"),[v,A,y].join("/"),[w,G,z].join("/")])}k+=r.VertexCount();l+=r.NormalCount();m+=r.TextureUVCount()});
f.SetTextContent(h.GetText());d()}GetHeaderText(){return"# exported by https://3dviewer.net"}};OV.ExporterStl=class extends OV.ExporterBase{constructor(){super()}CanExport(a,b){return(a===OV.FileFormat.Text||a===OV.FileFormat.Binary)&&"stl"===b}ExportContent(a,b,c,d){b===OV.FileFormat.Text?this.ExportText(a,c):this.ExportBinary(a,c);d()}ExportText(a,b){let c=new OV.ExportedFile("model.stl");b.push(c);let d=new OV.TextWriter;d.WriteLine("solid Model");a.EnumerateTrianglesWithNormals((e,f,g,h)=>{d.WriteArrayLine(["facet","normal",h.x,h.y,h.z]);d.Indent(1);d.WriteLine("outer loop");d.Indent(1);
d.WriteArrayLine(["vertex",e.x,e.y,e.z]);d.WriteArrayLine(["vertex",f.x,f.y,f.z]);d.WriteArrayLine(["vertex",g.x,g.y,g.z]);d.Indent(-1);d.WriteLine("endloop");d.Indent(-1);d.WriteLine("endfacet")});d.WriteLine("endsolid Model");c.SetTextContent(d.GetText())}ExportBinary(a,b){let c=new OV.ExportedFile("model.stl");b.push(c);b=a.TriangleCount();let d=new OV.BinaryWriter(84+50*b,!0);for(let e=0;80>e;e++)d.WriteUnsignedCharacter8(0);d.WriteUnsignedInteger32(b);a.EnumerateTrianglesWithNormals((e,f,g,h)=>
{d.WriteFloat32(h.x);d.WriteFloat32(h.y);d.WriteFloat32(h.z);d.WriteFloat32(e.x);d.WriteFloat32(e.y);d.WriteFloat32(e.z);d.WriteFloat32(f.x);d.WriteFloat32(f.y);d.WriteFloat32(f.z);d.WriteFloat32(g.x);d.WriteFloat32(g.y);d.WriteFloat32(g.z);d.WriteUnsignedInteger16(0)});c.SetBufferContent(d.GetBuffer())}};OV.ExporterPly=class extends OV.ExporterBase{constructor(){super()}CanExport(a,b){return(a===OV.FileFormat.Text||a===OV.FileFormat.Binary)&&"ply"===b}ExportContent(a,b,c,d){b===OV.FileFormat.Text?this.ExportText(a,c):this.ExportBinary(a,c);d()}ExportText(a,b){let c=new OV.ExportedFile("model.ply");b.push(c);let d=new OV.TextWriter;b=a.VertexCount();let e=a.TriangleCount();b=this.GetHeaderText("ascii",b,e);d.Write(b);a.EnumerateVerticesAndTriangles({onVertex:function(f,g,h){d.WriteArrayLine([f,g,h])},
onTriangle:function(f,g,h){d.WriteArrayLine([3,f,g,h])}});c.SetTextContent(d.GetText())}ExportBinary(a,b){let c=new OV.ExportedFile("model.ply");b.push(c);var d=a.VertexCount();let e=a.TriangleCount();b=this.GetHeaderText("binary_little_endian",d,e);let f=new OV.BinaryWriter(b.length+12*d+13*e,!0);for(d=0;d<b.length;d++)f.WriteUnsignedCharacter8(b.charCodeAt(d));a.EnumerateVerticesAndTriangles({onVertex:function(g,h,k){f.WriteFloat32(g);f.WriteFloat32(h);f.WriteFloat32(k)},onTriangle:function(g,h,
k){f.WriteUnsignedCharacter8(3);f.WriteInteger32(g);f.WriteInteger32(h);f.WriteInteger32(k)}});c.SetBufferContent(f.GetBuffer())}GetHeaderText(a,b,c){let d=new OV.TextWriter;d.WriteLine("ply");d.WriteLine("format "+a+" 1.0");d.WriteLine("element vertex "+b);d.WriteLine("property float x");d.WriteLine("property float y");d.WriteLine("property float z");d.WriteLine("element face "+c);d.WriteLine("property list uchar int vertex_index");d.WriteLine("end_header");return d.GetText()}};OV.ExporterOff=class extends OV.ExporterBase{constructor(){super()}CanExport(a,b){return a===OV.FileFormat.Text&&"off"===b}ExportContent(a,b,c,d){b=new OV.ExportedFile("model.off");c.push(b);let e=new OV.TextWriter;e.WriteLine("OFF");e.WriteArrayLine([a.VertexCount(),a.TriangleCount(),0]);a.EnumerateVerticesAndTriangles({onVertex:function(f,g,h){e.WriteArrayLine([f,g,h])},onTriangle:function(f,g,h){e.WriteArrayLine([3,f,g,h])}});b.SetTextContent(e.GetText());d()}};OV.ExporterGltf=class extends OV.ExporterBase{constructor(){super();this.components={index:{type:5125,size:4},number:{type:5126,size:4}}}CanExport(a,b){return a===OV.FileFormat.Text&&"gltf"===b||a===OV.FileFormat.Binary&&"glb"===b}ExportContent(a,b,c,d){b===OV.FileFormat.Text?this.ExportAsciiContent(a,c):b===OV.FileFormat.Binary&&this.ExportBinaryContent(a,c);d()}ExportAsciiContent(a,b){let c=new OV.ExportedFile("model.gltf"),d=new OV.ExportedFile("model.bin");b.push(c);b.push(d);let e=this.GetMeshData(a),
f=this.GetMainBuffer(e),g=this.GetMainJson(e);g.buffers.push({uri:d.GetName(),byteLength:f.byteLength});let h=new Map;this.ExportMaterials(a,g,k=>{let l=OV.GetFileName(k.name);if(h.has(l))return h.get(l);let m=new OV.ExportedFile(l);m.SetBufferContent(k.buffer);b.push(m);k=g.textures.length;h.set(l,k);g.images.push({uri:l});g.textures.push({source:k});return k});c.SetTextContent(JSON.stringify(g,null,4));d.SetBufferContent(f)}ExportBinaryContent(a,b){function c(p){let u=p%4;return 0===u?p:p+(4-u)}
function d(p,u,v){for(let w=0;w<v;w++)p.WriteUnsignedCharacter8(u)}let e=new OV.ExportedFile("model.glb");b.push(e);var f=this.GetMeshData(a);b=this.GetMainBuffer(f);let g=this.GetMainJson(f),h=[],k=b.byteLength,l=new Map;this.ExportMaterials(a,g,p=>{let u=OV.GetFileName(p.name),v=OV.GetFileExtension(p.name);if(l.has(u))return l.get(u);let w=g.bufferViews.length,x=g.textures.length;l.set(u,x);p=p.buffer;h.push(p);g.bufferViews.push({buffer:0,byteOffset:k,byteLength:p.byteLength});k+=p.byteLength;
g.images.push({bufferView:w,mimeType:"image/"+v});g.textures.push({source:x});return x});a=b.byteLength;for(f=0;f<h.length;f++)a+=h[f].byteLength;f=c(a);g.buffers.push({byteLength:f});var m=JSON.stringify(g);let n=OV.Utf8StringToArrayBuffer(m),r=n.byteLength,q=c(r),t=20+q+8+f;m=new OV.BinaryWriter(t,!0);m.WriteUnsignedInteger32(1179937895);m.WriteUnsignedInteger32(2);m.WriteUnsignedInteger32(t);m.WriteUnsignedInteger32(q);m.WriteUnsignedInteger32(1313821514);m.WriteArrayBuffer(n);d(m,32,q-r);m.WriteUnsignedInteger32(f);
m.WriteUnsignedInteger32(5130562);m.WriteArrayBuffer(b);for(b=0;b<h.length;b++)m.WriteArrayBuffer(h[b]);d(m,0,f-a);e.SetBufferContent(m.GetBuffer())}GetMeshData(a){let b=[];a.EnumerateTransformedMeshes(c=>{let d=OV.ConvertMeshToMeshBuffer(c);b.push({name:c.GetName(),buffer:d,offsets:[],sizes:[]})});return b}GetMainBuffer(a){var b=0;for(var c=0;c<a.length;c++)b+=a[c].buffer.GetByteLength(this.components.index.size,this.components.number.size);b=new OV.BinaryWriter(b,!0);for(c=0;c<a.length;c++){let e=
a[c];for(let f=0;f<e.buffer.PrimitiveCount();f++){let g=e.buffer.GetPrimitive(f),h=b.GetPosition();for(var d=0;d<g.indices.length;d++)b.WriteUnsignedInteger32(g.indices[d]);for(d=0;d<g.vertices.length;d++)b.WriteFloat32(g.vertices[d]);for(d=0;d<g.colors.length;d++)b.WriteFloat32(OV.SRGBToLinear(g.colors[d]));for(d=0;d<g.normals.length;d++)b.WriteFloat32(g.normals[d]);for(d=0;d<g.uvs.length;d++){let k=g.uvs[d];1===d%2&&(k*=-1);b.WriteFloat32(k)}e.offsets.push(h);e.sizes.push(b.GetPosition()-h)}}return b.GetBuffer()}GetMainJson(a){class b{constructor(e,
f){this.mainJson=e;this.byteOffset=f}AddBufferView(e){this.mainJson.bufferViews.push({buffer:0,byteOffset:this.byteOffset,byteLength:e});this.byteOffset+=e;return this.mainJson.bufferViews.length-1}}let c={asset:{generator:"https://3dviewer.net",version:"2.0"},scene:0,scenes:[{nodes:[]}],nodes:[],materials:[],meshes:[],buffers:[],bufferViews:[],accessors:[]};for(let e=0;e<a.length;e++){let f=a[e];c.scenes[0].nodes.push(e);c.nodes.push({mesh:e});let g={name:this.GetExportedMeshName(f.name),primitives:[]},
h=f.buffer.primitives;for(let k=0;k<h.length;k++){let l=h[k];var d=new b(c,f.offsets[k]);let m=d.AddBufferView(l.indices.length*this.components.index.size),n=d.AddBufferView(l.vertices.length*this.components.number.size),r=null;0<l.colors.length&&(r=d.AddBufferView(l.colors.length*this.components.number.size));let q=d.AddBufferView(l.normals.length*this.components.number.size),t=null;0<l.uvs.length&&(t=d.AddBufferView(l.uvs.length*this.components.number.size));d={attributes:{},mode:4,material:l.material};
let p=l.GetBounds();c.accessors.push({bufferView:m,byteOffset:0,componentType:this.components.index.type,count:l.indices.length,type:"SCALAR"});d.indices=c.accessors.length-1;c.accessors.push({bufferView:n,byteOffset:0,componentType:this.components.number.type,count:l.vertices.length/3,min:p.min,max:p.max,type:"VEC3"});d.attributes.POSITION=c.accessors.length-1;null!==r&&(c.accessors.push({bufferView:r,byteOffset:0,componentType:this.components.number.type,count:l.colors.length/3,type:"VEC3"}),d.attributes.COLOR_0=
c.accessors.length-1);c.accessors.push({bufferView:q,byteOffset:0,componentType:this.components.number.type,count:l.normals.length/3,type:"VEC3"});d.attributes.NORMAL=c.accessors.length-1;null!==t&&(c.accessors.push({bufferView:t,byteOffset:0,componentType:this.components.number.type,count:l.uvs.length/2,type:"VEC2"}),d.attributes.TEXCOORD_0=c.accessors.length-1);g.primitives.push(d)}c.meshes.push(g)}return c}ExportMaterials(a,b,c){function d(e,f,g,h){function k(n,r){return[OV.SRGBToLinear(n.r/255),
OV.SRGBToLinear(n.g/255),OV.SRGBToLinear(n.b/255),r]}function l(n,r,q){if(null===r||!r.IsValid())return null;void 0===n.images&&(n.images=[]);void 0===n.textures&&(n.textures=[]);q={index:q(r)};r.HasTransformation()&&(void 0===n.extensionsUsed&&(n.extensionsUsed=[]),-1===n.extensionsUsed.indexOf("KHR_texture_transform")&&n.extensionsUsed.push("KHR_texture_transform"),q.extensions={KHR_texture_transform:{offset:[r.offset.x,-r.offset.y],scale:[r.scale.x,r.scale.y],rotation:-r.rotation}});return q}e=
{name:e.GetExportedMaterialName(g.name),pbrMetallicRoughness:{baseColorFactor:k(g.color,g.opacity)},emissiveFactor:function(n){return[OV.SRGBToLinear(n.r/255),OV.SRGBToLinear(n.g/255),OV.SRGBToLinear(n.b/255)]}(g.emissive),doubleSided:!0,alphaMode:"OPAQUE"};g.transparent&&(e.alphaMode="BLEND");var m=l(f,g.diffuseMap,h);null!==m&&(g.multiplyDiffuseMap||(e.pbrMetallicRoughness.baseColorFactor=k(new OV.Color(255,255,255),g.opacity)),e.pbrMetallicRoughness.baseColorTexture=m);g.type===OV.MaterialType.Physical&&
(m=l(f,g.metalnessMap,h),null!==m?e.pbrMetallicRoughness.metallicRoughnessTexture=m:(e.pbrMetallicRoughness.metallicFactor=g.metalness,e.pbrMetallicRoughness.roughnessFactor=g.roughness));m=l(f,g.normalMap,h);null!==m&&(e.normalTexture=m);g=l(f,g.emissiveMap,h);null!==g&&(e.emissiveTexture=g);f.materials.push(e)}for(let e=0;e<a.MaterialCount();e++){let f=a.GetMaterial(e);d(this,b,f,c)}}};OV.Exporter3dm=class extends OV.ExporterBase{constructor(){super();this.rhino=null}CanExport(a,b){return a===OV.FileFormat.Binary&&"3dm"===b}ExportContent(a,b,c,d){null===this.rhino?OV.LoadExternalLibrary("loaders/rhino3dm.min.js").then(()=>{rhino3dm().then(e=>{this.rhino=e;this.ExportRhinoContent(a,c,d)})}).catch(()=>{d()}):this.ExportRhinoContent(a,c,d)}ExportRhinoContent(a,b,c){function d(g){return{r:g.r,g:g.g,b:g.b,a:255}}let e=new OV.ExportedFile("model.3dm");b.push(e);let f=new this.rhino.File3dm;
a.EnumerateTransformedMeshes(g=>{let h=OV.ConvertMeshToMeshBuffer(g);for(let n=0;n<h.PrimitiveCount();n++){var k=h.GetPrimitive(n),l={data:{attributes:{position:{itemSize:3,type:"Float32Array",array:k.vertices},normal:{itemSize:3,type:"Float32Array",array:k.normals}},index:{type:"Uint16Array",array:k.indices}}};k=a.GetMaterial(k.material);var m=new this.rhino.Material;m.name=this.GetExportedMaterialName(k.name);k.type===OV.MaterialType.Phong&&(m.ambientColor=d(k.ambient),m.specularColor=d(k.specular));
m.diffuseColor=d(k.color);m.transparency=1-k.opacity;k=f.materials().count();f.materials().add(m);l=new this.rhino.Mesh.createFromThreejsJSON(l);m=new this.rhino.ObjectAttributes;m.name=this.GetExportedMeshName(g.GetName());m.materialSource=this.rhino.ObjectMaterialSource.MaterialFromObject;m.materialIndex=k;f.objects().add(l,m)}});b=new this.rhino.File3dmWriteOptions;b.version=6;b=f.toByteArray(b);e.SetBufferContent(b);c()}};OV.Exporter=class{constructor(){this.exporters=[new OV.ExporterObj,new OV.ExporterStl,new OV.ExporterPly,new OV.ExporterOff,new OV.ExporterGltf,new OV.Exporter3dm]}AddExporter(a){this.exporters.push(a)}Export(a,b,c,d,e){let f=null;for(let g=0;g<this.exporters.length;g++){let h=this.exporters[g];if(h.CanExport(c,d)){f=h;break}}if(null===f)e.onError();else a=new OV.ExporterModel(a,b),f.Export(a,c,g=>{if(0===g.length)e.onError();else e.onSuccess(g)})}};OV.HasHighpDriverIssue=function(){let a=document.createElement("canvas");document.body.appendChild(a);var b=new THREE.WebGLRenderer({canvas:a,antialias:!0});b.setClearColor("#ffffff",1);b.setSize(10,10);var c=new THREE.Scene,d=new THREE.AmbientLight(8947848);c.add(d);d=new THREE.DirectionalLight(8947848);d.position.set(0,0,1);c.add(d);d=new THREE.PerspectiveCamera(45,1,.1,1E3);d.position.set(0,0,1);d.up.set(0,1,0);d.lookAt(new THREE.Vector3(0,0,0));c.add(d);var e=new THREE.PlaneGeometry(1,1);e=new THREE.Mesh(e,
new THREE.MeshPhongMaterial({color:13369344}));c.add(e);b.render(c,d);b=b.getContext();c=new Uint8Array(4);b.readPixels(5,5,1,1,b.RGBA,b.UNSIGNED_BYTE,c);document.body.removeChild(a);return 50>c[0]&&50>c[1]&&50>c[2]?!0:!1};OV.ShadingType={Phong:1,Physical:2};OV.GetShadingType=function(a){let b=0,c=0;for(let d=0;d<a.MaterialCount();d++){let e=a.GetMaterial(d);e.type===OV.MaterialType.Phong?b+=1:e.type===OV.MaterialType.Physical&&(c+=1)}return b>=c?OV.ShadingType.Phong:OV.ShadingType.Physical};
OV.ConvertThreeColorToColor=function(a){return OV.ColorFromFloatComponents(a.r,a.g,a.b)};OV.ConvertColorToThreeColor=function(a){return new THREE.Color(a.r/255,a.g/255,a.b/255)};
OV.ConvertThreeGeometryToMesh=function(a,b){let c=new OV.Mesh;var d=a.attributes.position.array;for(var e=0;e<d.length;e+=3)c.AddVertex(new OV.Coord3D(d[e],d[e+1],d[e+2]));if(e=void 0!==a.attributes.color){var f=a.attributes.color.array,g=a.attributes.color.itemSize;for(var h=0;h<f.length;h+=g){var k=new THREE.Color(f[h],f[h+1],f[h+2]);c.AddVertexColor(OV.ConvertThreeColorToColor(k))}}if(f=void 0!==a.attributes.normal)for(g=a.attributes.normal.array,h=0;h<g.length;h+=3)c.AddNormal(new OV.Coord3D(g[h],
g[h+1],g[h+2]));if(g=void 0!==a.attributes.uv)for(h=a.attributes.uv.array,k=0;k<h.length;k+=2)c.AddTextureUV(new OV.Coord2D(h[k],h[k+1]));if(null!==a.index)a=a.index.array;else for(a=[],h=0;h<d.length/3;h++)a.push(h);for(d=0;d<a.length;d+=3){h=a[d];k=a[d+1];let l=a[d+2],m=new OV.Triangle(h,k,l);e&&m.SetVertexColors(h,k,l);f&&m.SetNormals(h,k,l);g&&m.SetTextureUVs(h,k,l);null!==b&&m.SetMaterial(b);c.AddTriangle(m)}return c};OV.ModelToThreeConversionParams=class{constructor(){this.forceMediumpForMaterials=!1}};OV.ModelToThreeConversionOutput=class{constructor(){this.defaultMaterial=null}};
OV.ThreeConversionStateHandler=class{constructor(a){this.callbacks=a;this.texturesLoaded=this.texturesNeeded=0;this.threeObject=null}OnTextureNeeded(){this.texturesNeeded+=1}OnTextureLoaded(){this.texturesLoaded+=1;this.callbacks.onTextureLoaded();this.Finish()}OnModelLoaded(a){this.threeObject=a;this.Finish()}Finish(){if(null!==this.threeObject&&this.texturesNeeded===this.texturesLoaded)this.callbacks.onModelLoaded(this.threeObject)}};
OV.ThreeNodeTree=class{constructor(a,b){this.meshInstances=[];this.AddNode(a,b)}AddNode(a,b){var c=a.GetTransformation().GetMatrix();c=(new THREE.Matrix4).fromArray(c.Get());b.applyMatrix4(c);for(let d of a.GetChildNodes())c=new THREE.Object3D,b.add(c),this.AddNode(d,c);for(let d of a.GetMeshIndices())this.meshInstances.push({node:a,threeNode:b,meshIndex:d})}GetMeshInstances(){return this.meshInstances}};
OV.ConvertModelToThreeObject=function(a,b,c,d){function e(k,l,m,n,r,q){function t(v,w,x,y){if(null!==x&&x.IsValid()){var z=new THREE.TextureLoader;v.OnTextureNeeded();z.load(x.url,A=>{A.wrapS=THREE.RepeatWrapping;A.wrapT=THREE.RepeatWrapping;A.rotation=x.rotation;A.offset.x=x.offset.x;A.offset.y=x.offset.y;A.repeat.x=x.scale.x;A.repeat.y=x.scale.y;w.needsUpdate=!0;y(A);v.OnTextureLoaded()},null,A=>{v.OnTextureLoaded()})}}let p=l.GetMaterial(m);l=OV.ConvertColorToThreeColor(p.color);p.vertexColors&&
l.setRGB(1,1,1);l={color:l,vertexColors:p.vertexColors,opacity:p.opacity,transparent:p.transparent,alphaTest:p.alphaTest,side:THREE.DoubleSide};r.forceMediumpForMaterials&&(l.precision="mediump");let u=null;n===OV.ShadingType.Phong?(u=new THREE.MeshPhongMaterial(l),p.type===OV.MaterialType.Phong&&(n=OV.ConvertColorToThreeColor(p.specular),OV.IsEqual(p.shininess,0)&&n.setRGB(0,0,0),u.specular=n,u.shininess=100*p.shininess,t(k,u,p.specularMap,v=>{u.specularMap=v}))):n===OV.ShadingType.Physical&&(u=
new THREE.MeshStandardMaterial(l),p.type===OV.MaterialType.Physical&&(u.metalness=p.metalness,u.roughness=p.roughness,t(k,u,p.metalnessMap,v=>{u.metalness=1;u.roughness=1;u.metalnessMap=v;u.roughnessMap=v})));n=OV.ConvertColorToThreeColor(p.emissive);u.emissive=n;t(k,u,p.diffuseMap,v=>{p.multiplyDiffuseMap||u.color.setRGB(1,1,1);u.map=v});t(k,u,p.bumpMap,v=>{u.bumpMap=v});t(k,u,p.normalMap,v=>{u.normalMap=v});t(k,u,p.emissiveMap,v=>{u.emissiveMap=v});p.isDefault&&(q.defaultMaterial=u);return u}function f(k,
l,m){let n=k.GetMesh(l.meshIndex);var r=n.TriangleCount();let q=[];for(k=0;k<r;k++)q.push(k);q.sort((B,H)=>{B=n.GetTriangle(B);H=n.GetTriangle(H);return B.mat-H.mat});let t=new THREE.BufferGeometry,p=[];k=[];let u=new Map,v=[],w=[],x=[],y=[],z=[];z.push({start:0,end:-1});let A=0<n.VertexColorCount(),G=0<n.TextureUVCount();for(let B=0;B<q.length;B++){var C=n.GetTriangle(q[B]),D=n.GetVertex(C.v0),E=n.GetVertex(C.v1),F=n.GetVertex(C.v2);v.push(D.x,D.y,D.z,E.x,E.y,E.z,F.x,F.y,F.z);C.HasVertexColors()?
(D=OV.ConvertColorToThreeColor(n.GetVertexColor(C.c0)),E=OV.ConvertColorToThreeColor(n.GetVertexColor(C.c1)),F=OV.ConvertColorToThreeColor(n.GetVertexColor(C.c2)),w.push(D.r,D.g,D.b,E.r,E.g,E.b,F.r,F.g,F.b)):A&&w.push(0,0,0,0,0,0,0,0,0);D=n.GetNormal(C.n0);E=n.GetNormal(C.n1);F=n.GetNormal(C.n2);x.push(D.x,D.y,D.z,E.x,E.y,E.z,F.x,F.y,F.z);C.HasTextureUVs()?(D=n.GetTextureUV(C.u0),E=n.GetTextureUV(C.u1),F=n.GetTextureUV(C.u2),y.push(D.x,D.y,E.x,E.y,F.x,F.y)):G&&y.push(0,0,0,0,0,0);C=C.mat;u.has(C)||
(u.set(C,p.length),p.push(m[C]),k.push(C),0<B&&(z[z.length-1].end=B-1,z.push({start:z[z.length-1].end+1,end:-1})))}z[z.length-1].end=r-1;t.setAttribute("position",new THREE.Float32BufferAttribute(v,3));0!==w.length&&t.setAttribute("color",new THREE.Float32BufferAttribute(w,3));t.setAttribute("normal",new THREE.Float32BufferAttribute(x,3));0!==y.length&&t.setAttribute("uv",new THREE.Float32BufferAttribute(y,2));for(m=0;m<z.length;m++)r=z[m],t.addGroup(3*r.start,3*(r.end-r.start+1),m);m=new THREE.Mesh(t,
p);m.userData={originalMeshId:l,originalMaterials:k,threeMaterials:null};return m}d=new OV.ThreeConversionStateHandler(d);let g=OV.GetShadingType(a),h=[];for(let k=0;k<a.MaterialCount();k++){let l=e(d,a,k,g,b,c);h.push(l)}(function(k,l,m,n){let r=l.GetRootNode(),q=(new OV.ThreeNodeTree(r,k)).GetMeshInstances();OV.RunTasksBatch(q.length,100,{runTask:(t,p,u)=>{for(;t<=p;t++){var v=q[t],w=v.threeNode,x=new OV.MeshInstanceId(v.node.GetId(),v.meshIndex);v=l;var y=m;let z=v.GetMesh(x.meshIndex);OV.GetMeshType(z)===
OV.MeshType.TriangleMesh&&(v=f(v,x,y),w.add(v))}u()},onReady:()=>{n.OnModelLoaded(k)}})})(new THREE.Object3D,a,h,d)};OV.ThreeModelLoader=class{constructor(){this.importer=new OV.Importer;this.inProgress=!1;this.defaultMaterial=null;this.hasHighpDriverIssue=OV.HasHighpDriverIssue()}InProgress(){return this.inProgress}LoadModel(a,b,c,d){this.inProgress||(this.inProgress=!0,d.onLoadStart(),this.importer.ImportFiles(a,b,c,{onFilesLoaded:()=>{d.onImportStart()},onSelectMainFile:(e,f)=>{if(d.onSelectMainFile)d.onSelectMainFile(e,f);else f(0)},onImportSuccess:e=>{d.onVisualizationStart();let f=new OV.ModelToThreeConversionParams;
f.forceMediumpForMaterials=this.hasHighpDriverIssue;let g=new OV.ModelToThreeConversionOutput;OV.ConvertModelToThreeObject(e.model,f,g,{onTextureLoaded:()=>{d.onTextureLoaded()},onModelLoaded:h=>{this.defaultMaterial=g.defaultMaterial;d.onModelFinished(e,h);this.inProgress=!1}})},onImportError:e=>{d.onLoadError(e);this.inProgress=!1}}))}GetImporter(){return this.importer}GetDefaultMaterial(){return this.defaultMaterial}ReplaceDefaultMaterialColor(a){null===this.defaultMaterial||this.defaultMaterial.vertexColors||
(this.defaultMaterial.color=OV.ConvertColorToThreeColor(a))}};OV.ParameterConverter={IntegerToString(a){return a.toString()},StringToInteger(a){return parseInt(a,10)},NumberToString(a){return a.toPrecision(5)},StringToNumber(a){return parseFloat(a)},ModelUrlsToString:function(a){return null===a?null:a.join(",")},StringToModelUrls:function(a){return null===a||0===a.length?null:a.split(",")},CameraToString:function(a){return null===a?null:[this.NumberToString(a.eye.x),this.NumberToString(a.eye.y),this.NumberToString(a.eye.z),this.NumberToString(a.center.x),this.NumberToString(a.center.y),
this.NumberToString(a.center.z),this.NumberToString(a.up.x),this.NumberToString(a.up.y),this.NumberToString(a.up.z)].join()},StringToCamera:function(a){if(null===a||0===a.length)return null;a=a.split(",");return 9!==a.length?null:new OV.Camera(new OV.Coord3D(this.StringToNumber(a[0]),this.StringToNumber(a[1]),this.StringToNumber(a[2])),new OV.Coord3D(this.StringToNumber(a[3]),this.StringToNumber(a[4]),this.StringToNumber(a[5])),new OV.Coord3D(this.StringToNumber(a[6]),this.StringToNumber(a[7]),this.StringToNumber(a[8])))},
ColorToString:function(a){return null===a?null:[this.IntegerToString(a.r),this.IntegerToString(a.g),this.IntegerToString(a.b)].join()},StringToColor:function(a){if(null===a||0===a.length)return null;a=a.split(",");return 3!==a.length?null:new OV.Color(this.StringToInteger(a[0]),this.StringToInteger(a[1]),this.StringToInteger(a[2]))},EdgeSettingsToString:function(a){return null===a?null:[a.showEdges?"on":"off",this.ColorToString(a.edgeColor),this.IntegerToString(a.edgeThreshold)].join()},StringToEdgeSettings:function(a){if(null===
a||0===a.length)return null;a=a.split(",");return 5!==a.length?null:{showEdges:"on"===a[0]?!0:!1,edgeColor:new OV.Color(this.StringToInteger(a[1]),this.StringToInteger(a[2]),this.StringToInteger(a[3])),edgeThreshold:this.StringToInteger(a[4])}}};
OV.ParameterListBuilder=class{constructor(a){this.separator=a;this.paramList=""}AddModelUrls(a){this.AddUrlPart("model",OV.ParameterConverter.ModelUrlsToString(a));return this}AddCamera(a){this.AddUrlPart("camera",OV.ParameterConverter.CameraToString(a));return this}AddBackgroundColor(a){this.AddUrlPart("backgroundcolor",OV.ParameterConverter.ColorToString(a));return this}AddDefaultColor(a){this.AddUrlPart("defaultcolor",OV.ParameterConverter.ColorToString(a));return this}AddEdgeSettings(a){this.AddUrlPart("edgesettings",
OV.ParameterConverter.EdgeSettingsToString(a));return this}AddUrlPart(a,b){null!==a&&null!==b&&(0<this.paramList.length&&(this.paramList+=this.separator),this.paramList+=a+"="+b)}GetParameterList(){return this.paramList}};
OV.ParameterListParser=class{constructor(a,b){this.separator=b;this.paramList=a}GetModelUrls(){if(-1===this.paramList.indexOf("="))return this.paramList.split(",");let a=this.GetKeywordParams("model");return OV.ParameterConverter.StringToModelUrls(a)}GetCamera(){let a=this.GetKeywordParams("camera");return OV.ParameterConverter.StringToCamera(a)}GetBackgroundColor(){let a=this.GetKeywordParams("backgroundcolor");return OV.ParameterConverter.StringToColor(a)}GetDefaultColor(){let a=this.GetKeywordParams("defaultcolor");
return OV.ParameterConverter.StringToColor(a)}GetEdgeSettings(){let a=this.GetKeywordParams("edgesettings");return OV.ParameterConverter.StringToEdgeSettings(a)}GetKeywordParams(a){if(null===this.paramList||0===this.paramList.length)return null;a+="=";let b=this.paramList.split(this.separator);for(let c=0;c<b.length;c++){let d=b[c];if(d.startsWith(a))return d.substr(a.length)}return null}};OV.CreateUrlBuilder=function(){return new OV.ParameterListBuilder("$")};
OV.CreateUrlParser=function(a){return new OV.ParameterListParser(a,"$")};OV.CreateModelUrlParameters=function(a){let b=OV.CreateUrlBuilder();b.AddModelUrls(a);return b.GetParameterList()};OV.GetIntegerFromStyle=function(a){return Math.round(parseFloat(a))};OV.GetDomElementExternalWidth=function(a){let b=OV.GetIntegerFromStyle(a.paddingLeft)+OV.GetIntegerFromStyle(a.paddingRight),c=OV.GetIntegerFromStyle(a.borderLeftWidth)+OV.GetIntegerFromStyle(a.borderRightWidth);a=OV.GetIntegerFromStyle(a.marginLeft)+OV.GetIntegerFromStyle(a.marginRight);return b+c+a};
OV.GetDomElementExternalHeight=function(a){let b=OV.GetIntegerFromStyle(a.paddingTop)+OV.GetIntegerFromStyle(a.paddingBottom),c=OV.GetIntegerFromStyle(a.borderTopWidth)+OV.GetIntegerFromStyle(a.borderBottomWidth);a=OV.GetIntegerFromStyle(a.marginTop)+OV.GetIntegerFromStyle(a.marginBottom);return b+c+a};OV.GetDomElementInnerDimensions=function(a,b,c){a=getComputedStyle(a);b-=OV.GetDomElementExternalWidth(a);c-=OV.GetDomElementExternalHeight(a);return{width:b,height:c}};
OV.GetDomElementClientCoordinates=function(a,b,c){a.getBoundingClientRect&&(a=a.getBoundingClientRect(),b-=a.left,c-=a.top);window.pageXOffset&&window.pageYOffset&&(b+=window.pageXOffset,c+=window.pageYOffset);return new OV.Coord2D(b,c)};OV.CreateDomElement=function(a,b,c){a=document.createElement(a);b&&(a.className=b);c&&(a.innerHTML=c);return a};OV.AddDomElement=function(a,b,c,d){b=OV.CreateDomElement(b,c,d);a.appendChild(b);return b};OV.ClearDomElement=function(a){for(;a.firstChild;)a.removeChild(a.firstChild)};
OV.InsertDomElementBefore=function(a,b){b.parentNode.insertBefore(a,b)};OV.InsertDomElementAfter=function(a,b){b.parentNode.insertBefore(a,b.nextSibling)};OV.ShowDomElement=function(a,b){a.style.display=b?"block":"none"};OV.IsDomElementVisible=function(a){return null!==a.offsetParent};OV.SetDomElementWidth=function(a,b){a.style.width=b.toString()+"px"};OV.SetDomElementHeight=function(a,b){a.style.height=b.toString()+"px"};
OV.GetDomElementOuterWidth=function(a){let b=getComputedStyle(a);return a.offsetWidth+OV.GetIntegerFromStyle(b.marginLeft)+OV.GetIntegerFromStyle(b.marginRight)};OV.GetDomElementOuterHeight=function(a){let b=getComputedStyle(a);return a.offsetHeight+OV.GetIntegerFromStyle(b.marginTop)+OV.GetIntegerFromStyle(b.marginBottom)};OV.SetDomElementOuterWidth=function(a,b){let c=getComputedStyle(a);OV.SetDomElementWidth(a,b-OV.GetDomElementExternalWidth(c))};
OV.SetDomElementOuterHeight=function(a,b){let c=getComputedStyle(a);OV.SetDomElementHeight(a,b-OV.GetDomElementExternalHeight(c))};OV.AddRadioButton=function(a,b,c,d,e){a=OV.AddDomElement(a,"label");a.setAttribute("for",c);let f=OV.AddDomElement(a,"input","ov_radio_button");f.setAttribute("type","radio");f.setAttribute("id",c);f.setAttribute("name",b);OV.AddDomElement(a,"span",null,d);e&&f.addEventListener("change",e);return f};
OV.AddCheckbox=function(a,b,c,d,e){a=OV.AddDomElement(a,"label");a.setAttribute("for",b);let f=OV.AddDomElement(a,"input","ov_checkbox");f.setAttribute("type","checkbox");f.setAttribute("id",b);f.checked=d;OV.AddDomElement(a,"span",null,c);e&&f.addEventListener("change",e);return f};OV.AddRangeSlider=function(a,b,c){a=OV.AddDomElement(a,"input","ov_slider");a.setAttribute("type","range");a.setAttribute("min",b.toString());a.setAttribute("max",c.toString());return a};
OV.AddSelect=function(a,b,c,d){a=OV.AddDiv(a,"ov_select_container");let e=OV.AddDomElement(a,"select","ov_select");for(let f of b)OV.AddDomElement(e,"option",null,f);e.selectedIndex=c;d&&e.addEventListener("change",()=>{d(e.selectedIndex)});return e};
OV.AddToggle=function(a,b){let c=!1,d=null,e="ov_toggle";b&&(e+=" "+b);let f=OV.AddDiv(a,e);OV.AddDiv(f,"ov_toggle_slider");f.addEventListener("click",()=>{(c=!c)?f.classList.add("on"):f.classList.remove("on");d&&d()});return{element:f,GetStatus:()=>c,SetStatus:g=>{(c=g)?f.classList.add("on"):f.classList.remove("on")},OnChange:g=>{d=g}}};OV.CreateDiv=function(a,b){return OV.CreateDomElement("div",a,b)};OV.AddDiv=function(a,b,c){return OV.AddDomElement(a,"div",b,c)};OV.Camera=class{constructor(a,b,c){this.eye=a;this.center=b;this.up=c}Clone(){return new OV.Camera(this.eye.Clone(),this.center.Clone(),this.up.Clone())}};OV.CameraIsEqual3D=function(a,b){return OV.CoordIsEqual3D(a.eye,b.eye)&&OV.CoordIsEqual3D(a.center,b.center)&&OV.CoordIsEqual3D(a.up,b.up)};
OV.MouseInteraction=class{constructor(){this.prev=new OV.Coord2D(0,0);this.curr=new OV.Coord2D(0,0);this.diff=new OV.Coord2D(0,0);this.buttons=[]}Down(a,b){this.buttons.push(b.which);this.curr=this.GetPositionFromEvent(a,b);this.prev=this.curr.Clone()}Move(a,b){this.curr=this.GetPositionFromEvent(a,b);this.diff=OV.SubCoord2D(this.curr,this.prev);this.prev=this.curr.Clone()}Up(a,b){let c=this.buttons.indexOf(b.which);-1!==c&&this.buttons.splice(c,1);this.curr=this.GetPositionFromEvent(a,b)}Leave(a,
b){this.buttons=[];this.curr=this.GetPositionFromEvent(a,b)}IsButtonDown(){return 0<this.buttons.length}GetButton(){let a=this.buttons.length;return 0===a?0:this.buttons[a-1]}GetPosition(){return this.curr}GetMoveDiff(){return this.diff}GetPositionFromEvent(a,b){return OV.GetDomElementClientCoordinates(a,b.clientX,b.clientY)}};
OV.TouchInteraction=class{constructor(){this.prevPos=new OV.Coord2D(0,0);this.currPos=new OV.Coord2D(0,0);this.diffPos=new OV.Coord2D(0,0);this.fingers=this.diffDist=this.currDist=this.prevDist=0}Start(a,b){0!==b.touches.length&&(this.fingers=b.touches.length,this.currPos=this.GetPositionFromEvent(a,b),this.prevPos=this.currPos.Clone(),this.prevDist=this.currDist=this.GetTouchDistanceFromEvent(a,b))}Move(a,b){0!==b.touches.length&&(this.currPos=this.GetPositionFromEvent(a,b),this.diffPos=OV.SubCoord2D(this.currPos,
this.prevPos),this.prevPos=this.currPos.Clone(),this.currDist=this.GetTouchDistanceFromEvent(a,b),this.diffDist=this.currDist-this.prevDist,this.prevDist=this.currDist)}End(a,b){0!==b.touches.length&&(this.fingers=0,this.currPos=this.GetPositionFromEvent(a,b),this.currDist=this.GetTouchDistanceFromEvent(a,b))}IsFingerDown(){return 0!==this.fingers}GetFingerCount(){return this.fingers}GetPosition(){return this.currPos}GetMoveDiff(){return this.diffPos}GetDistanceDiff(){return this.diffDist}GetPositionFromEvent(a,
b){let c=null;0!==b.touches.length&&(b=b.touches[0],c=OV.GetDomElementClientCoordinates(a,b.pageX,b.pageY));return c}GetTouchDistanceFromEvent(a,b){if(2!==b.touches.length)return 0;let c=b.touches[0];b=b.touches[1];return OV.CoordDistance2D(OV.GetDomElementClientCoordinates(a,c.pageX,c.pageY),OV.GetDomElementClientCoordinates(a,b.pageX,b.pageY))}};
OV.ClickDetector=class{constructor(){this.isClick=!1;this.startPosition=null}Start(a){this.isClick=!0;this.startPosition=a}Move(a){this.isClick&&(null!==this.startPosition?3<OV.CoordDistance2D(this.startPosition,a)&&this.Cancel():this.Cancel())}End(){this.startPosition=null}Cancel(){this.isClick=!1;this.startPosition=null}IsClick(){return this.isClick}};OV.NavigationType={None:0,Orbit:1,Pan:2,Zoom:3};
OV.Navigation=class{constructor(a,b,c){this.canvas=a;this.camera=b;this.callbacks=c;this.fixUpVector=!0;this.mouse=new OV.MouseInteraction;this.touch=new OV.TouchInteraction;this.clickDetector=new OV.ClickDetector;this.onContext=this.onMouseMove=this.onMouseClick=null;this.canvas.addEventListener&&(this.canvas.addEventListener("mousedown",this.OnMouseDown.bind(this)),this.canvas.addEventListener("wheel",this.OnMouseWheel.bind(this)),this.canvas.addEventListener("touchstart",this.OnTouchStart.bind(this)),
this.canvas.addEventListener("touchmove",this.OnTouchMove.bind(this)),this.canvas.addEventListener("touchcancel",this.OnTouchEnd.bind(this)),this.canvas.addEventListener("touchend",this.OnTouchEnd.bind(this)),this.canvas.addEventListener("contextmenu",this.OnContextMenu.bind(this)));document.addEventListener&&(document.addEventListener("mousemove",this.OnMouseMove.bind(this)),document.addEventListener("mouseup",this.OnMouseUp.bind(this)),document.addEventListener("mouseleave",this.OnMouseLeave.bind(this)))}SetMouseClickHandler(a){this.onMouseClick=
a}SetMouseMoveHandler(a){this.onMouseMove=a}SetContextMenuHandler(a){this.onContext=a}IsFixUpVector(){return this.fixUpVector}SetFixUpVector(a){this.fixUpVector=a}GetCamera(){return this.camera}SetCamera(a){this.camera=a}MoveCamera(a,b){function c(d,e,f,g){d.camera.eye=e.eye[g];d.camera.center=e.center[g];d.camera.up=e.up[g];d.Update();g<f-1&&requestAnimationFrame(()=>{c(d,e,f,g+1)})}if(null!==a){if(0===b||OV.CameraIsEqual3D(this.camera,a))this.camera=a;else{let d=OV.ParabolicTweenFunction,e={eye:OV.TweenCoord3D(this.camera.eye,
a.eye,b,d),center:OV.TweenCoord3D(this.camera.center,a.center,b,d),up:OV.TweenCoord3D(this.camera.up,a.up,b,d)};requestAnimationFrame(()=>{c(this,e,b,0)})}this.Update()}}GetFitToSphereCamera(a,b,c){if(OV.IsZero(b))return null;let d=this.camera.Clone(),e=OV.SubCoord3D(d.center,a);d.eye=OV.SubCoord3D(d.eye,e);d.center=a.Clone();a=OV.SubCoord3D(d.eye,d.center).Normalize();c/=2;this.canvas.width<this.canvas.height&&(c=c*this.canvas.width/this.canvas.height);b/=Math.sin(c*OV.DegRad);d.eye=d.center.Clone().Offset(a,
b);return d}OnMouseDown(a){a.preventDefault();this.mouse.Down(this.canvas,a);this.clickDetector.Start(this.mouse.GetPosition())}OnMouseMove(a){this.mouse.Move(this.canvas,a);this.clickDetector.Move(this.mouse.GetPosition());if(this.onMouseMove){var b=OV.GetDomElementClientCoordinates(this.canvas,a.clientX,a.clientY);this.onMouseMove(b)}if(this.mouse.IsButtonDown()){b=this.mouse.GetMoveDiff();var c=this.mouse.GetButton(),d=OV.NavigationType.None;if(1===c)d=a.ctrlKey?OV.NavigationType.Zoom:a.shiftKey?
OV.NavigationType.Pan:OV.NavigationType.Orbit;else if(2===c||3===c)d=OV.NavigationType.Pan;d===OV.NavigationType.Orbit?this.Orbit(.5*b.x,.5*b.y):d===OV.NavigationType.Pan?(a=.001*OV.CoordDistance3D(this.camera.eye,this.camera.center),this.Pan(b.x*a,b.y*a)):d===OV.NavigationType.Zoom&&this.Zoom(.005*-b.y);this.Update()}}OnMouseUp(a){this.mouse.Up(this.canvas,a);this.clickDetector.End();if(this.clickDetector.IsClick()){let b=this.mouse.GetPosition();this.Click(a.which,b)}}OnMouseLeave(a){this.mouse.Leave(this.canvas,
a);this.clickDetector.Cancel()}OnTouchStart(a){a.preventDefault();this.touch.Start(this.canvas,a);this.clickDetector.Start(this.touch.GetPosition())}OnTouchMove(a){a.preventDefault();this.touch.Move(this.canvas,a);this.clickDetector.Move(this.touch.GetPosition());if(this.touch.IsFingerDown()){a=this.touch.GetMoveDiff();var b=this.touch.GetDistanceDiff(),c=this.touch.GetFingerCount(),d=OV.NavigationType.None;1===c?d=OV.NavigationType.Orbit:2===c&&(d=OV.NavigationType.Pan);d===OV.NavigationType.Orbit?
this.Orbit(.5*a.x,.5*a.y):d===OV.NavigationType.Pan&&(this.Zoom(.005*b),b=.001*OV.CoordDistance3D(this.camera.eye,this.camera.center),this.Pan(a.x*b,a.y*b));this.Update()}}OnTouchEnd(a){a.preventDefault();this.touch.End(this.canvas,a);this.clickDetector.End();this.clickDetector.IsClick()&&(a=this.touch.GetPosition(),1===this.touch.GetFingerCount()&&this.Click(1,a))}OnMouseWheel(a){a.preventDefault();let b=.1;0>-(a||window.event).deltaY/40&&(b*=-1);this.Zoom(b);this.Update()}OnContextMenu(a){a.preventDefault();
this.clickDetector.IsClick()&&(this.Context(a.clientX,a.clientY),this.clickDetector.Cancel())}Orbit(a,b){a*=OV.DegRad;b*=OV.DegRad;var c=OV.SubCoord3D(this.camera.center,this.camera.eye).Normalize();let d=OV.CrossVector3D(c,this.camera.up).Normalize();this.fixUpVector?(c=OV.VectorAngle3D(c,this.camera.up)+b,OV.IsGreater(c,0)&&OV.IsLower(c,Math.PI)&&this.camera.eye.Rotate(d,-b,this.camera.center),this.camera.eye.Rotate(this.camera.up,-a,this.camera.center)):(c=OV.CrossVector3D(d,c).Normalize(),this.camera.eye.Rotate(d,
-b,this.camera.center),this.camera.eye.Rotate(c,-a,this.camera.center),this.camera.up=c)}Pan(a,b){var c=OV.SubCoord3D(this.camera.center,this.camera.eye).Normalize();let d=OV.CrossVector3D(c,this.camera.up).Normalize();c=OV.CrossVector3D(d,c).Normalize();this.camera.eye.Offset(d,-a);this.camera.center.Offset(d,-a);this.camera.eye.Offset(c,b);this.camera.center.Offset(c,b)}Zoom(a){let b=OV.SubCoord3D(this.camera.center,this.camera.eye),c=b.Length();this.camera.eye.Offset(b,c*a)}Update(){this.callbacks.onUpdate()}Click(a,
b){if(this.onMouseClick)this.onMouseClick(a,b)}Context(a,b){if(this.onContext){let c={x:a,y:b};a=OV.GetDomElementClientCoordinates(this.canvas,a,b);this.onContext(c,a)}}};OV.SetThreeMeshPolygonOffset=function(a,b){function c(d,e){for(let f of d)f.polygonOffset=e,f.polygonOffsetUnit=1,f.polygonOffsetFactor=1}c(a.material,b);a.userData.threeMaterials&&c(a.userData.threeMaterials,b)};
OV.ViewerGeometry=class{constructor(a){this.scene=a;this.mainEdgeObject=this.mainGridObject=this.mainObject=null;this.gridSettings={showGrid:!1};this.edgeSettings={showEdges:!1,edgeColor:new OV.Color(0,0,0),edgeThreshold:1}}SetMainObject(a){this.mainObject=a;this.scene.add(this.mainObject);this.gridSettings.showGrid&&this.GenerateMainGridObject();this.edgeSettings.showEdges&&this.GenerateMainEdgeObject()}UpdateWorldMatrix(){null!==this.mainObject&&this.mainObject.updateWorldMatrix(!0,!0)}SetGridSettings(a){this.gridSettings.showGrid=
a;null!==this.mainObject&&(this.gridSettings.showGrid?(this.ClearMainGridObject(),this.GenerateMainGridObject()):this.ClearMainGridObject())}SetEdgeSettings(a,b,c){let d=!1;!a||this.edgeSettings.showEdges&&this.edgeSettings.edgeThreshold===c||(d=!0);this.edgeSettings.showEdges=a;this.edgeSettings.edgeThreshold=c;this.edgeSettings.edgeColor=b;if(null!==this.mainObject)if(this.edgeSettings.showEdges)if(d)this.ClearMainEdgeObject(),this.GenerateMainEdgeObject();else{let e=OV.ConvertColorToThreeColor(this.edgeSettings.edgeColor);
this.EnumerateEdges(f=>{f.material.color=e})}else this.ClearMainEdgeObject()}GenerateMainGridObject(){function a(r,q,t){r=[r,q];r=(new THREE.BufferGeometry).setFromPoints(r);return new THREE.Line(r,t)}this.UpdateWorldMatrix();var b=this.GetBoundingBox(r=>!0);if(null!==b){this.mainGridObject=new THREE.Object3D;var c=new THREE.LineBasicMaterial({color:8947848}),d=new THREE.LineBasicMaterial({color:14540253}),e=new THREE.Vector3;b.getSize(e);e=new THREE.Vector2(b.min.z-1,b.min.x-1);var f=new THREE.Vector2(b.max.z+
1,b.max.x+1);e=new THREE.Vector2(1*Math.floor(e.x/1),1*Math.floor(e.y/1));f=new THREE.Vector2(1*Math.ceil(f.x/1),1*Math.ceil(f.y/1));b=b.min.y;var g=Math.floor(f.x-e.x),h=Math.floor(f.y-e.y);for(var k=0;k<g+1;k++){var l=e.x+1*k,m=new THREE.Vector3(e.y,b,l),n=new THREE.Vector3(f.y,b,l);l=OV.IsEqual(l,0)?c:d;this.mainGridObject.add(a(m,n,l))}for(g=0;g<h+1;g++)n=e.y+1*g,k=new THREE.Vector3(n,b,e.x),m=new THREE.Vector3(n,b,f.x),n=OV.IsEqual(n,0)?c:d,this.mainGridObject.add(a(k,m,n));this.scene.add(this.mainGridObject)}}GenerateMainEdgeObject(){let a=
OV.ConvertColorToThreeColor(this.edgeSettings.edgeColor);this.mainEdgeObject=new THREE.Object3D;this.UpdateWorldMatrix();this.EnumerateMeshes(b=>{OV.SetThreeMeshPolygonOffset(b,!0);var c=new THREE.EdgesGeometry(b.geometry,this.edgeSettings.edgeThreshold);c=new THREE.LineSegments(c,new THREE.LineBasicMaterial({color:a}));c.applyMatrix4(b.matrixWorld);c.userData=b.userData;c.visible=b.visible;this.mainEdgeObject.add(c)});this.scene.add(this.mainEdgeObject)}GetBoundingBox(a){let b=!1,c=new THREE.Box3;
this.EnumerateMeshes(d=>{a(d.userData)&&(c.union((new THREE.Box3).setFromObject(d)),b=!0)});return b?c:null}GetBoundingSphere(a){a=this.GetBoundingBox(a);if(null===a)return null;let b=new THREE.Sphere;a.getBoundingSphere(b);return b}Clear(){this.ClearMainObject();this.ClearMainGridObject();this.ClearMainEdgeObject()}ClearMainObject(){null!==this.mainObject&&(this.EnumerateMeshes(a=>{a.geometry.dispose()}),this.scene.remove(this.mainObject),this.mainObject=null)}ClearMainGridObject(){null!==this.mainGridObject&&
(this.mainGridObject.traverse(a=>{a.isLineSegments&&a.geometry.dispose()}),this.scene.remove(this.mainGridObject),this.mainGridObject=null)}ClearMainEdgeObject(){null!==this.mainEdgeObject&&(this.EnumerateMeshes(a=>{OV.SetThreeMeshPolygonOffset(a,!1)}),this.EnumerateEdges(a=>{a.geometry.dispose()}),this.scene.remove(this.mainEdgeObject),this.mainEdgeObject=null)}EnumerateMeshes(a){null!==this.mainObject&&this.mainObject.traverse(b=>{b.isMesh&&a(b)})}EnumerateEdges(a){null!==this.mainEdgeObject&&this.mainEdgeObject.traverse(b=>
{b.isLineSegments&&a(b)})}GetMeshIntersectionUnderMouse(a,b,c,d){if(null===this.mainObject)return null;let e=new THREE.Raycaster,f=new THREE.Vector2;f.x=a.x/c*2-1;f.y=2*-(a.y/d)+1;e.setFromCamera(f,b);a=e.intersectObject(this.mainObject,!0);for(b=0;b<a.length;b++)if(c=a[b],"Mesh"===c.object.type&&c.object.visible)return c;return null}};
OV.ViewerExtraGeometry=class{constructor(a){this.scene=a;this.mainObject=null}AddObject(a){null===this.mainObject&&(this.mainObject=new THREE.Object3D,this.scene.add(this.mainObject));this.mainObject.add(a)}Clear(){null!==this.mainObject&&(this.mainObject.traverse(a=>{(a.isMesh||a.isLineSegments)&&a.geometry.dispose()}),this.scene.remove(this.mainObject),this.mainObject=null)}};OV.GetDefaultCamera=function(a){return a===OV.Direction.X?new OV.Camera(new OV.Coord3D(2,-3,1.5),new OV.Coord3D(0,0,0),new OV.Coord3D(1,0,0)):a===OV.Direction.Y?new OV.Camera(new OV.Coord3D(-1.5,2,3),new OV.Coord3D(0,0,0),new OV.Coord3D(0,1,0)):a===OV.Direction.Z?new OV.Camera(new OV.Coord3D(-1.5,-3,2),new OV.Coord3D(0,0,0),new OV.Coord3D(0,0,1)):null};OV.TraverseThreeObject=function(a,b){if(!b(a))return!1;for(let c of a.children)if(!OV.TraverseThreeObject(c,b))return!1;return!0};
OV.GetShadingTypeOfObject=function(a){let b=null;OV.TraverseThreeObject(a,c=>{if(c.isMesh)for(const d of c.material)return"MeshPhongMaterial"===d.type?b=OV.ShadingType.Phong:"MeshStandardMaterial"===d.type&&(b=OV.ShadingType.Physical),!1;return!0});return b};
OV.UpVector=class{constructor(){this.direction=OV.Direction.Z;this.isFixed=!0;this.isFlipped=!1}SetDirection(a,b){this.direction=a;this.isFlipped=!1;a=OV.GetDefaultCamera(this.direction);a=OV.SubCoord3D(a.eye,a.center);let c=OV.CoordDistance3D(b.center,b.eye);a=b.center.Clone().Offset(a,c);b=b.Clone();this.direction===OV.Direction.X&&(b.up=new OV.Coord3D(1,0,0),b.eye=a);this.direction===OV.Direction.Y?(b.up=new OV.Coord3D(0,1,0),b.eye=a):this.direction===OV.Direction.Z&&(b.up=new OV.Coord3D(0,0,1),
b.eye=a);return b}SetFixed(a,b){return(this.isFixed=a)?this.SetDirection(this.direction,b):null}Flip(a){this.isFlipped=!this.isFlipped;a=a.Clone();a.up.MultiplyScalar(-1);return a}};
OV.ShadingModel=class{constructor(a){this.scene=a;this.type=OV.ShadingType.Phong;this.ambientLight=new THREE.AmbientLight(8947848);this.directionalLight=new THREE.DirectionalLight(8947848);this.environment=null;this.scene.add(this.ambientLight);this.scene.add(this.directionalLight)}SetType(a){this.type=a;this.type===OV.ShadingType.Phong?(this.ambientLight.color.set(8947848),this.directionalLight.color.set(8947848),this.scene.environment=null):this.type===OV.ShadingType.Physical&&(this.ambientLight.color.set(0),
this.directionalLight.color.set(5592405),this.scene.environment=this.environment)}SetEnvironment(a,b){this.environment=(new THREE.CubeTextureLoader).load(a,()=>{b()})}UpdateByCamera(a){a=OV.SubCoord3D(a.eye,a.center);this.directionalLight.position.set(a.x,a.y,a.z)}CreateHighlightMaterial(a,b){let c=null;this.type===OV.ShadingType.Phong?c=new THREE.MeshPhongMaterial({color:a,side:THREE.DoubleSide}):this.type===OV.ShadingType.Physical&&(c=new THREE.MeshStandardMaterial({color:a,side:THREE.DoubleSide}));
null!==c&&b&&(c.polygonOffset=!0,c.polygonOffsetUnit=1,c.polygonOffsetFactor=1);return c}};
OV.Viewer=class{constructor(){this.upVector=this.navigation=this.shading=this.camera=this.extraGeometry=this.geometry=this.scene=this.renderer=this.canvas=null;this.settings={animationSteps:40}}Init(a){this.canvas=a;this.canvas.id="viewer";this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0});window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.setClearColor("#ffffff",1);this.renderer.setSize(this.canvas.width,this.canvas.height);this.scene=
new THREE.Scene;this.geometry=new OV.ViewerGeometry(this.scene);this.extraGeometry=new OV.ViewerExtraGeometry(this.scene);this.InitNavigation();this.InitShading();this.Render()}SetMouseClickHandler(a){this.navigation.SetMouseClickHandler(a)}SetMouseMoveHandler(a){this.navigation.SetMouseMoveHandler(a)}SetContextMenuHandler(a){this.navigation.SetContextMenuHandler(a)}SetBackgroundColor(a){a="#"+OV.ColorToHexString(a);this.renderer.setClearColor(a,1);this.Render()}SetGridSettings(a){this.geometry.SetGridSettings(a);
this.Render()}SetEdgeSettings(a,b,c){this.geometry.SetEdgeSettings(a,b,c);this.Render()}SetEnvironmentMap(a){this.shading.SetEnvironment(a,()=>{this.Render()})}GetCanvas(){return this.canvas}GetCamera(){return this.navigation.GetCamera()}SetCamera(a){this.navigation.SetCamera(a);this.Render()}Resize(a,b){a=OV.GetDomElementInnerDimensions(this.canvas,a,b);this.ResizeRenderer(a.width,a.height)}ResizeRenderer(a,b){window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio);this.camera.aspect=
a/b;this.camera.updateProjectionMatrix();this.renderer.setSize(a,b);this.Render()}FitSphereToWindow(a,b){if(null!==a){var c=new OV.Coord3D(a.center.x,a.center.y,a.center.z);a=this.navigation.GetFitToSphereCamera(c,a.radius,this.camera.fov);this.navigation.MoveCamera(a,b?this.settings.animationSteps:0)}}AdjustClippingPlanesToSphere(a){null!==a&&(10>a.radius?(this.camera.near=.01,this.camera.far=100):100>a.radius?(this.camera.near=.1,this.camera.far=1E3):1E3>a.radius?(this.camera.near=10,this.camera.far=
1E4):(this.camera.near=100,this.camera.far=1E6),this.camera.updateProjectionMatrix(),this.Render())}IsFixUpVector(){return this.navigation.IsFixUpVector()}SetFixUpVector(a){var b=this.navigation.GetCamera();b=this.upVector.SetFixed(a,b);this.navigation.SetFixUpVector(a);null!==b&&this.navigation.MoveCamera(b,this.settings.animationSteps);this.Render()}SetUpVector(a,b){let c=this.navigation.GetCamera();a=this.upVector.SetDirection(a,c);this.navigation.MoveCamera(a,b?this.settings.animationSteps:0);
this.Render()}FlipUpVector(){var a=this.navigation.GetCamera();a=this.upVector.Flip(a);this.navigation.MoveCamera(a,0);this.Render()}Render(){let a=this.navigation.GetCamera();this.camera.position.set(a.eye.x,a.eye.y,a.eye.z);this.camera.up.set(a.up.x,a.up.y,a.up.z);this.camera.lookAt(new THREE.Vector3(a.center.x,a.center.y,a.center.z));this.shading.UpdateByCamera(a);this.renderer.render(this.scene,this.camera)}SetMainObject(a){const b=OV.GetShadingTypeOfObject(a);this.geometry.SetMainObject(a);this.shading.SetType(b);
this.Render()}AddExtraObject(a){this.extraGeometry.AddObject(a);this.Render()}Clear(){this.geometry.Clear();this.extraGeometry.Clear();this.Render()}ClearExtra(){this.extraGeometry.Clear();this.Render()}SetMeshesVisibility(a){this.geometry.EnumerateMeshes(b=>{let c=a(b.userData);b.visible!==c&&(b.visible=c)});this.geometry.EnumerateEdges(b=>{let c=a(b.userData);b.visible!==c&&(b.visible=c)});this.Render()}SetMeshesHighlight(a,b){const c=this.CreateHighlightMaterial(a);this.geometry.EnumerateMeshes(d=>
{if(b(d.userData)){if(null===d.userData.threeMaterials){var e=d.userData.threeMaterials=d.material;let f=[];for(let g=0;g<e.length;g++)f.push(c);d.material=f}}else null!==d.userData.threeMaterials&&(d.material=d.userData.threeMaterials,d.userData.threeMaterials=null)});this.Render()}CreateHighlightMaterial(a){return this.shading.CreateHighlightMaterial(a,this.geometry.edgeSettings.showEdges)}GetMeshUserDataUnderMouse(a){a=this.GetMeshIntersectionUnderMouse(a);return null===a?null:a.object.userData}GetMeshIntersectionUnderMouse(a){let b=
this.GetCanvasSize();a=this.geometry.GetMeshIntersectionUnderMouse(a,this.camera,b.width,b.height);return null===a?null:a}GetBoundingBox(a){return this.geometry.GetBoundingBox(a)}GetBoundingSphere(a){return this.geometry.GetBoundingSphere(a)}EnumerateMeshesUserData(a){this.geometry.EnumerateMeshes(b=>{a(b.userData)})}InitNavigation(){this.camera=new THREE.PerspectiveCamera(45,this.canvas.width/this.canvas.height,.1,1E3);this.scene.add(this.camera);let a=this.renderer.domElement,b=OV.GetDefaultCamera(OV.Direction.Z);
this.navigation=new OV.Navigation(a,b,{onUpdate:()=>{this.Render()}});this.upVector=new OV.UpVector}InitShading(){this.shading=new OV.ShadingModel(this.scene)}GetImageSize(){let a=new THREE.Vector2;this.renderer.getSize(a);return{width:parseInt(a.x,10),height:parseInt(a.y,10)}}GetCanvasSize(){let a=this.canvas.width,b=this.canvas.height;window.devicePixelRatio&&(a/=window.devicePixelRatio,b/=window.devicePixelRatio);return{width:a,height:b}}GetImageAsDataUrl(a,b){let c=this.GetImageSize();window.devicePixelRatio&&
(a/=window.devicePixelRatio,b/=window.devicePixelRatio);this.ResizeRenderer(a,b);this.Render();b=this.renderer.domElement.toDataURL();this.ResizeRenderer(c.width,c.height);return b}};OV.MeasureTool=class{constructor(){this.highlightColor=this.viewer=null;this.isActive=!1;this.markers=[]}Init(a,b){this.viewer=a;this.highlightColor=b}IsActive(){return this.isActive}SetActive(a){(this.isActive=a)||this.Clear()}Click(a){a=this.viewer.GetMeshIntersectionUnderMouse(a);null===a?this.Clear():(2===this.markers.length&&this.Clear(),this.AddMarker(a))}GetMarkerCount(){return this.markers.length}AddMarker(a){this.markers.push(a);this.GenerateMarker(a)}Calculate(){if(2!==this.markers.length)return null;
var a=this.markers[0];const b=this.markers[1];let c={pointsDistance:null,parallelFacesDistance:null,facesAngle:null};const d=this.GetFaceWorldNormal(a),e=this.GetFaceWorldNormal(b);c.pointsDistance=a.point.distanceTo(b.point);c.facesAngle=d.angleTo(e);if(OV.IsEqualEps(c.facesAngle,0,OV.BigEps)||OV.IsEqualEps(c.facesAngle,Math.PI,OV.BigEps))a=(new THREE.Plane).setFromNormalAndCoplanarPoint(d,a.point),c.parallelFacesDistance=Math.abs(a.distanceToPoint(b.point));return c}Clear(){this.viewer.ClearExtra();
this.markers=[]}GenerateMarker(a){var b=this.viewer.GetBoundingSphere(d=>!0).radius/5,c=new THREE.ConeGeometry(b/2,b,32);c.translate(0,-b/2,0);c.rotateX(-Math.PI/2);b=this.viewer.CreateHighlightMaterial(this.highlightColor);b.opacity=.6;b.transparent=!0;c=new THREE.Mesh(c,b);b=this.GetFaceWorldNormal(a);c.lookAt(b);c.position.set(a.point.x,a.point.y,a.point.z);this.viewer.AddExtraObject(c)}GetFaceWorldNormal(a){let b=new THREE.Matrix4;a.object.updateWorldMatrix(!0,!1);b.extractRotation(a.object.matrixWorld);
a=a.face.normal.clone();a.applyMatrix4(b);return a}};OV.EmbeddedViewer=class{constructor(a,b){this.parentElement=a;this.parameters={};OV.IsDefined(b)&&(this.parameters=b);this.canvas=document.createElement("canvas");this.parentElement.appendChild(this.canvas);this.viewer=new OV.Viewer;this.viewer.Init(this.canvas);this.viewer.Resize(this.parentElement.clientWidth,this.parentElement.clientHeight);this.parameters.backgroundColor&&this.viewer.SetBackgroundColor(this.parameters.backgroundColor);this.parameters.edgeSettings&&this.viewer.SetEdgeSettings(this.parameters.edgeSettings.showEdges,
this.parameters.edgeSettings.edgeColor,this.parameters.edgeSettings.edgeThreshold);this.parameters.environmentMap&&this.viewer.SetEnvironmentMap(this.parameters.environmentMap);window.addEventListener("resize",()=>{this.Resize()})}LoadModelFromUrls(a){this.viewer.Clear();if(null===a||0===a.length)return null;OV.TransformFileHostUrls(a);let b=new OV.ImportSettings;this.parameters.defaultColor&&(b.defaultColor=this.parameters.defaultColor);let c=null;(new OV.ThreeModelLoader).LoadModel(a,OV.FileSource.Url,
b,{onLoadStart:()=>{this.canvas.style.display="none";c=document.createElement("div");c.innerHTML="Loading model...";this.parentElement.appendChild(c)},onImportStart:()=>{c.innerHTML="Importing model..."},onVisualizationStart:()=>{c.innerHTML="Visualizing model..."},onModelFinished:(d,e)=>{this.parentElement.removeChild(c);this.canvas.style.display="inherit";this.viewer.SetMainObject(e);e=this.viewer.GetBoundingSphere(f=>!0);this.viewer.AdjustClippingPlanesToSphere(e);this.parameters.camera?this.viewer.SetCamera(this.parameters.camera):
this.viewer.SetUpVector(d.upVector,!1);this.viewer.FitSphereToWindow(e,!1)},onTextureLoaded:()=>{this.viewer.Render()},onLoadError:d=>{let e="Unknown error";d.code===OV.ImportErrorCode.NoImportableFile?e="No importable file found":d.code===OV.ImportErrorCode.FailedToLoadFile?e="Failed to load file for import.":d.code===OV.ImportErrorCode.ImportFailed&&(e="Failed to import model.");null!==d.message&&(e+=" ("+d.message+")");c.innerHTML=e}})}GetViewer(){return this.viewer}Resize(){this.viewer.Resize(this.parentElement.clientWidth,
this.parentElement.clientHeight)}};OV.Init3DViewerElement=function(a,b,c){a=new OV.EmbeddedViewer(a,c);a.LoadModelFromUrls(b);return a};
OV.Init3DViewerElements=function(a){let b=[];window.addEventListener("load",()=>{let c=document.getElementsByClassName("online_3d_viewer");for(let l=0;l<c.length;l++){var d=c[l];let m=null;var e=d.getAttribute("camera");e&&(m=OV.ParameterConverter.StringToCamera(e));e=null;var f=d.getAttribute("backgroundcolor");f&&(e=OV.ParameterConverter.StringToColor(f));f=null;var g=d.getAttribute("defaultcolor");g&&(f=OV.ParameterConverter.StringToColor(g));g=null;var h=d.getAttribute("edgesettings");h&&(g=OV.ParameterConverter.StringToEdgeSettings(h));
h=null;var k=d.getAttribute("environmentmap");k&&(k=k.split(","),6===k.length&&(h=k));k=null;let n=d.getAttribute("model");n&&(k=OV.ParameterConverter.StringToModelUrls(n));d=OV.Init3DViewerElement(d,k,{camera:m,backgroundColor:e,defaultColor:f,edgeSettings:g,environmentMap:h});b.push(d)}void 0!==a&&null!==a&&a(b)})};
